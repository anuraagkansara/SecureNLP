EquationDrug NNP O O
is VBZ O O
one CD B-Entity 1
of IN I-Entity O
the DT I-Entity O
main JJ I-Entity O
espionage NN I-Entity O
platforms NNS I-Entity O
used VBD B-Action 2
by IN O O
the DT B-Entity 3
Equation NNP I-Entity O
Group NNP I-Entity O
] -RRB- O O
, , O O
a DT O O
highly RB O O
sophisticated JJ O O
threat NN O O
actor NN O O
that WDT O O
has VBZ O O
been VBN O O
engaged VBN O O
in IN O O
multiple JJ O O
CNE NNP O O
( -LRB- O O
computer NN O O
network NN O O
exploitation NN O O
) -RRB- O O
operations NNS O O
dating VBG O O
back RB O O
to IN O O
2001 CD O O
, , O O
and CC O O
perhaps RB O O
as RB O O
early RB O O
as IN O O
1996 CD O O
. . O O

( -LRB- O O
See VB O O
full JJ O O
report NN O O
here RB O O
[ -LRB- O O
PDF][2 NN O O
] -RRB- O O
) -RRB- O O
. . O O

EquationDrug NNP O O
, , O O
which WDT O O
is VBZ O O
still RB O O
in IN O O
use NN O O
, , O O
dates VBZ O O
back RB O O
to IN O O
2003 CD O O
, , O O
although IN O O
the DT O O
more RBR O O
modern JJ O O
GrayFish NNP O O
platform NN O O
is VBZ O O
being VBG O O
pushed VBN O O
to IN O O
new JJ O O
victims NNS O O
. . O O

EquationDrug NNP B-Entity 1
represents VBZ B-Action 2
the DT O O
main JJ B-Entity 3
espionage NN I-Entity O
platform NN I-Entity O
from IN I-Entity O
the DT I-Entity O
# NN I-Entity O
EquationAPT NNP I-Entity O
Group NNP I-Entity O
Tweet[3 NNP O O
] -RRB- O O
It PRP O O
's VBZ O O
important JJ O O
to TO O O
note VB O O
that IN O O
EquationDrug NNP O O
is VBZ O O
not RB O O
just RB O O
a DT O O
Trojan NNP O O
, , O O
but CC O O
a DT O O
full JJ O O
espionage NN O O
platform NN O O
, , O O
which WDT O O
includes VBZ O O
a DT O O
framework NN O O
for IN O O
conducting VBG O O
cyberespionage NN O O
activities NNS O O
by IN O O
deploying VBG O O
specific JJ O O
modules NNS O O
on IN O O
the DT O O
machines NNS O O
of IN O O
selected VBN O O
victims NNS O O
. . O O

The DT O O
concept NN O O
of IN O O
a DT O O
cyberespionage NN O O
platform NN O O
is VBZ O O
neither CC O O
new JJ O O
nor CC O O
unique JJ O O
. . O O

Other JJ O O
threat NN O O
actors NNS O O
known VBN O O
to TO O O
use VB O O
such JJ O O
sophisticated JJ O O
platforms NNS O O
include VBP O O
Regin[4 NNP O O
] -RRB- O O
and CC O O
Epic NNP O O
Turla[5 NNP O O
] -RRB- O O
. . O O

The DT O O
EquationDrug NNP B-Entity 1
platform NN I-Entity O
can MD O O
be VB O O
extended VBN B-Action 2
through IN B-Modifier 3
plugins NNS O O
( -LRB- B-Entity 4
or CC I-Entity O
modules NNS I-Entity O
) -RRB- I-Entity O
. . O O

It PRP O O
is VBZ O O
pre NN O O
- HYPH O O
built VBN O O
with IN O O
a DT B-Entity 1
default NN I-Entity O
set NN I-Entity O
of IN I-Entity O
plugins NNS I-Entity O
supporting VBG B-Action 2
a DT O O
number NN B-Entity 3
of IN I-Entity O
basic JJ I-Entity O
cyberespionage NN I-Entity O
functions NNS I-Entity O
. . O O

These DT B-Entity 1
include VBP B-Action 2
common JJ O O
features NNS O O
such JJ O O
as IN O O
file NN B-Entity 3
collection NN I-Entity O
and CC O O
the DT B-Entity 4
making NN I-Entity O
of IN I-Entity O
screenshots NNS I-Entity O
. . O O

Sophistication NN O O
is VBZ O O
added VBN O O
by IN O O
storing VBG B-Action 1
stolen VBN O O
data NNS B-Entity 2
inside IN B-Modifier 3
a DT O O
custom NN B-Entity 4
- HYPH I-Entity O
encrypted VBN I-Entity O
virtual JJ I-Entity O
file NN I-Entity O
system NN I-Entity O
before IN O O
it PRP B-Entity 5
is VBZ O O
sent VBD B-Action 6
to IN B-Modifier 7
the DT O O
command NN B-Entity 8
and CC I-Entity O
control NN I-Entity O
servers NNS I-Entity O
. . O O

The DT O O
name NN O O
" `` O O
EquationDrug NNP O O
" '' O O
or CC O O
" `` O O
Equestre NNP O O
" '' O O
was VBD O O
assigned VBN O O
to IN O O
this DT O O
framework NN O O
by IN O O
Kaspersky NNP O O
Lab NNP O O
researchers NNS O O
. . O O

The DT O O
only JJ O O
reference NN O O
left VBN O O
by IN O O
the DT O O
framework NN O O
developers NNS O O
was VBD O O
a DT O O
short JJ O O
string NN O O
" `` O O
UR NNP O O
" '' O O
, , O O
as IN O O
seen VBN O O
in IN O O
several JJ O O
string NN O O
artifacts NNS O O
left VBN O O
in IN O O
the DT O O
binaries NNS O O
. . O O

The DT O O
EquationDrug NNP O O
platform NN O O
includes VBZ O O
dozens NNS O O
of IN O O
executables NNS O O
, , O O
configurations NNS O O
and CC O O
protected VBN O O
storage NN O O
locations NNS O O
. . O O

Putting VBG O O
all PDT O O
the DT O O
pieces NNS O O
of IN O O
this DT O O
puzzle NN O O
together RB O O
in IN O O
the DT O O
right JJ O O
order NN O O
may MD O O
take VB O O
time NN O O
for IN O O
those DT O O
who WP O O
are VBP O O
not RB O O
familiar JJ O O
with IN O O
the DT O O
platform NN O O
. . O O

The DT O O
platform NN O O
includes VBZ O O
executables NNS O O
, , O O
configurations NNS O O
and CC O O
protected VBN O O
storage NN O O
locations NNS O O
# . O O
EquationAPT NNP O O
Tweet[6 NNP O O
] -RRB- O O
The DT O O
architecture NN O O
of IN O O
the DT O O
whole JJ O O
framework NN O O
resembles VBZ O O
a DT O O
mini NN O O
- HYPH O O
operating VBG O O
system NN O O
with IN O O
kernel NN O O
- HYPH O O
mode NN O O
and CC O O
user NN O O
- HYPH O O
mode NN O O
components NNS O O
carefully RB O O
interacting VBG O O
with IN O O
each DT O O
other JJ O O
via IN O O
a DT O O
custom NN O O
message NN O O
- HYPH O O
passing VBG O O
interface NN O O
. . O O

The DT O O
platform NN O O
includes VBZ O O
a DT O O
set NN O O
of IN O O
drivers NNS O O
, , O O
a DT O O
platform NN O O
core NN O O
( -LRB- O O
orchestrator NN O O
) -RRB- O O
and CC O O
a DT O O
number NN O O
of IN O O
plugins NNS O O
. . O O

Every DT O O
plugin NN O O
has VBZ O O
a DT O O
unique JJ O O
ID NN O O
and CC O O
version NN O O
number NN O O
that WDT O O
defines VBZ O O
a DT O O
set NN O O
of IN O O
functions NNS O O
it PRP O O
can MD O O
provide VB O O
. . O O

Some DT O O
of IN O O
the DT O O
plugins NNS O O
depend VBP O O
on IN O O
others NNS O O
and CC O O
might MD O O
not RB O O
work VB O O
unless IN O O
dependencies NNS O O
are VBP O O
resolved VBN O O
. . O O

[ -LRB- O O
7 CD O O
] -RRB- O O
Similar JJ O O
to IN O O
popular JJ O O
OS NN O O
kernel NN O O
designs NNS O O
, , O O
such JJ O O
as IN O O
on IN O O
Unix NNP O O
- HYPH O O
based VBN O O
systems NNS O O
, , O O
some DT O O
of IN O O
the DT O O
essential JJ O O
modules NNS O O
are VBP O O
statically RB O O
linked VBN O O
to IN O O
the DT O O
platform NN O O
core NN O O
, , O O
while IN O O
others NNS O O
are VBP O O
loaded VBN O O
on IN O O
demand NN O O
. . O O

The DT O O
hypothesis NN O O
that WDT O O
these DT O O
attackers NNS O O
have VBP O O
been VBN O O
active JJ O O
since IN O O
the DT O O
90s NNS O O
seems VBZ O O
realistic JJ O O
# . O O
EquationAPT UH O O
Tweet[9 NN O O
] -RRB- O O
The DT O O
platform NN O O
is VBZ O O
started VBN O O
by IN O O
the DT O O
kernel NN O O
mode NN O O
driver NN O O
component NN O O
( -LRB- O O
" `` O O
msndsrv.sys JJ O O
" '' O O
on IN O O
Windows NNP O O
2000 CD O O
or CC O O
above RB O O
and CC O O
" `` O O
mssvc32.vxd JJ O O
" '' O O
on IN O O
Windows NNP O O
9x CD O O
) -RRB- O O
. . O O

The DT O O
driver NN O O
then RB O O
waits VBZ O O
for IN O O
the DT O O
system NN O O
to TO O O
start VB O O
and CC O O
initiates VBZ O O
execution NN O O
of IN O O
the DT O O
user NN O O
- HYPH O O
mode NN O O
loader NN O O
" '' O O
mscfg32.exe NN O O
" '' O O
. . O O

The DT O O
loader NN O O
then RB O O
starts VBZ O O
the DT O O
platform NN O O
's POS O O
central JJ O O
module NN O O
( -LRB- O O
an DT O O
orchestrator NN O O
) -RRB- O O
from IN O O
the DT O O
" `` O O
mscfg32.dll NN O O
" '' O O
module NN O O
. . O O

Additional JJ O O
drivers NNS O O
and CC O O
libraries NNS O O
may MD O O
be VB O O
loaded VBN O O
by IN O O
different JJ O O
components NNS O O
of IN O O
the DT O O
platform NN O O
, , O O
either CC O O
built VBN O O
- HYPH O O
in RP O O
or CC O O
auxiliary JJ O O
. . O O

The DT O O
EquationDrug NNP O O
platform NN O O
can MD O O
be VB O O
as RB O O
sophisticated JJ O O
as IN O O
a DT O O
space NN O O
station NN O O
, , O O
but CC O O
it PRP O O
appears VBZ O O
to TO O O
be VB O O
of IN O O
no DT O O
use NN O O
without IN O O
its PRP$ O O
cyberespionage NN O O
features NNS O O
. . O O

This DT O O
function NN O O
is VBZ O O
provided VBN O O
by IN O O
plugin NN O O
modules NNS O O
that WDT O O
are VBP O O
part NN O O
of IN O O
the DT O O
massive JJ O O
framework NN O O
described VBN O O
above RB O O
. . O O

We PRP O O
discovered VBD O O
dozens NNS O O
of IN O O
plugins NNS O O
and CC O O
each DT O O
is VBZ O O
a DT O O
sophisticated JJ O O
element NN O O
that WDT O O
can MD O O
communicate VB O O
with IN O O
the DT O O
core NN O O
and CC O O
become VB O O
aware JJ O O
of IN O O
the DT O O
availability NN O O
of IN O O
other JJ O O
plugins NNS O O
. . O O

The DT O O
plugins NNS O O
we PRP O O
discovered VBD O O
probably RB O O
represent VBP O O
just RB O O
a DT O O
fraction NN O O
of IN O O
the DT O O
attackers NNS O O
' POS O O
potential NN O O
. . O O

Each DT O O
plugin NN O O
is VBZ O O
assigned VBN O O
a DT O O
unique JJ O O
plugin NN O O
ID NN O O
number NN O O
( -LRB- O O
WORD NNP O O
) -RRB- O O
, , O O
such JJ O O
as IN O O
0x8000 NN O O
, , O O
0x8002 NFP O O
, , O O
0x8004 NFP O O
, , O O
0x8006 NFP O O
, , O O
etc FW O O
. . O O

All DT O O
plugin NN O O
IDs NNS O O
are VBP O O
even RB O O
numbers NNS O O
and CC O O
they PRP O O
all DT O O
start VBP O O
from IN O O
byte NN O O
0x80 CD O O
. . O O

The DT O O
biggest JJS O O
plugin NN O O
ID NN O O
we PRP O O
have VBP O O
seen VBN O O
is VBZ O O
0x80CA CD O O
. . O O

To IN O O
date NN O O
, , O O
we PRP O O
have VBP O O
found VBN O O
30 CD O O
unique JJ O O
plugin NN O O
IDs NNS O O
in IN O O
total NN O O
. . O O

Considering VBG O O
the DT O O
fact NN O O
that IN O O
the DT O O
developers NNS O O
assigned VBN O O
plugin RB O O
IDs NNS O O
incrementally RB O O
, , O O
and CC O O
assuming VBG O O
that IN O O
other JJ O O
plugin NN O O
IDs NNS O O
were VBD O O
assigned VBN O O
to IN O O
modules NNS O O
that WDT O O
we PRP O O
have VBP O O
not RB O O
yet RB O O
discovered VBN O O
, , O O
it PRP O O
's VBZ O O
not RB O O
hard JJ O O
to TO O O
calculate VB O O
that IN O O
86 CD O O
modules NNS O O
have VBP O O
yet RB O O
to TO O O
be VB O O
discovered VBN O O
. . O O

86 CD O O
modules NNS O O
have VBP O O
yet RB O O
to TO O O
be VB O O
discovered VBN O O
# -RRB- O O
EquationAPT NNP O O
Tweet[10 NNP O O
] -RRB- O O
The DT O O
most RBS O O
interesting JJ O O
modules NNS O O
we PRP O O
have VBP O O
seen VBN O O
contain VBP O O
the DT O O
following VBG O O
functionality NN O O
. . O O

During IN O O
our PRP$ O O
research NN O O
we PRP O O
paid VBD O O
attention NN O O
to IN O O
unique JJ O O
identifiers NNS O O
and CC O O
codenames NNS O O
used VBN O O
by IN O O
the DT O O
developers NNS O O
in IN O O
the DT O O
malware NN O O
. . O O

Most JJS O O
of IN B-Entity 1
this DT I-Entity O
information NN I-Entity O
is VBZ O O
carefully RB O O
protected VBD B-Action 2
with IN B-Modifier 3
obfuscation NN O O
or CC B-Entity 4
encryption NN I-Entity O
algorithms NNS I-Entity O
to TO O O
prevent VB O O
quick JJ O O
recognition NN O O
, , O O
but CC O O
anyone NN O O
who WP O O
breaks VBZ O O
through IN O O
this DT O O
layer NN O O
of IN O O
encryption NN O O
may MD O O
discover VB O O
some DT O O
interesting JJ O O
internal JJ O O
strings NNS O O
, , O O
as IN O O
demonstrated VBN O O
below IN O O
. . O O

[ -LRB- O O
11 CD O O
] -RRB- O O
Some DT O O
other JJ O O
interesting JJ O O
text NN O O
strings NNS O O
include VBP O O
. . O O

SkyhookChow NNP O O
Target NNP O O
SkyhookChow NNP O O
Payload NNP O O
Dissecorp NNP O O
Manual NNP O O
/ SYM O O
DRINKPARSLEY/2008 NNP O O
- HYPH O O
09 CD O O
- HYPH O O
30/10:06:46.468 CD O O
- HYPH O O
04:00 CD O O
VTT/82053737/STRAITACID/2008 NN O O
- HYPH O O
09 CD O O
- HYPH O O
03/10:44:56.361 CD O O
- HYPH O O
04:00 CD O O
VTT/82051410/LUTEUSOBSTOS/2008 NN O O
- HYPH O O
07 CD O O
- HYPH O O
30/17:27:23.715 CD O O
- HYPH O O
04:00 CD O O
STRAITSHOOTER30.ex NN O O
_ . O O
BACKSNARF_AB25 NNP O O
c:\users\rmgree5\co\standalonegrok_2.1.1.1\gk_driver\gk_sa_driver NN O O
â€¦ NN O O
To TO O O
install VB O O
: : O O
run VB O O
with IN O O
no DT O O
arguments NNS O O
Attempting VBG O O
to TO O O
drop VB O O
SFCriteria_Check NNP O O
failed VBD O O
! . O O
SFDriver NNP O O
Error NNP O O
detected VBD O O
! . O O
Uninstalling NNP O O
... . O O

Timeout NNP O O
waiting VBG O O
for IN O O
the DT O O
" `` O O
canInstallNow NNP O O
" '' O O
event NN O O
from IN O O
the DT O O
implant NN O O
- HYPH O O
specific JJ O O
EXE NNP O O
! . O O
Trying VBG O O
to TO O O
call VB O O
privilege NN O O
lib NN O O
... . O O

Hiding VBG O O
directory NN O O
Hiding VBG O O
plugin NN O O
... . O O

Merging VBG O O
plugin NN O O
... . O O

Merging VBG O O
old JJ O O
plugin NN O O
key NN O O
... . O O

Could MD O O
n't RB O O
reset VB O O
canInstallNowEvent NNP O O
! . O O
Performing VBG O O
UR NNP O O
- HYPH O O
specific JJ O O
pre NN O O
- HYPH O O
install NN O O
... . O O

Work VB O O
complete JJ O O
. . O O

Merged VBN O O
transport NN O O
manager NN O O
state NN O O
. . O O

! . O O
! . O O
SFConfig NN O O
! . O O
! . O O
Some DT O O
other JJ O O
names NNS O O
, , O O
such JJ O O
as IN O O
kernel NN O O
object NN O O
and CC O O
file NN O O
names NNS O O
, , O O
abbreviations NNS O O
, , O O
resource NN O O
code NN O O
page NN O O
and CC O O
several JJ O O
generic JJ O O
messages NNS O O
, , O O
point NN O O
to IN O O
English NNP O O
- HYPH O O
speaking VBG O O
developers NNS O O
. . O O

Due IN O O
to IN O O
the DT O O
limited JJ O O
number NN O O
of IN O O
such JJ O O
text NN O O
strings NNS O O
it PRP O O
's VBZ O O
hard JJ O O
to TO O O
tell VB O O
reliably RB O O
if IN O O
the DT O O
developers NNS O O
were VBD O O
native JJ O O
English JJ O O
speakers NNS O O
. . O O

Link NNP O O
Timestamp NNP O O
Analysis NNP O O
We PRP O O
have VBP O O
gathered VBN O O
a DT O O
reasonably RB O O
large JJ O O
number NN O O
of IN O O
executable JJ O O
samples NNS O O
to TO O O
which WDT O O
we PRP O O
have VBP O O
been VBN O O
able JJ O O
to TO O O
apply VB O O
link NN O O
timestamp NN O O
analysis NN O O
. . O O

A DT O O
link NN O O
timestamp NN O O
is VBZ O O
a DT O O
4-bytes CD O O
value NN O O
stored VBN O O
in IN O O
an DT O O
executable JJ O O
file NN O O
header NN O O
. . O O

This DT O O
value NN O O
is VBZ O O
automatically RB O O
set VBN O O
by IN O O
compiler NN O O
software NN O O
when WRB O O
a DT O O
developer NN O O
builds VBZ O O
a DT O O
new JJ O O
executable NN O O
. . O O

The DT O O
value NN O O
contains VBZ O O
a DT O O
detailed JJ O O
timestamp NN O O
including VBG O O
minutes NNS O O
and CC O O
even RB O O
seconds NNS O O
of IN O O
compilation NN O O
time NN O O
( -LRB- O O
think NN O O
of IN O O
it PRP O O
as IN O O
the DT O O
file NN O O
's POS O O
moment NN O O
of IN O O
birth NN O O
) -RRB- O O
. . O O

Link VB O O
timestamp JJ O O
analysis NN O O
require VBP O O
the DT O O
collection NN O O
of IN O O
the DT O O
timestamps NNS O O
of IN O O
all DT O O
available JJ O O
executables NNS O O
, , O O
grouping VBG O O
them PRP O O
according VBG O O
to IN O O
certain JJ O O
criteria NNS O O
, , O O
such JJ O O
as IN O O
the DT O O
hour NN O O
or CC O O
day NN O O
of IN O O
the DT O O
week NN O O
, , O O
and CC O O
putting VBG O O
them PRP O O
on IN O O
a DT O O
chart NN O O
. . O O

Below RB O O
are VBP O O
some DT O O
charts NNS O O
built VBN O O
using VBG O O
this DT O O
approach NN O O
. . O O

[ -LRB- O O
14 CD O O
] -RRB- O O
Can MD O O
we PRP O O
trust VB O O
this DT O O
information NN O O
? . O O
The DT O O
answer NN O O
is VBZ O O
: : O O
not RB O O
fully RB O O
, , O O
because IN O O
the DT O O
link NN O O
timestamp NN O O
can MD O O
be VB O O
altered VBN O O
by IN O O
the DT O O
developer NN O O
in IN O O
a DT O O
way NN O O
that WDT O O
's VBZ O O
not RB O O
always RB O O
possible JJ O O
to TO O O
spot VB O O
. . O O

However RB O O
, , O O
certain JJ O O
indicators NNS O O
such JJ O O
as IN O O
matching VBG O O
the DT O O
year NN O O
on IN O O
the DT O O
timestamp NN O O
with IN O O
the DT O O
support NN O O
of IN O O
technology NN O O
popular JJ O O
in IN O O
that DT O O
year NN O O
leads VBZ O O
us PRP O O
to TO O O
believe VB O O
that IN O O
the DT O O
timestamps NNS O O
were VBD O O
, , O O
at IN O O
the DT O O
very RB O O
least JJS O O
, , O O
not RB O O
wholly RB O O
replaced VBN O O
. . O O

Looking VBG O O
at IN O O
this DT O O
from IN O O
the DT O O
other JJ O O
side NN O O
, , O O
the DT O O
easiest JJS O O
option NN O O
for IN O O
the DT O O
developer NN O O
is VBZ O O
to TO O O
wipe VB O O
the DT O O
timestamp NN O O
completely RB O O
, , O O
replacing VBG O O
it PRP O O
with IN O O
zeroes NNS O O
. . O O

This DT O O
was VBD O O
not RB O O
found VBN O O
in IN O O
the DT O O
case NN O O
of IN O O
EquationDrug NNP O O
. . O O

In IN O O
fact NN O O
, , O O
the DT O O
timestamps NNS O O
look VB O O
very RB O O
realistic JJ O O
and CC O O
match VB O O
the DT O O
working VBG O O
days NNS O O
and CC O O
hours NNS O O
of IN O O
a DT O O
well RB O O
- HYPH O O
organized VBN O O
software NN O O
developer NN O O
from IN O O
timezone NN O O
UTC-3 NNP O O
or CC O O
UTC-4 NNP O O
, , O O
if IN O O
you PRP O O
assume VBP O O
that IN O O
they PRP O O
come VBP O O
to TO O O
work VB O O
at IN O O
8 CD O O
or CC O O
9 CD O O
am NN O O
. . O O

The DT O O
timestamps NNS O O
match VBP O O
the DT O O
working VBG O O
days NNS O O
of IN O O
software NN O O
developer NN O O
from IN O O
timezone NN O O
UTC-3 NNP O O
or CC O O
UTC-4 JJ O O
# NN O O
EquationAPT NNP O O
Tweet[17 NNP O O
] -RRB- O O
And CC O O
finally RB O O
, , O O
in IN O O
case NN O O
you PRP O O
are VBP O O
wondering VBG O O
if IN O O
the DT O O
developers NNS O O
work VBP O O
on IN O O
public JJ O O
holidays NNS O O
, , O O
you PRP O O
can MD O O
check VB O O
this DT O O
for IN O O
yourself PRP O O
against IN O O
the DT O O
full JJ O O
list NN O O
of IN O O
their PRP$ O O
working VBG O O
dates NNS O O
. . O O

EquationDrug NNP O O
represents VBZ O O
the DT O O
main JJ O O
espionage NN O O
platform NN O O
from IN O O
the DT O O
Equation NNP O O
Group NNP O O
. . O O

It PRP O O
's VBZ O O
been VBN O O
in IN O O
use NN O O
for IN O O
over IN O O
10 CD O O
years NNS O O
, , O O
replacing VBG O O
EquationLaser NNP O O
until IN O O
it PRP O O
was VBD O O
replaced VBN O O
itself PRP O O
by IN O O
the DT O O
even RB O O
more RBR O O
sophisticated JJ O O
GrayFish NNP O O
platform NN O O
. . O O

The DT O O
EquationDrug NNP O O
case NN O O
demonstrates VBZ O O
an DT O O
interesting JJ O O
trend NN O O
: : O O
a DT O O
growth NN O O
in IN O O
code NN O O
sophistication NN O O
# . O O
EquationAPT NNP O O
Tweet[18 NNP O O
] -RRB- O O
The DT O O
EquationDrug NNP O O
case NN O O
demonstrates VBZ O O
an DT O O
interesting JJ O O
trend NN O O
that IN O O
we PRP O O
have VBP O O
been VBN O O
seeing VBG O O
while IN O O
analyzing VBG O O
supposedly RB O O
nation NN O O
- HYPH O O
state NN O O
cyberattack NN O O
tools NNS O O
: : O O
a DT O O
growth NN O O
in IN O O
code NN O O
sophistication NN O O
. . O O

It PRP O O
is VBZ O O
clear JJ O O
that IN O O
nation NN O O
- HYPH O O
state NN O O
attackers NNS O O
are VBP O O
looking VBG O O
for IN O O
better JJR O O
stability NN O O
, , O O
invisibility NN O O
, , O O
reliability NN O O
and CC O O
universality NN O O
in IN O O
their PRP$ O O
cyberespionage NN O O
tools NNS O O
. . O O

You PRP O O
can MD O O
make VB O O
a DT O O
basic JJ O O
browser NN O O
password NN O O
- HYPH O O
stealer NN O O
or CC O O
a DT O O
sniffer NN O O
within IN O O
days NNS O O
. . O O

However RB O O
, , O O
nation NN O O
- HYPH O O
states NNS O O
are VBP O O
focused VBN O O
on IN O O
creating VBG O O
frameworks NNS O O
for IN O O
wrapping VBG O O
such JJ O O
code NN O O
into IN O O
something NN O O
that WDT O O
can MD O O
be VB O O
customized VBN O O
on IN O O
live JJ O O
systems NNS O O
and CC O O
provide VB O O
a DT O O
reliable JJ O O
way NN O O
to TO O O
store VB O O
all DT O O
components NNS O O
and CC O O
data NNS O O
in IN O O
encrypted VBN O O
form NN O O
, , O O
inaccessible JJ O O
to IN O O
normal JJ O O
users NNS O O
. . O O

While IN O O
traditional JJ O O
cybercriminals NNS O O
mass NN O O
- HYPH O O
distribute NN O O
emails NNS O O
with IN O O
malicious JJ O O
attachments NNS O O
or CC O O
infect VB O O
websites NNS O O
on IN O O
a DT O O
large JJ O O
scale NN O O
, , O O
nation NN O O
- HYPH O O
states NNS O O
create VBP O O
automatic JJ O O
systems NNS O O
infecting VBG O O
only RB O O
selected VBN O O
users NNS O O
. . O O

While IN O O
traditional JJ O O
cybercriminals NNS O O
typically RB O O
reuse VBP O O
one CD O O
malicious JJ O O
file NN O O
for IN O O
all DT O O
victims NNS O O
, , O O
nation NN O O
- HYPH O O
states NNS O O
prepare VBP O O
malware NN O O
unique JJ O O
to IN O O
each DT O O
victim NN O O
and CC O O
even RB O O
implement VB O O
restrictions NNS O O
preventing VBG O O
decryption NN O O
and CC O O
execution NN O O
outside IN O O
of IN O O
the DT O O
target NN O O
computer NN O O
. . O O

Nation NN O O
- HYPH O O
state NN O O
attackers NNS O O
create VBP O O
automatic JJ O O
systems NNS O O
infecting VBG O O
only RB O O
selected VBN O O
users NNS O O
# -RRB- O O
EquationAPT NNP O O
Tweet[19 NNP O O
] -RRB- O O
Sophistication NNP O O
of IN O O
the DT O O
framework NN O O
is VBZ O O
what WP O O
makes VBZ O O
this DT O O
type NN O O
of IN O O
actor NN O O
different JJ O O
from IN O O
traditional JJ O O
cybercriminals NNS O O
, , O O
who WP O O
prefer VBP O O
to TO O O
focus VB O O
on IN O O
payload NN O O
and CC O O
malware NN O O
capabilities NNS O O
such JJ O O
as IN O O
implementing VBG O O
a DT O O
long JJ O O
list NN O O
of IN O O
custom NN O O
third JJ O O
- HYPH O O
party NN O O
software NN O O
credential NN O O
database NN O O
parsers NNS O O
. . O O

The DT O O
difference NN O O
in IN O O
tactics NNS O O
between IN O O
cybercriminals NNS O O
and CC O O
nation NN O O
- HYPH O O
state NN O O
attackers NNS O O
appears VBZ O O
to TO O O
be VB O O
due JJ O O
to IN O O
relative JJ O O
resource NN O O
availability NN O O
. . O O

It PRP O O
's VBZ O O
known VBN O O
that IN O O
cybercriminals NNS O O
attempt NN O O
to TO O O
infect VB O O
as IN O O
many JJ O O
users NNS O O
as IN O O
possible JJ O O
and CC O O
that IN O O
they PRP O O
can MD O O
sometimes RB O O
compromise VB O O
hundreds NNS O O
of IN O O
thousands NNS O O
of IN O O
systems NNS O O
. . O O

It PRP O O
would MD O O
will MD O O
take VB O O
many JJ O O
years NNS O O
to TO O O
check VB O O
all PDT O O
those DT O O
machines NNS O O
manually RB O O
, , O O
analyzing VBG O O
who WP O O
owns VBZ O O
them PRP O O
, , O O
what WP O O
data NN O O
is VBZ O O
stored VBN O O
on IN O O
them PRP O O
, , O O
and CC O O
what WP O O
custom NN O O
software NN O O
they PRP O O
run VBP O O
. . O O

Cybercriminals NNS O O
probably RB O O
do VBP O O
n't RB O O
even RB O O
have VB O O
enough JJ O O
disk NN O O
space NN O O
to TO O O
collect VB O O
all PDT O O
the DT O O
potentially RB O O
interesting JJ O O
data NNS O O
from IN O O
the DT O O
victims NNS O O
hit VBN O O
by IN O O
their PRP$ O O
large JJ O O
scale NN O O
infections NNS O O
. . O O

That DT O O
is VBZ O O
why WRB O O
cybercriminals NNS O O
prefer VBP O O
to TO O O
extract VB O O
tiny JJ O O
chunks NNS O O
of IN O O
the DT O O
most RBS O O
important JJ O O
data NNS O O
( -LRB- O O
credentials NNS O O
, , O O
credit NN O O
card NN O O
numbers NNS O O
, , O O
etc FW O O
) -RRB- O O
on IN O O
the DT O O
machine NN O O
of IN O O
the DT O O
victim NN O O
and CC O O
transfer NN O O
only RB O O
few JJ O O
kilobytes NNS O O
from IN O O
each DT O O
compromised VBN O O
host NN O O
. . O O

Such JJ O O
data NNS O O
, , O O
when WRB O O
combined VBN O O
from IN O O
all DT O O
users NNS O O
, , O O
normally RB O O
takes VBZ O O
up RP O O
gigabytes NNS O O
of IN O O
disk NN O O
space NN O O
. . O O

Nation NN O O
- HYPH O O
state NN O O
attackers NNS O O
have VBP O O
sufficient JJ O O
resources NNS O O
to TO O O
store VB O O
as RB O O
much JJ O O
data NNS O O
as IN O O
they PRP O O
want VBP O O
. . O O

They PRP O O
have VBP O O
access NN O O
to IN O O
virtually RB O O
unlimited JJ O O
data NNS O O
storage NN O O
. . O O

However RB O O
, , O O
they PRP O O
do VBP O O
n't RB O O
need VB O O
, , O O
and CC O O
often RB O O
try VBP O O
to TO O O
avoid VB O O
, , O O
infecting VBG O O
random JJ O O
users NNS O O
, , O O
for IN O O
the DT O O
obvious JJ O O
reason NN O O
of IN O O
avoiding VBG O O
attention NN O O
and CC O O
remaining VBG O O
invisible JJ O O
. . O O

Implementing VBG O O
custom NN O O
data NNS O O
format NN O O
parsers NNS O O
in IN O O
the DT O O
malware NN O O
not RB O O
only RB O O
does VBZ O O
n't RB O O
help VB O O
them PRP O O
find VB O O
all PDT O O
the DT O O
valuable JJ O O
data NNS O O
on IN O O
the DT O O
victim NN O O
's POS O O
machine NN O O
, , O O
but CC O O
may MD O O
also RB O O
attract VB O O
extra JJ O O
attention NN O O
from IN O O
security NN O O
software NN O O
running VBG O O
on IN O O
the DT O O
system NN O O
. . O O

They PRP O O
mostly RB O O
prefer VBP O O
to TO O O
have VB O O
a DT O O
generic JJ O O
remote JJ O O
system NN O O
management NN O O
tool NN O O
that WDT O O
can MD O O
copy VB O O
any DT O O
information NN O O
they PRP O O
might MD O O
need VB O O
even RB O O
if IN O O
it PRP O O
causes VBZ O O
some DT O O
redundancy NN O O
. . O O

However RB O O
, , O O
copying VBG O O
large JJ O O
volumes NNS O O
of IN O O
information NN O O
might MD O O
slow VB O O
down RP O O
network NN O O
connection NN O O
and CC O O
attract VB O O
attention NN O O
, , O O
especially RB O O
in IN O O
some DT O O
countries NNS O O
with IN O O
poorly RB O O
developed VBN O O
internet NN O O
infrastructure NN O O
. . O O

To IN O O
date NN O O
, , O O
nation NN O O
- HYPH O O
state NN O O
attackers NNS O O
have VBP O O
had VBN O O
to TO O O
balance VB O O
between IN O O
these DT O O
two CD O O
poles NNS O O
: : O O
copying VBG O O
victims NNS O O
' POS O O
entire JJ O O
hard JJ O O
drives NNS O O
while IN O O
stealing VBG O O
only RB O O
tiny JJ O O
bits NNS O O
of IN O O
passwords NNS O O
and CC O O
keys NNS O O
. . O O

Nation NN O O
- HYPH O O
state NN O O
attackers NNS O O
use VBP O O
a DT O O
remote JJ O O
system NN O O
management NN O O
tool NN O O
that WDT O O
can MD O O
copy VB O O
any DT O O
information NN O O
they PRP O O
need VBP O O
# NFP O O
EquationAPT NNP O O
Tweet[20 NNP O O
] -RRB- O O
Now RB O O
, , O O
if IN O O
you PRP O O
wonder VBP O O
why WRB O O
EquationDrug NNP O O
, , O O
a DT O O
powerful JJ O O
cyberespionage NN O O
platform NN O O
, , O O
does VBZ O O
n't RB O O
provide VB O O
all DT O O
stealing VBG O O
capability NN O O
as IN O O
standard NN O O
in IN O O
its PRP$ O O
malware NN O O
core NN O O
, , O O
the DT O O
answer NN O O
is VBZ O O
that IN O O
they PRP O O
prefer VBP O O
to TO O O
customize VB O O
the DT O O
attack NN O O
for IN O O
each DT O O
one CD O O
of IN O O
their PRP$ O O
victims NNS O O
. . O O

Only RB O O
if IN O O
they PRP O O
have VBP O O
chosen VBN O O
to TO O O
actively RB O O
monitor VB O O
you PRP O O
and CC O O
the DT O O
security NN O O
products NNS O O
on IN O O
your PRP$ O O
machines NNS O O
have VBP O O
been VBN O O
disarmed VBN O O
, , O O
will MD O O
you PRP O O
receive VB O O
a DT O O
plugin NN O O
for IN O O
the DT O O
live JJ O O
tracking NN O O
of IN O O
your PRP$ O O
conversations NNS O O
or CC O O
other JJ O O
specific JJ O O
functions NNS O O
related VBN O O
to IN O O
your PRP$ O O
activities NNS O O
. . O O

We PRP O O
believe VBP O O
modularity NN O O
and CC O O
customization NN O O
will MD O O
become VB O O
a DT O O
unique JJ O O
trademark NN O O
of IN O O
nation NN O O
- HYPH O O
state NN O O
attackers NNS O O
in IN O O
the DT O O
future NN O O
. . O O

Some DT O O
code NN B-Entity 1
paths NNS I-Entity O
in IN I-Entity O
EquationDrug NNP I-Entity O
modules NNS I-Entity O
lead NN O O
to IN B-Action 2
OS NNP O O
version NN B-Entity 3
checks NNS I-Entity O
including VBG O O
a DT O O
test NN O O
for IN O O
Windows NNP O O
95 CD O O
, , O O
which WDT O O
is VBZ O O
accepted VBN O O
as IN O O
one CD O O
of IN O O
supported VBN O O
platforms NNS O O
. . O O

While IN O O
some DT O O
other JJ O O
checks NNS O O
will MD O O
not RB O O
pass VB O O
on IN O O
Windows NNP O O
95 CD O O
, , O O
the DT O O
presence NN O O
of IN O O
this DT O O
code NN O O
means VBZ O O
that IN O O
this DT O O
OS NN O O
was VBD O O
supported VBN O O
in IN O O
some DT O O
earlier JJR O O
variants NNS O O
of IN O O
the DT O O
malware NN O O
. . O O

Considering VBG O O
this DT O O
and CC O O
the DT O O
existence NN O O
of IN O O
components NNS O O
designed VBN O O
to TO O O
run VB O O
on IN O O
Windows NNP O O
9x CD O O
( -LRB- O O
such JJ O O
as IN O O
VXD NNP O O
- HYPH O O
files NNS O O
) -RRB- O O
, , O O
as RB O O
well RB O O
as IN O O
compilation NN O O
timestamps NNS O O
dating VBG O O
back RB O O
to IN O O
early JJ O O
2000s CD O O
, , O O
the DT O O
hypothesis NN O O
that IN O O
these DT O O
attackers NNS O O
have VBP O O
been VBN O O
active JJ O O
since IN O O
the DT O O
90s NNS O O
seems VBZ O O
realistic JJ O O
. . O O

This DT O O
makes VBZ O O
the DT O O
current JJ O O
attacker NN O O
an DT O O
outstanding JJ O O
actor NN O O
operating VBG O O
longer RBR O O
than IN O O
any DT O O
other JJ O O
in IN O O
the DT O O
field NN O O
. . O O

Kernel NNP O O
mode NN O O
stage NN O O
0 CD O O
( -LRB- O O
Windows NNP O O
9x CD O O
) -RRB- O O
- . O O
mssvc32.vxd NN O O
MD5 NNP O O
0a5e9b15014733ee7685d8c8be81fb0d NNP O O
Size NNP O O
6 CD O O
710 CD O O
bytes NNS O O
Format NNP O O
Linear NNP O O
Executable NNP O O
( -LRB- O O
LE NNP O O
) -RRB- O O
This DT O O
VXD NN O O
driver NN O O
handles VBZ O O
only RB O O
two CD O O
control NN O O
messages NNS O O
: : O O
W32_DeviceIoControl NN O O
and CC O O
Dynamic_Init NN O O
. . O O

The DT O O
DeviceIoControl NNP O O
part NN O O
is VBZ O O
not RB O O
completely RB O O
implemented VBN O O
and CC O O
the DT O O
driver NN O O
is VBZ O O
only RB O O
able JJ O O
to TO O O
check VB O O
for IN O O
some DT O O
known JJ O O
control NN O O
codes NNS O O
. . O O

However WRB O O
it PRP O O
does VBZ O O
nothing NN O O
. . O O

This DT O O
handler NN O O
looks VBZ O O
more JJR O O
like IN O O
a DT O O
code NN O O
stub NN O O
rather RB O O
than IN O O
actual JJ O O
payload NN O O
. . O O

On IN O O
the DT O O
Dynamic_Init NNP O O
event NN O O
, , O O
the DT O O
driver NN O O
retrieves VBZ O O
the DT O O
location NN O O
of IN O O
the DT O O
user NN O O
- HYPH O O
mode NN O O
loader NN O O
executable NN O O
from IN O O
the DT O O
following VBG O O
registry NN O O
value NN O O
. . O O

[ -LRB- O O
HKLM\SYSTEM\CurrentControlSet\Control\Session NNP O O
Manager\MemSubSys NNP O O
] -RRB- O O
Config NNP O O
If IN O O
the DT O O
value NN O O
is VBZ O O
not RB O O
present JJ O O
in IN O O
the DT O O
registry NN O O
, , O O
it PRP O O
uses VBZ O O
the DT O O
following VBG O O
fallback JJ O O
string NN O O
hardcoded VBN O O
in IN O O
the DT O O
binary NN O O
. . O O

C:\WINDOWS\SYSTEM\SVCHOST32.EXE NN O O
Next RB O O
, , O O
it PRP O O
installs VBZ O O
a DT O O
callback NN O O
procedure NN O O
using VBG O O
Windows NNP O O
function NN O O
_ SYM O O
SHELL_CallAtAppyTime NN O O
. . O O

This DT O O
procedure NN O O
will MD O O
be VB O O
called VBN O O
when WRB O O
CPU NNP O O
is VBZ O O
running VBG O O
in IN O O
ring-3 JJ O O
mode NN O O
, , O O
so IN O O
that IN O O
a DT B-Entity 1
new JJ I-Entity O
executable JJ I-Entity O
( -LRB- O O
loader NN O O
process NN O O
) -RRB- O O
can MD O O
be VB O O
started VBD B-Action 2
via IN B-Modifier 3
the DT O O
traditional JJ B-Entity 4
way NN I-Entity O
. . O O

This DT O O
is VBZ O O
a DT O O
standard JJ O O
trick NN O O
that WDT O O
was VBD O O
used VBN O O
by IN O O
developers NNS O O
in IN O O
the DT O O
90s NNS O O
to TO O O
initiate VB O O
a DT O O
call NN O O
to IN O O
DLL NNP O O
export NN O O
in IN O O
ring-3 NN O O
from IN O O
ring-0 NN O O
in IN O O
Windows NNP O O
9x CD O O
OS NNP O O
family NN O O
. . O O

Kernel NNP O O
mode NN O O
stage NN O O
0 CD O O
and CC O O
rootkit NN O O
( -LRB- O O
Windows NNP O O
2000 CD O O
and CC O O
above RB O O
) -RRB- O O
- . O O
msndsrv.sys NN O O
MD5 NNP O O
c4f8671c1f00dab30f5f88d684af1927 NN O O
Size NNP O O
105 CD O O
392 CD O O
bytes NNS O O
Format NNP O O
PE32 NNP O O
Native NNP O O
Compiled VBN O O
2008.01.23 CD O O
14:12:33 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
Location NN O O
% NN O O
System32%\drivers\msndsrv.sys JJ O O
This DT B-Entity 1
module NN I-Entity O
can MD O O
create VB B-Action 2
log NN O O
files NNS B-Entity 3
in IN B-Modifier 4
the DT O O
following VBG B-Entity 5
known JJ I-Entity O
locations NNS I-Entity O
. . O O

% NN O O
systemroot%\system32\mslog32.dat NN O O
% NN O O
systemroot%\system32\msperf32.dat NN O O
( -LRB- O O
default NN O O
location NN O O
) -RRB- O O
The DT O O
driver NN O O
acts VBZ O O
as IN O O
the DT O O
first JJ O O
stage NN O O
of IN O O
the DT O O
EquationDrug NNP O O
platform NN O O
on IN O O
Windows NNP O O
2000 CD O O
+ XX O O
and CC O O
implements VBZ O O
rootkit JJ O O
functions NNS O O
for IN O O
hiding VBG O O
the DT O O
components NNS O O
of IN O O
the DT O O
platform NN O O
. . O O

Additionally RB O O
, , O O
it PRP O O
implements VBZ O O
a DT O O
NDIS NNP O O
driver NN O O
for IN O O
filtering VBG O O
network NN O O
traffic NN O O
. . O O

When WRB O O
started VBN O O
and CC O O
initialized VBN O O
, , O O
the DT O O
driver NN O O
retrieves VBZ O O
the DT O O
location NN O O
of IN O O
the DT O O
user NN O O
- HYPH O O
mode NN O O
loader NN O O
executable NN O O
from IN O O
the DT O O
registry NN O O
value NN O O
. . O O

[ -LRB- O O
HKLM\System\CurrentControlSet\Services\%driver NNP O O
name% NNP O O
] -RRB- O O
Config NNP O O
The DT O O
% NN O O
driver NN O O
name% CC O O
is VBZ O O
not RB O O
hardcoded VBN O O
and CC O O
is VBZ O O
obtained VBN O O
dynamically RB O O
from IN O O
the DT O O
current JJ O O
module NN O O
name NN O O
, , O O
which WDT O O
means VBZ O O
that IN O O
different JJ O O
instances NNS O O
may MD O O
check VB O O
different JJ O O
registry NN O O
keys NNS O O
and CC O O
this DT O O
may MD O O
not RB O O
be VB O O
a DT O O
reliable JJ O O
way NN O O
to TO O O
check VB O O
for IN O O
infection NN O O
. . O O

The DT O O
sample NN O O
we PRP O O
analyzed VBD O O
used JJ O O
" `` O O
msndsrv NN O O
" '' O O
as IN O O
the DT O O
% NN O O
driver NN O O
name% '' O O
. . O O

Next RB O O
, , O O
it PRP O O
crafts NN O O
and CC O O
injects VBZ O O
a DT O O
shellcode NN O O
in IN O O
" `` O O
services.exe NN O O
" '' O O
or CC O O
" `` O O
winlogon.exe SYM O O
" '' O O
. . O O

The DT O O
shellcode NN O O
is VBZ O O
designed VBN O O
to TO O O
spawn VB O O
the DT O O
loader NN O O
process NN O O
from IN O O
the DT O O
executable NN O O
called VBN O O
" `` O O
mscfg32.exe NN O O
" '' O O
. . O O

The DT O O
rootkit NN O O
code NN O O
in IN O O
the DT O O
driver NN O O
hooks VBZ O O
several JJ O O
Native JJ O O
API NN O O
functions NNS O O
that WDT O O
lets VBZ O O
it PRP O O
hide VB B-Action 1
or CC O O
protect VB B-Action 2
registry NN O O
keys NNS B-Entity 3
, , O O
files VBZ B-Entity 4
and CC O O
running VBG B-Entity 5
processes VBZ I-Entity O
. . O O

The DT O O
components NNS O O
of IN O O
EquationDrug NNP O O
can MD O O
modify VB O O
the DT O O
list NN O O
of IN O O
protected VBN O O
objects NNS O O
by IN O O
sending VBG O O
DeviceIoControl NNP O O
messages NNS O O
to IN O O
the DT O O
driver NN O O
. . O O

The DT O O
driver NN B-Entity 1
also RB O O
maintains VBZ B-Action 2
a DT O O
persistent JJ B-Entity 3
list NN I-Entity O
of IN I-Entity O
protected VBN I-Entity O
objects NNS I-Entity O
that WDT I-Entity O
is VBZ I-Entity O
stored VBN I-Entity O
in IN I-Entity O
the DT I-Entity O
following VBG I-Entity O
registry NN I-Entity O
values NNS I-Entity O
. . O O

[ -LRB- O O
HKLM\System\CurrentControlSet\Services\%driver NNP O O
name% NNP O O
] -RRB- O O
1 CD O O
[ -LRB- O O
HKLM\System\CurrentControlSet\Services\%driver NNP O O
name% NNP O O
] -RRB- O O
2 CD O O
These DT O O
values NNS O O
are VBP O O
also RB O O
protected VBN O O
by IN O O
the DT O O
rootkit NN O O
. . O O

They PRP O O
can MD O O
be VB O O
revealed VBN O O
by IN O O
booting VBG O O
Windows NNP O O
in IN O O
Safe NNP O O
Mode NNP O O
. . O O

The DT O O
driver NN O O
contains VBZ O O
the DT O O
following VBG O O
unused JJ O O
strings NNS O O
. . O O

\\.\mailslot\dskInfo NN O O
Dissecorp NNP O O
User NNP O O
- HYPH O O
mode NN O O
loader NN O O
- HYPH O O
mscfg32.exe NN O O
, , O O
svchost32.exe XX O O
MD5 NNP O O
c3af66b9ce29efe5ee34e87b6e136e3a XX O O
Size VB O O
22 CD O O
016 CD O O
bytes NNS O O
Format NNP O O
PE32 NNP O O
EXE NNP O O
Compiled VBD O O
2008.01.23 CD O O
14:26:05 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
Location NN O O
% NN O O
System32%\mscfg32.exe , O O
This DT O O
module NN O O
opens VBZ O O
a DT O O
unique JJ O O
event NN O O
named VBN O O
" `` O O
D0385CB7-B834 NNP O O
- HYPH O O
45d1-A501 NNP O O
- HYPH O O
1A1700E6C34E NNP O O
" '' O O
. . O O

If IN O O
the DT O O
event NN O O
exists VBZ O O
, , O O
it PRP O O
waits VBZ O O
for IN O O
10 CD O O
seconds NNS O O
and CC O O
attempts NNS O O
to TO O O
open VB O O
a DT O O
file NN O O
whose WP$ O O
name NN O O
can MD O O
be VB O O
decrypted VBN O O
as IN O O
" `` O O
\\.\MSNDSRV NN O O
" '' O O
. . O O

If IN O O
the DT O O
device NN O O
file NN O O
is VBZ O O
successfully RB O O
opened VBN O O
, , O O
the DT O O
code NN O O
issues VBZ O O
a DT O O
device NN O O
request NN O O
with IN O O
IOCTL NNP O O
code NN O O
0x80000194 NN O O
and CC O O
no DT O O
parameters NNS O O
. . O O

This DT O O
module NN O O
uses VBZ O O
RC5 NNP O O
in IN O O
CBC NNP O O
- HYPH O O
like JJ O O
mode NN O O
with IN O O
a DT O O
key JJ O O
length NN O O
of IN O O
96-bit CD O O
for IN O O
string NN O O
encryption NN O O
. . O O

Careful JJ O O
analysis NN O O
reveals VBZ O O
some DT O O
bits NNS O O
of IN O O
uninitialized JJ O O
memory NN O O
found VBD O O
next JJ O O
to IN O O
encryption NN O O
key NN O O
locations NNS O O
. . O O

This DT O O
is VBZ O O
unused JJ O O
but CC O O
partly RB O O
meaningful JJ O O
memory NN O O
, , O O
because IN O O
it PRP O O
seems VBZ O O
to TO O O
contain VB O O
short JJ O O
chunks NNS O O
of IN O O
strings NNS O O
resembling VBG O O
some DT O O
local JJ O O
filepaths NNS O O
: : O O
" `` O O
rver\8 NN O O
" '' O O
( -LRB- O O
probably RB O O
part NN O O
of IN O O
" `` O O
Server\8 NNP O O
... : O O
" `` O O
string NN O O
) -RRB- O O
" `` O O
LInj NNP O O
" '' O O
( -LRB- O O
could MD O O
be VB O O
a DT O O
part NN O O
of IN O O
" `` O O
DLLInjector NNP O O
" '' O O
or CC O O
similar JJ O O
) -RRB- O O
It PRP O O
's VBZ O O
apparent JJ O O
that IN O O
some DT O O
parts NNS O O
of IN O O
the DT O O
code NN O O
were VBD O O
designed VBN O O
to TO O O
run VB O O
on IN O O
Windows NNP O O
9x CD O O
, , O O
for IN O O
example NN O O
a DT O O
call NN O O
to TO O O
RegisterServiceProcess VB O O
Windows NNP O O
API NNP O O
function NN O O
makes VBZ O O
sense NN O O
only RB O O
on IN O O
Windows NNP O O
9x CD O O
OS NNP O O
family NN O O
, , O O
because IN O O
this DT O O
API NN O O
function NN O O
does VBZ O O
n't RB O O
exist VB O O
on IN O O
Windows NNP O O
NT NNP O O
platform NN O O
. . O O

The DT O O
module NN B-Entity 1
uses VBZ O O
a DT O O
unique JJ O O
algorithm NN O O
for IN O O
generating VBG B-Action 2
registry NN O O
value NN B-Entity 3
names NNS I-Entity O
. . O O

The DT O O
code NN O O
contains VBZ O O
strings NNS O O
, , O O
such JJ O O
as IN O O
" `` O O
SkyhookChow NNP O O
Target NNP O O
" '' O O
, , O O
that WDT O O
are VBP O O
converted VBN O O
to IN O O
GUID NNP O O
- HYPH O O
like JJ O O
strings NNS O O
by IN O O
calculating VBG O O
SHA1 NNP O O
hash NN O O
and CC O O
using VBG O O
its PRP$ O O
hexadecimal JJ O O
representation NN O O
as IN O O
a DT O O
string NN O O
. . O O

The DT O O
resulting VBG O O
strings NNS O O
are VBP O O
used VBN O O
as IN O O
actual JJ O O
registry NN O O
value NN O O
names NNS O O
in IN O O
[ -LRB- O O
HKLM\SYSTEM\CurrentControlSet\Control\Session NNP O O
Manager\MemSubSys NNP O O
] -RRB- O O
registry NN O O
key NN O O
. . O O

Sample JJ O O
registry NN O O
value NN O O
names NNS O O
. . O O

Original JJ O O
String NNP O O
GUID NNP O O
- HYPH O O
like JJ O O
registry NN O O
value NN O O
name NN O O
SkyhookChow NNP O O
Target NNP O O
{ -LRB- O O
B6F5CD13-A74D-8B82-A6AA-6FA1BE2484C1 NNP O O
- HYPH O O
6832DF06 NNP O O
} -RRB- O O
SkyhookChow NNP O O
Payload NNP O O
{ -LRB- O O
F4CF0326 NNP O O
- HYPH O O
6DCD NNP O O
- HYPH O O
EEC8 NNP O O
- HYPH O O
5323 CD O O
- HYPH O O
01CEDB66741A CD O O
- HYPH O O
B55F6F12 NN O O
} -RRB- O O
These DT O O
registry NN O O
values NNS O O
are VBP O O
encrypted VBN O O
using VBG O O
an DT O O
RC5 NN O O
algorithm NN O O
using VBG O O
a DT O O
hardcoded JJ O O
1024-bit CD O O
key JJ O O
with IN O O
24 CD O O
rounds NNS O O
. . O O

The DT O O
registry NN O O
value NN O O
. . O O

[ -LRB- O O
HKLM\SYSTEM\CurrentControlSet\Control\Session NNP O O
Manager\MemSubSys NNP O O
] -RRB- O O
{ -LRB- O O
F4CF0326 NNP O O
- HYPH O O
6DCD- NNP O O
EEC8 NNP O O
- HYPH O O
5323 CD O O
- HYPH O O
01CEDB66741A CD O O
- HYPH O O
B55F6F12 NN O O
} -RRB- O O
( -LRB- O O
" `` O O
SkyhookChow NNP O O
Payload NNP O O
" '' O O
) -RRB- O O
should MD O O
contain VB O O
the DT O O
location NN O O
of IN O O
the DT O O
orchestrator NN O O
DLL NNP O O
file NN O O
( -LRB- O O
" `` O O
mscfg32.dll JJ O O
" '' O O
) -RRB- O O
. . O O

If IN O O
the DT O O
value NN O O
is VBZ O O
not RB O O
present VB O O
a DT O O
default NN O O
value NN O O
" '' O O
% NN O O
SYSTEM%\mscfg32.dll NNP O O
" '' O O
is VBZ O O
used VBN O O
. . O O

The DT O O
registry NN O O
value NN O O
. . O O

[ -LRB- O O
HKLM\SYSTEM\CurrentControlSet\Control\Session NNP O O
Manager\MemSubSys NNP O O
] -RRB- O O
{ -LRB- O O
B6F5CD13-A74D-8B82- NNP O O
A6AA-6FA1BE2484C1 NNP O O
- HYPH O O
6832DF06 NNP O O
} -RRB- O O
( -LRB- O O
" `` O O
SkyhookChow NNP O O
Target NNP O O
" '' O O
) -RRB- O O
may MD O O
contain VB O O
the DT O O
location NN O O
of IN O O
the DT O O
executable JJ O O
file NN O O
that WDT O O
will MD O O
be VB O O
used VBN O O
as IN O O
a DT O O
" `` O O
shell NN O O
" '' O O
process NN O O
for IN O O
the DT O O
orchestrator NN O O
library NN O O
. . O O

The DT O O
module NN B-Entity 1
attempts VBZ O O
to TO O O
start VB B-Action 2
the DT O O
" `` B-Entity 3
shell NN I-Entity O
" '' I-Entity O
process NN I-Entity O
in IN B-Modifier 4
suspended VBD O O
mode NN B-Entity 5
. . O O

If IN O O
there EX O O
is VBZ O O
no DT O O
" `` O O
SkyhookChow NNP O O
Target NNP O O
" '' O O
value NN O O
or CC O O
the DT O O
specified VBN O O
executable NN O O
fails VBZ O O
to TO O O
start VB O O
, , O O
the DT O O
module NN O O
tries VBZ O O
different JJ O O
failsafe NN O O
locations NNS O O
of IN O O
the DT O O
programs NNS O O
that WDT O O
can MD O O
be VB O O
used VBN O O
instead RB O O
. . O O

Next RB O O
, , O O
the DT B-Entity 1
module NN I-Entity O
injects VBZ B-Action 2
extra JJ O O
code NN B-Entity 3
into IN B-Modifier 4
a DT O O
newly RB B-Entity 5
started VBN I-Entity O
target NN I-Entity O
process NN I-Entity O
. . O O

The DT O O
injected VBN B-Entity 1
code NN I-Entity O
loads NNS B-Action 2
the DT O O
payload NN B-Entity 3
DLL NNP I-Entity O
( -LRB- I-Entity O
" `` I-Entity O
mscfg32.dll JJ I-Entity O
" '' I-Entity O
) -RRB- I-Entity O
into IN B-Modifier 4
the DT O O
target NN B-Entity 5
process NN I-Entity O
and CC O O
waits VBZ O O
for IN O O
the DT O O
parent NN O O
process NN O O
to IN O O
exit NN O O
. . O O

When WRB O O
the DT O O
parent NN O O
process NN O O
quits VBZ O O
, , O O
it PRP O O
unloads VBZ O O
the DT O O
payload NN O O
DLL NNP O O
and CC O O
exits NNS O O
as RB O O
well RB O O
. . O O

The DT O O
rest NN O O
of IN O O
the DT O O
logic NN O O
relies VBZ O O
on IN O O
the DT O O
loaded JJ O O
DLL NNP O O
in IN O O
that DT O O
new JJ O O
process NN O O
. . O O

See VB O O
the DT O O
description NN O O
of IN O O
the DT O O
" `` O O
mscfg32.dll NN O O
" '' O O
module NN O O
below RB O O
. . O O

The DT O O
module NN O O
communicates VBZ O O
with IN O O
the DT O O
Stage0/Rootkit NNP O O
driver NN O O
" '' O O
msndsrv.sys NN O O
" '' O O
by IN O O
sending VBG O O
DeviceIoControl NNP O O
messages NNS O O
to IN O O
the DT O O
device NN O O
" `` O O
\\.\MSNDSRV NN O O
" '' O O
. . O O

It PRP O O
activates VBZ O O
the DT O O
rootkit NN O O
for IN O O
its PRP$ O O
own JJ O O
process NN O O
, , O O
for IN O O
the DT O O
target NN O O
process NN O O
holding VBG O O
the DT O O
orchestrator NN O O
and CC O O
for IN O O
all PDT O O
the DT O O
files NNS O O
involved VBN O O
. . O O

Platform NN O O
orchestrator NN O O
- HYPH O O
mscfg32.dll NN O O
, , O O
svchost32.dll XX O O
MD5 NNP O O
5767b9d851d0c24e13eca1bfd16ea424 CD O O
Size NNP O O
249 CD O O
856 CD O O
bytes NNS O O
Format NNP O O
PE32 NNP O O
DLL NNP O O
Compiled VBD O O
2008.01.24 CD O O
22:11:34 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
Location NN O O
% NN O O
System%\mscfg32.dll NNP O O
Creates NNPS O O
mutex NN O O
: : O O
" `` O O
01C482BA CD O O
- HYPH O O
BD31 NNP O O
- HYPH O O
4874-A08B NNP O O
- HYPH O O
A93EA5BCE511 NNP O O
" '' O O
, , O O
or CC O O
terminates VBZ O O
if IN O O
one PRP O O
already RB O O
exists VBZ O O
. . O O

Writes VBZ O O
a DT O O
timestamped JJ O O
log NN O O
file NN O O
to IN O O
one CD O O
of IN O O
the DT O O
following VBG O O
locations NNS O O
. . O O

% NN O O
SystemRoot%\temp\~yh56816.tmp NNP O O
C:\Windows\Temp\~yh56816.tmp NNP O O
% NN O O
Registry_SystemRoot_Value%\temp\~yh56816.tmp NNP O O
Value NNP O O
of IN O O
[ -LRB- O O
HKLM\SYSTEM\CurrentControlSet\Control\Session NNP O O
Manager\MemSubSys NNP O O
] -RRB- O O
D NN O O
The DT O O
file NN O O
" `` O O
~yh56816.tmp NN O O
" '' O O
retains VBZ O O
the DT O O
history NN O O
of IN O O
execution NN O O
. . O O

It PRP O O
comprises VBZ O O
debug NN O O
records NNS O O
of IN O O
simple JJ O O
structure NN O O
. . O O

Stage NN O O
: : O O
DWORD NNP O O
| NNP O O
DateTimeLow NNP O O
: : O O
DWORD NNP O O
| NNP O O
DateTimeHigh NNP O O
: : O O
DWORD NNP O O
Basically RB O O
, , O O
it PRP B-Entity 1
logs VBZ B-Action 2
the DT O O
execution NN B-Entity 3
of IN I-Entity O
every DT I-Entity O
stage NN I-Entity O
of IN I-Entity O
the DT I-Entity O
orchestrator NN I-Entity O
and CC I-Entity O
the DT I-Entity O
time NN I-Entity O
of IN I-Entity O
execution NN I-Entity O
. . O O

The DT O O
Stage NN O O
is VBZ O O
an DT O O
integer NN O O
number NN O O
starting VBG O O
from IN O O
1 CD O O
. . O O

This DT O O
module NN O O
spawns VBZ O O
a DT O O
new JJ O O
thread NN O O
in IN O O
the DT O O
DllMain NNP O O
function NN O O
which WDT O O
contains VBZ O O
the DT O O
main JJ O O
function NN O O
body NN O O
. . O O

The DT O O
procedure NN O O
disables VBZ O O
application NN O O
error NN O O
popups NNS O O
shown VBN O O
by IN O O
the DT O O
default NN O O
exception NN O O
handler NN O O
. . O O

This DT O O
is VBZ O O
probably RB O O
done VBN O O
only RB O O
in IN O O
the DT O O
" `` O O
Release NNP O O
" '' O O
version NN O O
of IN O O
the DT O O
malware NN O O
, , O O
because IN O O
the DT O O
following VBG O O
code NN O O
generates VBZ O O
exceptions NNS O O
that WDT O O
are VBP O O
reported VBN O O
to IN O O
the DT O O
user NN O O
if IN O O
application NN O O
error NN O O
popups NNS O O
are VBP O O
not RB O O
disabled JJ O O
. . O O

We PRP O O
assume VBP O O
that IN O O
the DT O O
" `` O O
Debug NNP O O
" '' O O
version NN O O
of IN O O
the DT O O
code NN O O
does VBZ O O
n't RB O O
suppress VB O O
error NN O O
popups NNS O O
when WRB O O
exception NN O O
occurs VBZ O O
as IN O O
this DT O O
helps VBZ O O
with IN O O
the DT O O
debugging NN O O
of IN O O
the DT O O
code NN O O
. . O O

The DT O O
module NN B-Entity 1
checks NNS B-Action 2
the DT O O
OS NNP B-Entity 3
version NN I-Entity O
and CC O O
if IN O O
it PRP O O
encounters VBZ O O
an DT O O
unsupported JJ O O
operating NN O O
system NN O O
the DT O O
code NN O O
generates VBZ O O
an DT O O
exception NN O O
which WDT O O
terminates VBZ O O
the DT O O
application NN O O
. . O O

The DT O O
list NN O O
of IN O O
OS NN O O
versions NNS O O
that WDT O O
pass VBP O O
this DT O O
test NN O O
. . O O

If IN O O
the DT O O
module NN O O
runs VBZ O O
on IN O O
Win9x NNP O O
, , O O
it PRP B-Entity 1
executes VBZ B-Action 2
Win9x NNP O O
- HYPH B-Entity 3
specific JJ I-Entity O
function NN I-Entity O
RegisterServiceProcess NN I-Entity O
to IN B-Modifier 4
hide VBP O O
from IN B-Entity 5
the DT I-Entity O
Windows NNP I-Entity O
Task NNP I-Entity O
Manager NNP I-Entity O
application NN I-Entity O
. . O O

If IN O O
the DT O O
module NN O O
is VBZ O O
NOT RB O O
running VBG O O
on IN O O
WinNT6.0 NNP O O
+ CC O O
, , O O
it PRP O O
then RB O O
attempts VBZ O O
to TO O O
open VB O O
a DT O O
virtual JJ O O
device NN O O
file NN O O
with IN O O
one CD O O
of IN O O
the DT O O
following VBG O O
names NNS O O
. . O O

If IN O O
the DT O O
device NN O O
file NN O O
is VBZ O O
successfully RB O O
opened VBN O O
, , O O
the DT O O
module NN O O
activates VBZ O O
a DT O O
rootkit NN O O
for IN O O
its PRP$ O O
process NN O O
and CC O O
for IN O O
the DT O O
file NN O O
location NN O O
" '' O O
% NN O O
SYSTEM%\unilay.dll JJ O O
" `` O O
local JJ O O
path NN O O
. . O O

This DT O O
is VBZ O O
followed VBN O O
by IN O O
finding VBG O O
and CC O O
terminating VBG O O
a DT O O
process NN O O
named VBN O O
" `` O O
winproc.exe NN O O
" '' O O
which WDT O O
is VBZ O O
the DT O O
name NN O O
of IN O O
another DT O O
component NN O O
of IN O O
the DT O O
platform NN O O
. . O O

Note VB O O
that IN O O
this DT O O
part NN O O
of IN O O
the DT O O
code NN O O
is VBZ O O
executed VBN O O
only RB O O
on IN O O
platforms NNS O O
different JJ O O
from IN O O
WinNT NNP O O
6.x NNP O O
( -LRB- O O
Windows NNP O O
Vista NNP O O
and CC O O
later RB O O
) -RRB- O O
. . O O

The DT O O
module NN O O
was VBD O O
designed VBN O O
to TO O O
fetch VB O O
or CC O O
update VB O O
its PRP$ O O
main JJ O O
configuration NN O O
data NNS O O
from IN O O
different JJ O O
places NNS O O
. . O O

There EX O O
are VBP O O
some DT O O
default NN O O
values NNS O O
set VBN O O
inside IN O O
the DT O O
code NN O O
, , O O
such JJ O O
as IN O O
some DT O O
timeout NN O O
values NNS O O
and CC O O
the DT O O
following VBG O O
C&Cs NNP O O
. . O O

These DT O O
default NN O O
values NNS O O
can MD O O
be VB O O
overwritten VBN O O
later RB O O
. . O O

Next RB O O
, , O O
it PRP O O
locates VBZ O O
a DT O O
data NNS O O
section NN O O
called VBN O O
" `` O O
Share2 NNP O O
" '' O O
in IN O O
the DT O O
current JJ O O
module NN O O
and CC O O
verifies IN O O
the DT O O
starting VBG O O
magic NN O O
number NN O O
. . O O

If IN O O
it PRP O O
is VBZ O O
0x63959700 NFP O O
, , O O
it PRP O O
then RB O O
decrypts VBZ O O
the DT O O
rest NN O O
of IN O O
the DT O O
data NNS O O
in IN O O
the DT O O
section NN O O
and CC O O
interprets VBZ O O
it PRP O O
as IN O O
a DT O O
configuration NN O O
block NN O O
. . O O

However RB O O
, , O O
data NNS O O
from IN O O
the DT O O
next JJ O O
location NN O O
can MD O O
override VB O O
all DT O O
previous JJ O O
settings NNS O O
. . O O

This DT O O
is VBZ O O
a DT O O
registry NN O O
value NN O O
with IN O O
special JJ O O
name NN O O
. . O O

The DT O O
naming NN O O
of IN O O
the DT O O
registry NN O O
location NN O O
is VBZ O O
the DT O O
same JJ O O
GUID NNP O O
- HYPH O O
like JJ O O
SHA1 JJ O O
value NN O O
as IN O O
the DT O O
one NN O O
used VBN O O
in IN O O
the DT O O
loader NN O O
( -LRB- O O
" `` O O
mscfg32.exe JJ O O
" '' O O
) -RRB- O O
, , O O
and CC O O
is VBZ O O
produced VBN O O
from IN O O
the DT O O
source NN O O
string NN O O
" `` O O
Configuration NN O O
" '' O O
. . O O

[ -LRB- O O
HKLM\SYSTEM\CurrentControlSet\Control\Session NNP O O
Manager\MemSubSys NNP O O
] -RRB- O O
{ -LRB- O O
42E14DD3- CD O O
F07A-78F1 CD O O
- HYPH O O
7659 CD O O
- HYPH O O
26AE141569AC CD O O
- HYPH O O
E0B3EE89 NN O O
} -RRB- O O
The DT O O
configuration NN O O
block NN O O
stored VBN O O
in IN O O
the DT O O
registry NN O O
value NN O O
is VBZ O O
encrypted VBN O O
using VBG O O
RC5 NN O O
with IN O O
the DT O O
1024-bit CD O O
key JJ O O
. . O O

Both DT O O
the DT O O
loader NN O O
and CC O O
the DT O O
orchestrator NN O O
share NN O O
the DT O O
same JJ O O
key NN O O
for IN O O
encrypting NN O O
and CC O O
decrypting VBG O O
the DT O O
registry NN O O
values NNS O O
in IN O O
the DT O O
" `` O O
MemSubSys NNP O O
" '' O O
key NN O O
. . O O

The DT O O
decrypted JJ O O
configuration NN O O
block NN O O
consists VBZ O O
of IN O O
a DT O O
series NN O O
of IN O O
tagged VBN O O
configuration NN O O
records NNS O O
in IN O O
the DT O O
following VBG O O
format NN O O
. . O O

[ -LRB- O O
RecordType NN O O
: : O O
DWORD][RecordSize NN O O
: : O O
DWORD][RecordValue NN O O
: : O O
% NN O O
RecordSize% NN O O
] -RRB- O O
We PRP O O
retrieved VBD O O
a DT O O
copy NN O O
of IN O O
a DT O O
configuration NN O O
block NN O O
and CC O O
decrypted VBD O O
and CC O O
partly RB O O
interpreted VBD O O
it PRP O O
. . O O

We PRP O O
are VBP O O
including VBG O O
the DT O O
results NNS O O
for IN O O
one CD O O
of IN O O
the DT O O
configuration NN O O
blocks NNS O O
. . O O

Time NNP O O
value NN O O
: : O O
1 CD O O
year NN O O
0 CD O O
months NNS O O
1 CD O O
days NNS O O
22 CD O O
hours NNS O O
6 CD O O
mins NNS O O
52 CD O O
secs NN O O
. . O O

The DT O O
orchestrator NN O O
is VBZ O O
expected VBN O O
to TO O O
set VB O O
this DT O O
field NN O O
to IN O O
the DT O O
time NN O O
of IN O O
initial JJ O O
configuration NN O O
. . O O

Binaries NNS O O
: : O O
3x1024-bit CD O O
encryption NN O O
keys NNS O O
1b8e7818dad6345c53c2707a2c44648eee700d5cf34fea6a19a3fa0a6a871c72963fdded VBD O O
91e2703c82b7747b8793e3063700da32cfb8d907dcce1beb36edd575418d1134ef188b CD O O
27ec3ce23711a656b0a8bf28921fbf1c39b4c90ad561e4174ed90f26ce11245bb9deb4b CD O O
4720403f47ca865ec8bbd3c1df9d93d042ff5b52ec6 CD O O
05000000000000000000000000000000000000000000000000000000000000000000 CD O O
00000000000000000000000000000000000000000000000000000000000000000000 CD O O
00000000000000000000000000000000000000000000000000000000000000000000 CD O O
0000000000000000000000000000000000000000000000000000 CD O O
ed04953f3452068ae6439f04c7904c8be5e98e66e2cd0f267d65240aeed88bd4d3c6105 NN O O
c99950dd42ccde4bc6bbaf9f6cb1b4e628d943e91f8f97f2aff705fdd25e3af6ba0bc4fd13 NN O O
d67a2bcb751bb8f21f3d4b66c599f3e572802911394d142f8cf3a299d6d4558f9f0f01634 NN O O
9afd1888472f4f8c729ffe913f670931f1a227 CD O O
C&C NNP O O
domain NN O O
: : O O
www[dot]waeservices[dot]com ADD O O
C&C NNP O O
IP NNP O O
address NN O O
: : O O
213.198.79.49 CD O O
C&C NNP O O
port NN O O
: : O O
443 CD O O
Timestamp NN O O
: : O O
2010 CD O O
- HYPH O O
12 CD O O
- HYPH O O
08 CD O O
11:35:57 CD O O
Tool NNP O O
Reference NN O O
: : O O
VTT/82055898/STEALTHFIGHTER/ NNP O O
2008 CD O O
- SYM O O
10 CD O O
- HYPH O O
16/14:59:06.229 CD O O
- HYPH O O
04:00 CD O O
TimeoutA NN O O
: : O O
25200 CD O O
sec NN O O
( -LRB- O O
7 CD O O
hours NNS O O
) -RRB- O O
TimeoutB NNP O O
: : O O
32400 CD O O
sec NN O O
( -LRB- O O
9 CD O O
hours NNS O O
) -RRB- O O
TimeoutC VBP O O
: : O O
3600 CD O O
sec NN O O
( -LRB- O O
1 CD O O
hour NN O O
) -RRB- O O
TimeoutD NNP O O
: : O O
172800 CD O O
sec NN O O
( -LRB- O O
48 CD O O
hours NNS O O
) -RRB- O O
+ CC O O
Several JJ O O
Unknown JJ O O
Values NNS O O
Other JJ O O
configuration NN O O
blocks NNS O O
we PRP O O
discovered VBD O O
contained VBD O O
similar JJ O O
information NN O O
, , O O
with IN O O
only RB O O
some DT O O
unique JJ O O
values NNS O O
. . O O

Timestamp NN O O
: : O O
2009 CD O O
- HYPH O O
11 CD O O
- HYPH O O
23 CD O O
14:10:15 CD O O
Tool NNP O O
Reference NNP O O
: : O O
Manual NNP O O
/ SYM O O
DRINKPARSLEY/2008 NNP O O
- HYPH O O
09 CD O O
- HYPH O O
30/10:06:46.468 CD O O
- HYPH O O
04:00 CD O O
Tool NNP O O
Reference NN O O
: : O O
VTT/82053737/STRAITACID/2008 NNP O O
- HYPH O O
09 CD O O
- HYPH O O
03/10:44:56.361 CD O O
- HYPH O O
04:00 CD O O
Tool NNP O O
Reference NN O O
: : O O
STRAITSHOOTER30.ex NNP O O
_ NFP O O
Tool NNP O O
Reference NNP O O
: : O O
VTT/82051410/LUTEUSOBSTOS/2008 NNP O O
- HYPH O O
07 CD O O
- HYPH O O
30/17:27:23.715 CD O O
- HYPH O O
04:00 CD O O
Tool NNP O O
Reference NN O O
: : O O
BACKSNARF_AB25 ADD O O
During IN O O
the DT O O
next JJ O O
step NN O O
, , O O
the DT O O
module NN O O
obtains VBZ O O
PE NNP O O
file NN O O
version NN O O
information NN O O
from IN O O
the DT O O
resource NN O O
section NN O O
. . O O

It PRP O O
loads VBZ O O
the DT O O
version NN O O
info NN O O
using VBG O O
hard RB O O
- HYPH O O
coded JJ O O
module NN O O
names NNS O O
, , O O
which WDT O O
are VBP O O
supposed VBN O O
to TO O O
match VB O O
the DT O O
current JJ O O
module NN O O
name NN O O
. . O O

SVCHOST32.DLL NN O O
for IN O O
Windows NNP O O
9x CD O O
MSCFG32.DLL NN O O
for IN O O
Windows NNP O O
NT NNP O O
If IN O O
file NN O O
version NN O O
information NN O O
is VBZ O O
available JJ O O
, , O O
it PRP O O
gets VBZ O O
language NN O O
- HYPH O O
specific JJ O O
values NNS O O
of IN O O
the DT O O
PrivateBuild NNP O O
block NN O O
. . O O

The DT O O
codepage NN O O
and CC O O
languages NNS O O
that WDT O O
are VBP O O
verified VBN O O
: : O O
Unicode NNP O O
, , O O
LANG_NEUTRAL NNP O O
and CC O O
LANG_ENGLISH_US NNP O O
. . O O

When WRB O O
this DT O O
check NN O O
passes VBZ O O
, , O O
the DT O O
module NN O O
gets VBZ O O
@default JJ O O
registry NN O O
value NN O O
from IN O O
the DT O O
following VBG O O
location NN O O
. . O O

[ -LRB- O O
HKLM\SOFTWARE\Classes\CLSID\{091FD378 NNP O O
- HYPH O O
422D NNP O O
- HYPH O O
A36E-8487 NNP O O
- HYPH O O
83B57ADD2109 NNP O O
} -RRB- O O
] -RRB- O O
TypeLib NNP O O
If IN O O
the DT O O
key NN O O
is VBZ O O
not RB O O
found VBN O O
, , O O
the DT O O
code NN O O
checks NNS O O
for IN O O
registry NN O O
value NN O O
TypeLib NNP O O
in IN O O
the DT O O
following VBG O O
key NN O O
: : O O
[ -LRB- O O
HKLM\SOFTWARE\Classes\CLSID\{091FD378 NNP O O
- HYPH O O
422D NNP O O
- HYPH O O
A36E-8487 NNP O O
- HYPH O O
83B57ADD2109 NNP O O
} -RRB- O O
] -RRB- O O
If IN O O
such PDT O O
a DT O O
value NN O O
is VBZ O O
found VBN O O
, , O O
it PRP O O
is VBZ O O
then RB O O
deleted VBN O O
along RB O O
with IN O O
the DT O O
Version NNP O O
value NN O O
if IN O O
it PRP O O
exists VBZ O O
in IN O O
the DT O O
same JJ O O
key NN O O
. . O O

The DT O O
string NN O O
obtained VBD O O
from IN O O
one CD O O
of IN O O
two CD O O
possible JJ O O
registry NN O O
values NNS O O
is VBZ O O
processed VBN O O
as IN O O
if IN O O
this DT O O
value NN O O
is VBZ O O
a DT O O
CLSID NNP O O
- HYPH O O
like JJ O O
string NN O O
: : O O
the DT O O
code NN O O
takes VBZ O O
the DT O O
last JJ O O
16 CD O O
hexadecimal JJ O O
digits NNS O O
, , O O
splits VBZ O O
them PRP O O
in IN O O
two CD O O
8-chars CD O O
values NNS O O
, , O O
converts VBZ O O
them PRP O O
to IN O O
binary JJ O O
form NN O O
( -LRB- O O
two CD O O
DWORDs NNS O O
) -RRB- O O
and CC O O
reverses VBZ O O
the DT O O
order NN O O
of IN O O
bytes NNS O O
in IN O O
each DT O O
DWORD NNP O O
and CC O O
XORs NNP O O
, , O O
the DT O O
first JJ O O
value NN O O
with IN O O
0x8ED400C0 NN O O
, , O O
and CC O O
the DT O O
second JJ O O
with IN O O
0x4FC2C17B. CD O O

Next RB O O
, , O O
the DT O O
first JJ O O
DWORD NNP O O
value NN O O
becomes VBZ O O
second RB O O
and CC O O
the DT O O
second JJ O O
becomes VBZ O O
first RB O O
. . O O

In IN O O
this DT O O
order NN O O
, , O O
they PRP O O
are VBP O O
stored VBN O O
in IN O O
a DT O O
structure NN O O
in IN O O
memory NN O O
. . O O

These DT O O
two CD O O
values NNS O O
seem VBP O O
to TO O O
be VB O O
very RB O O
important JJ O O
as IN O O
they PRP O O
override VBP O O
a DT O O
few JJ O O
values NNS O O
in IN O O
the DT O O
previously RB O O
known VBN O O
configuration NN O O
. . O O

If IN O O
they PRP O O
do VBP O O
n't RB O O
exist VB O O
, , O O
values NNS O O
from IN O O
the DT O O
current JJ O O
configuration NN O O
replace VB O O
them PRP O O
and CC O O
are VBP O O
stored VBN O O
back RB O O
in IN O O
the DT O O
registry NN O O
following VBG O O
the DT O O
reverse NN O O
procedure NN O O
. . O O

We PRP O O
collected VBD O O
and CC O O
decrypted VBD O O
several JJ O O
samples NNS O O
of IN O O
such JJ O O
values NNS O O
. . O O

According VBG O O
to IN O O
the DT O O
code NN O O
, , O O
they PRP O O
are VBP O O
initialized VBN O O
with IN O O
values NNS O O
of IN O O
the DT O O
Microsoft NNP O O
filetime NN O O
format NN O O
. . O O

So RB O O
, , O O
we PRP O O
decided VBD O O
to TO O O
interpret VB O O
them PRP O O
as IN O O
filetime NN O O
values NNS O O
. . O O

20101C04EC2C17B NN O O
: : O O
1 CD O O
year(s CD O O
) -RRB- O O
7 CD O O
month(s NN O O
) -RRB- O O
21 CD O O
day(s NNS O O
) -RRB- O O
23 CD O O
hour(s NNS O O
) -RRB- O O
32 CD O O
min(s NN O O
) -RRB- O O
1 CD O O
sec(s NN O O
) -RRB- O O
81E01C04EC2C17B CD O O
: : O O
1 CD O O
year(s CD O O
) -RRB- O O
7 CD O O
month(s CD O O
) -RRB- O O
8 CD O O
day(s NN O O
) -RRB- O O
12 CD O O
hour(s NN O O
) -RRB- O O
13 CD O O
min(s NNS O O
) -RRB- O O
5 CD O O
sec(s NN O O
) -RRB- O O
E0001C04EC2C17B NN O O
: : O O
1 CD O O
year(s CD O O
) -RRB- O O
7 CD O O
month(s NN O O
) -RRB- O O
21 CD O O
day(s NNS O O
) -RRB- O O
1 CD O O
hour(s CD O O
) -RRB- O O
6 CD O O
min(s NN O O
) -RRB- O O
15 CD O O
sec(s NN O O
) -RRB- O O
77101C04EC2C17B CD O O
: : O O
1 CD O O
year(s CD O O
) -RRB- O O
5 CD O O
month(s NN O O
) -RRB- O O
20 CD O O
day(s NN O O
) -RRB- O O
19 CD O O
hour(s NNS O O
) -RRB- O O
15 CD O O
min(s NN O O
) -RRB- O O
4 CD O O
sec(s NN O O
) -RRB- O O
30F01C04EC2C17B NN O O
: : O O
1 CD O O
year(s CD O O
) -RRB- O O
8 CD O O
month(s CD O O
) -RRB- O O
0 CD O O
day(s NN O O
) -RRB- O O
6 CD O O
hour(s NN O O
) -RRB- O O
10 CD O O
min(s NNS O O
) -RRB- O O
33 CD O O
sec(s NN O O
) -RRB- O O
C0901C04EC2C17B NN O O
: : O O
1 CD O O
year(s CD O O
) -RRB- O O
8 CD O O
month(s NN O O
) -RRB- O O
2 CD O O
day(s NNPS O O
) -RRB- O O
6 CD O O
hour(s NN O O
) -RRB- O O
29 CD O O
min(s NNS O O
) -RRB- O O
39 CD O O
sec(s NN O O
) -RRB- O O
66701C04EC2C17B NN O O
: : O O
1 CD O O
year(s CD O O
) -RRB- O O
6 CD O O
month(s CD O O
) -RRB- O O
9 CD O O
day(s NN O O
) -RRB- O O
2 CD O O
hour(s NN O O
) -RRB- O O
10 CD O O
min(s NN O O
) -RRB- O O
23 CD O O
sec(s NN O O
) -RRB- O O
F6501C04EC2C17B NN O O
: : O O
1 CD O O
year(s CD O O
) -RRB- O O
6 CD O O
month(s CD O O
) -RRB- O O
6 CD O O
day(s NN O O
) -RRB- O O
19 CD O O
hour(s NNS O O
) -RRB- O O
53 CD O O
min(s NN O O
) -RRB- O O
22 CD O O
sec(s NNS O O
) -RRB- O O
01401C04EC2C17B NFP O O
: : O O
1 LS O O
year(s LS O O
) -RRB- O O
6 CD O O
month(s NN O O
) -RRB- O O
25 CD O O
day(s NNS O O
) -RRB- O O
23 CD O O
hour(s NNS O O
) -RRB- O O
34 CD O O
min(s NN O O
) -RRB- O O
13 CD O O
sec(s NNS O O
) -RRB- O O
After IN O O
that DT O O
, , O O
the DT O O
module NN O O
stores NNS O O
current JJ O O
time NN O O
values NNS O O
in IN O O
encrypted VBN O O
form NN O O
in IN O O
the DT O O
registry NN O O
value NN O O
. . O O

[ -LRB- O O
HKLM\SYSTEM\CurrentControlSet\Control\Session NNP O O
Manager\MemSubSys NNP O O
] -RRB- O O
{ -LRB- O O
08DAB849 NN O O
- HYPH O O
0E1E- NNP O O
A1F0-DCF1 NNP O O
- HYPH O O
457081E091DB-117DB663 NNP O O
} -RRB- O O
( -LRB- O O
encoded VBN O O
SHA1 NNP O O
of IN O O
" `` O O
StartTime NNP O O
" '' O O
) -RRB- O O
The DT O O
module NN O O
contains VBZ O O
an DT O O
additional JJ O O
compressed JJ O O
Windows NNP O O
DLL NNP O O
file NN O O
in IN O O
the DT O O
resource NN O O
section NN O O
, , O O
which WDT O O
is VBZ O O
extracted VBN O O
as IN O O
" `` O O
unilay.dll JJ O O
" '' O O
( -LRB- O O
see VB O O
below RB O O
) -RRB- O O
. . O O

This DT O O
DLL NN O O
exports VBZ O O
a DT O O
number NN O O
of IN O O
functions NNS O O
that WDT O O
are VBP O O
just RB O O
wrappers NNS O O
of IN O O
the DT O O
system NN O O
API NNP O O
used VBD O O
to TO O O
work VB O O
with IN O O
files NNS O O
and CC O O
the DT O O
registry NN O O
, , O O
and CC O O
also RB O O
start VB O O
processes NNS O O
and CC O O
load VB O O
additional JJ O O
DLL NNP O O
files NNS O O
. . O O

The DT O O
orchestrator NN O O
contains VBZ O O
several JJ O O
built VBN O O
- HYPH O O
in RP O O
plugins NNS O O
that WDT O O
form VBP O O
the DT O O
core NN O O
of IN O O
the DT O O
platform NN O O
. . O O

These DT O O
are VBP O O
initialized VBN O O
in IN O O
the DT O O
first JJ O O
place NN O O
, , O O
and CC O O
then RB O O
additional JJ O O
plugins NNS O O
are VBP O O
loaded VBN O O
. . O O

All PDT O O
the DT O O
plugins NNS O O
are VBP O O
indexed VBN O O
in IN O O
a DT O O
single JJ O O
encrypted VBN O O
registry NN O O
value NN O O
. . O O

[ -LRB- O O
HKLM\SYSTEM\CurrentControlSet\Control\Session NNP O O
Manager\MemSubSys NNP O O
] -RRB- O O
1 CD O O
This DT O O
value NN O O
has VBZ O O
information NN O O
about RB O O
all PDT O O
the DT O O
components NNS O O
of IN O O
the DT O O
current JJ O O
kit NN O O
. . O O

It PRP O O
may MD O O
include VB O O
Unicode NNP O O
strings NNS O O
with IN O O
paths NNS O O
to IN O O
extra JJ O O
DLLs NNS O O
which WDT O O
serve VBP O O
as IN O O
plugins NNS O O
. . O O

Each DT O O
DLL NN O O
exports VBZ O O
at IN O O
least JJS O O
four CD O O
functions NNS O O
which WDT O O
are VBP O O
imported VBN O O
by IN O O
ordinal JJ O O
numbers NNS O O
from IN O O
1 CD O O
to IN O O
4 CD O O
. . O O

The DT O O
structure NN O O
of IN O O
the DT O O
registry NN O O
value NN O O
" `` O O
1 CD O O
" '' O O
. . O O

[ -LRB- O O
Count NNP O O
: : O O
DWORD NNP O O
] -RRB- O O
{ -LRB- O O
[ -LRB- O O
Plugin NNP O O
Id NNP O O
: : O O
WORD][Plugin ADD O O
Path NNP O O
Length NN O O
: : O O
DWORD][Plugin IN O O
Path NNP O O
String NN O O
: : O O
VARIABLE NN O O
] -RRB- O O
} -RRB- O O
Plugins NNS O O
interact VBP O O
with IN O O
each DT O O
other JJ O O
and CC O O
with IN O O
the DT O O
orchestrator NN O O
by IN O O
exchanging VBG O O
messages NNS O O
of IN O O
pre NN O O
- HYPH O O
defined VBN O O
format NN O O
. . O O

The DT O O
message NN O O
transport NN O O
is VBZ O O
implemented VBN O O
as IN O O
a DT O O
global JJ O O
object NN O O
that WDT O O
contains VBZ O O
four CD O O
communication NN O O
streams NNS O O
. . O O

Every DT O O
stream NN O O
contains VBZ O O
a DT O O
pair NN O O
of IN O O
kernel NN O O
synchronization NN O O
object NN O O
handles VBZ O O
( -LRB- O O
a DT O O
semaphore NN O O
with IN O O
fixed VBN O O
maximum JJ O O
value NN O O
defaulted VBN O O
to IN O O
1000 CD O O
and CC O O
a DT O O
mutex NN O O
) -RRB- O O
and CC O O
a DT O O
message NN O O
queue NN O O
as IN O O
an DT O O
array NN O O
. . O O

A DT O O
dedicated JJ O O
thread NN O O
processes VBZ O O
messages NNS O O
that WDT O O
appear VBP O O
in IN O O
the DT O O
message NN O O
queues NNS O O
. . O O

A DT O O
message NN O O
arrives VBZ O O
in IN O O
a DT O O
parcel NN O O
, , O O
represented VBN O O
as IN O O
two CD O O
DWORD NNP O O
values NNS O O
that WDT O O
contain VBP O O
the DT O O
size NN O O
of IN O O
the DT O O
message NN O O
and CC O O
a DT O O
pointer NN O O
to IN O O
the DT O O
message NN O O
data NNS O O
. . O O

The DT O O
message NN O O
data NNS O O
starts VBZ O O
with IN O O
a DT O O
DWORD NNP O O
identifying VBG O O
a DT O O
class NN O O
of IN O O
message NN O O
( -LRB- O O
a DT O O
request NN O O
, , O O
reply NN O O
, , O O
etc FW O O
) -RRB- O O
. . O O

The DT O O
orchestrator NN O O
contains VBZ O O
the DT O O
following VBG O O
built VBN O O
- HYPH O O
in RP O O
plugins NNS O O
( -LRB- O O
listed VBN O O
by IN O O
internal JJ O O
ID NNP O O
) -RRB- O O
: : O O
8000 CD O O
, , O O
8022 CD O O
, , O O
8024 CD O O
, , O O
803C CD O O
, , O O
8046 CD O O
, , O O
800A CD O O
, , O O
8042 CD O O
, , O O
8002 CD O O
, , O O
8004 CD O O
, , O O
8006 CD O O
, , O O
8008 CD O O
, , O O
8070 CD O O
, , O O
808E. CD O O

Several JJ O O
additional JJ O O
built VBN O O
- HYPH O O
in RP O O
modules NNS O O
have VBP O O
been VBN O O
discovered VBN O O
in IN O O
newer JJR O O
versions NNS O O
of IN O O
the DT O O
orchestrator NN O O
that WDT O O
was VBD O O
shipped VBN O O
with IN O O
the DT O O
GrayFish NNP O O
platform NN O O
. . O O

EquationDrug NNP O O
Plugins NNS O O
: : O O
Additional JJ O O
components NNS O O
Unilay NNP O O
. . O O
DLL NNP O O
This DT B-Entity 1
module NN I-Entity O
provides VBZ B-Action 2
a DT O O
compatibility NN B-Entity 3
layer NN I-Entity O
for IN B-Modifier 4
accessing VBG O O
system NN B-Entity 5
API NNP I-Entity O
functions NNS I-Entity O
for IN I-Entity O
Windows NNP I-Entity O
9x CD I-Entity O
. . O O

It PRP O O
redirects VBZ O O
Unicode NNP O O
( -LRB- O O
" `` O O
W NNP O O
" '' O O
) -RRB- O O
variants NNS O O
of IN O O
Windows NNP O O
API NNP O O
functions NNS O O
to IN O O
corresponding VBG O O
ANSI NNP O O
variants NNS O O
by IN O O
converting VBG O O
Unicode NNP O O
string NN O O
parameters NNS O O
to IN O O
multi VB O O
- HYPH O O
byte NN O O
strings NNS O O
and CC O O
calling VBG O O
the DT O O
respective JJ O O
ANSI NNP O O
API NNP O O
. . O O

MD5 NNP O O
EF4405930E6071AE1F7F6FA7D4F3397D NNP O O
Size NN O O
9 CD O O
728 CD O O
bytes NNS O O
Compiled VBN O O
2008.01.23 CD O O
14:23:10 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
Format NN O O
PE32 NNP O O
DLL NNP O O
, , O O
linker NN O O
version NN O O
6.0 CD O O
( -LRB- O O
Microsoft NNP O O
Visual NNP O O
C++ NNP O O
6.0 CD O O
) -RRB- O O
Exported VBN O O
functions NNS O O
( -LRB- O O
redirected VBN O O
to IN O O
ANSI NNP O O
variants NNS O O
) -RRB- O O
. . O O

100017EF CD O O
: : O O
CopyFileW NNP O O
10001039 CD O O
: : O O
CreateDirectoryW NNP O O
10001111 CD O O
: : O O
CreateFileW NNP O O
100011B3 CD O O
: : O O
CreateProcessW NNP O O
10001177 CD O O
: : O O
DeleteFileW NNP O O
10001516 CD O O
: : O O
FindFirstChangeNotificationW NNP O O
10001466 CD O O
: : O O
FindFirstFileExW NNP O O
10001300 CD O O
: : O O
FindFirstFileW NNP O O
100014C6 CD O O
: : O O
FindNextFileW NNP O O
10001564 CD O O
: : O O
GetCurrentDirectoryW NNP O O
1000188F CD O O
: : O O
GetFileAttributesW NNP O O
100016C6 CD O O
: : O O
GetStartupInfoW NNP O O
10001602 CD O O
: : O O
GetSystemDirectoryW NNP O O
10001664 CD O O
: : O O
GetWindowsDirectoryW NNP O O
10001853 CD O O
: : O O
LoadLibraryW NNP O O
1000178B CD O O
: : O O
MoveFileExW NNP O O
1000172D CD O O
: : O O
MoveFileW NNP O O
10001913 CD O O
: : O O
RegCreateKeyExW NNP O O
100019F5 CD O O
: : O O
RegDeleteKeyW NNP O O
10001DDF CD O O
: : O O
RegDeleteValueW NNP O O
10001A39 CD O O
: : O O
RegEnumKeyExW NNP O O
10001BE2 CD O O
: : O O
RegEnumValueW NNP O O
1000199B CD O O
: : O O
RegOpenKeyExW NNP O O
10001B23 CD O O
: : O O
RegQueryInfoKeyW NNP O O
10001D57 CD O O
: : O O
RegSetValueExW NNP O O
100010D5 CD O O
: : O O
RemoveDirectoryW NNP O O
10001E81 CD O O
: : O O
SHGetFileInfoW NNP O O
100015C6 CD O O
: : O O
SetCurrentDirectoryW NNP O O
100018CB CD O O
: : O O
SetFileAttributesW NNP O O
10001E23 CD O O
: : O O
lstrcmpW NNP O O
Network NNP O O
- HYPH O O
sniffer NN O O
/ NFP O O
patcher RB O O
- HYPH O O
atmdkdrv.sys NN O O
MD5s NNP O O
8d87a1845122bf090b3d8656dc9d60a8 CD O O
214f7a2c95bdc265888fbcd24e3587da CD O O
Size NN O O
41 CD O O
440 CD O O
, , O O
43 CD O O
840 CD O O
bytes NNS O O
Format NNP O O
PE32 NNP O O
Native NNP O O
Compiled VBN O O
2009.04.16 CD O O
17:19:30 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
2008.05.07 CD O O
19:55:14 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
Version NNP O O
Info NNP O O
FileDescription NNP O O
: : O O
Network NNP O O
Services NNPS O O
LegalCopyright NNP O O
: : O O
Copyright NN O O
( -LRB- O O
C NNP O O
) -RRB- O O
Microsoft NNP O O
Corp. NNP O O

1981 CD O O
- SYM O O
2000 CD O O
InternalName NNP O O
: : O O
atmdkdrv.sys ADD O O
FileDescription NN O O
: : O O
CineMaster NNP O O
C NNP O O
1.1 CD O O
WDM NNP O O
Main NNP O O
Driver NNP O O
LegalCopyright NNP O O
: : O O
Copyright NN O O
1999 CD O O
RAVISENT NNP O O
Technologies NNPS O O
Inc. NNP O O

InternalName NNP O O
: : O O
ATMDKDRV.SYS NNP O O
Creates NNPS B-Action 1
a DT O O
file NN B-Entity 2
storage NN I-Entity O
" '' O O
\SystemRoot\fonts\vgafixa1.fon NN O O
" '' O O
. . O O

Its PRP$ O O
first JJ O O
word NN O O
is VBZ O O
set VBN O O
to IN O O
0x21 CD O O
at IN O O
the DT O O
beginning NN O O
of IN O O
the DT O O
DriverEntry NNP O O
function NN O O
, , O O
and CC O O
is VBZ O O
replaced VBN O O
with IN O O
0x20 CD O O
at IN O O
the DT O O
end NN O O
of IN O O
DriverEntry NNP O O
. . O O

This DT O O
driver NN O O
appears VBZ O O
to TO O O
have VB O O
been VBN O O
put VBN O O
together RB O O
in IN O O
" `` O O
quick JJ O O
- HYPH O O
and CC O O
- HYPH O O
dirty JJ O O
hack NN O O
" '' O O
style NN O O
, , O O
using VBG O O
parts NNS O O
of IN O O
the DT O O
" `` O O
mstcp32.sys NN O O
" '' O O
sniffer NN O O
and CC O O
other JJ O O
unknown JJ O O
drivers NNS O O
. . O O

It PRP O O
contains VBZ O O
a DT O O
lot NN O O
of IN O O
unused JJ O O
code NN O O
which WDT O O
is VBZ O O
partially RB O O
broken JJ O O
or CC O O
disabled JJ O O
. . O O

These DT O O
include VBP O O
a DT O O
broken JJ O O
" `` O O
Dynamically NNP O O
disable VB O O
/ SYM O O
enable JJ O O
windows NNS O O
audit NN O O
logging NN O O
" `` O O
subsystem NN O O
and CC O O
an DT O O
incomplete JJ O O
" `` O O
Patcher NNP O O
mode NN O O
" '' O O
. . O O

There EX O O
are VBP O O
three CD O O
algorithms NNS O O
used VBN O O
for IN O O
strings NNS O O
encryption NN O O
- HYPH O O
RC5 NN O O
; : O O
alphabet NN O O
encryption NN O O
like IN O O
the DT O O
one NN O O
used VBN O O
in IN O O
" `` O O
mstcp32.sys NN O O
" '' O O
; : O O
and CC O O
XOR NNP O O
with IN O O
a DT O O
pre NN O O
- HYPH O O
seeded VBN O O
random JJ O O
number NN O O
generator NN O O
. . O O

Decrypted VBN O O
strings NNS O O
are VBP O O
immediately RB O O
encrypted VBN O O
back RB O O
until IN O O
the DT O O
next JJ O O
usage NN O O
to TO O O
avoid VB O O
in IN O O
- HYPH O O
memory NN O O
detection NN O O
. . O O

The DT O O
driver NN O O
's POS O O
filename NN O O
and CC O O
device NN O O
name NN O O
differ VBP O O
across IN O O
the DT O O
samples NNS O O
. . O O

They PRP O O
depend VBP O O
on IN O O
the DT O O
name NN O O
of IN O O
the DT O O
registry NN O O
key NN O O
that WDT O O
is VBZ O O
used VBN O O
to TO O O
start VB O O
the DT O O
driver NN O O
. . O O

The DT O O
driver NN O O
may MD O O
operate VB O O
in IN O O
one CD O O
of IN O O
two CD O O
independent JJ O O
modes NNS O O
- : O O
as IN O O
a DT O O
network NN O O
sniffer NN O O
or CC O O
as IN O O
a DT O O
memory NN O O
patcher NN O O
. . O O

The DT O O
mode NN O O
of IN O O
operation NN O O
is VBZ O O
selected VBN O O
on IN O O
startup NN O O
, , O O
based VBN O O
on IN O O
the DT O O
" `` O O
Config2 NNP O O
" '' O O
value NN O O
of IN O O
the DT O O
driver NN O O
's POS O O
registry NN O O
key NN O O
. . O O

By IN O O
default NN O O
the DT O O
driver NN O O
starts VBZ O O
in IN O O
" `` O O
sniffer NN O O
mode NN O O
" '' O O
. . O O

The DT O O
sniffer NN O O
code NN O O
is VBZ O O
similar JJ O O
to IN O O
the DT O O
one NN O O
used VBN O O
in IN O O
the DT O O
driver NN O O
's POS O O
" `` O O
tdip.sys NN O O
" '' O O
and CC O O
" `` O O
mstcp32.sys JJ O O
" '' O O
and CC O O
uses VBZ O O
NT4 NNP O O
NDIS-4 NNP O O
, , O O
XP NNP O O
NDIS-5 NNP O O
interfaces NNS O O
, , O O
targeting VBG B-Action 1
incoming VBG O O
traffic NN B-Entity 2
on IN B-Modifier 3
Ethernet NNP O O
and CC B-Entity 4
VPN NNP I-Entity O
( -LRB- I-Entity O
ndiswanip NN I-Entity O
) -RRB- I-Entity O
interfaces VBZ I-Entity O
. . O O

It PRP O O
captures VBZ O O
only RB O O
directed VBN O O
packets NNS O O
( -LRB- O O
containing VBG O O
a DT O O
destination NN O O
address NN O O
equal JJ O O
to IN O O
the DT O O
station NN O O
address NN O O
of IN O O
the DT O O
NIC NNP O O
) -RRB- O O
. . O O

Packers NNPS O O
- HYPH O O
filtering VBG O O
engine NN O O
rules NNS O O
may MD O O
be VB O O
set VBN O O
via IN O O
DeviceIoControl NNP O O
messages NNS O O
. . O O

Filtered VBN O O
packets NNS O O
are VBP O O
stored VBN O O
in IN O O
- HYPH O O
memory NN O O
until IN O O
requested VBN O O
. . O O

Maximum JJ O O
packets NNS O O
storage NN O O
list NN O O
length NN O O
is VBZ O O
128 CD O O
items NNS O O
per IN O O
filtering NN O O
rule NN O O
. . O O

Almost RB O O
broken JJ O O
, , O O
it PRP O O
does VBZ O O
nothing NN O O
interesting JJ O O
except IN O O
, , O O
possibly RB O O
, , O O
replace VB O O
the DT O O
thread NN O O
's POS O O
ServiceTable NNP O O
to IN O O
an DT O O
unchanged JJ O O
, , O O
clear JJ O O
copy NN O O
taken VBN O O
from IN O O
the DT O O
on IN O O
- HYPH O O
disk NN O O
image NN O O
of IN O O
" `` O O
ntoskrnl.exe JJ O O
" '' O O
. . O O

Sniffer NN O O
only RB O O
IOCTLs VBZ O O
: : O O
44038004 CD O O
- HYPH O O
add VB O O
filtering NN O O
rule NN O O
44038008 CD O O
- HYPH O O
clear JJ O O
stored VBN O O
packet NN O O
in IN O O
specified JJ O O
filtering NN O O
rules NNS O O
list VBP O O
4403800C CD O O
- HYPH O O
enable NN O O
specified VBN O O
filtering NN O O
rule NN O O
44038010 CD O O
- HYPH O O
disable NN O O
specified VBN O O
filtering NN O O
rule NN O O
44038014 CD O O
- HYPH O O
get NN O O
stored VBN O O
packet NN O O
from IN O O
specified JJ O O
filtering NN O O
rules NNS O O
list VBP O O
44038018 CD O O
- HYPH O O
process NN O O
packet NN O O
like IN O O
the DT O O
one CD O O
received VBN O O
from IN O O
the DT O O
wire NN O O
( -LRB- O O
filter NN O O
and CC O O
store NN O O
) -RRB- O O
4403801C CD O O
- HYPH O O
set NN O O
maximum JJ O O
rules NNS O O
list VBP O O
length NN O O
44038020 CD O O
- HYPH O O
get VBP O O
maximum JJ O O
rules NNS O O
list VBP O O
length NN O O
80000004 CD O O
- HYPH O O
enablePacketsFiltering VBG O O
80000008 CD O O
- HYPH O O
disablePacketsFiltering NN O O
( -LRB- O O
PauseSniffer NNP O O
) -RRB- O O
800024B4 CD O O
- HYPH O O
send VB O O
packet NN O O
to IN O O
the DT O O
specified JJ O O
network NN O O
interface NN O O
Common NNP O O
IOCTLs NNP O O
: : O O
80000028 CD O O
- HYPH O O
do VBP O O
nothing NN O O
( -LRB- O O
broken VBN O O
/ SYM O O
unused JJ O O
part NN O O
) -RRB- O O
80000038 CD O O
- HYPH O O
set NN O O
external JJ O O
object NN O O
( -LRB- O O
broken VBN O O
/ SYM O O
unused JJ O O
part NN O O
) -RRB- O O
8000003C CD O O
- HYPH O O
get VBP O O
4 CD O O
dwords NNS O O
struct NN O O
( -LRB- O O
broken VBN O O
/ SYM O O
unused JJ O O
part NN O O
) -RRB- O O
80000040 CD O O
- HYPH O O
copy NN O O
260 CD O O
bytes NNS O O
from IN O O
the DT O O
request NN O O
( -LRB- O O
broken VBN O O
/ SYM O O
unused JJ O O
part NN O O
) -RRB- O O
80000320 CD O O
- HYPH O O
set NN O O
I PRP O O
/ SYM O O
O UH O O
port NN O O
mapping NN O O
( -LRB- O O
broken VBN O O
/ SYM O O
unused JJ O O
part NN O O
) -RRB- O O
80000324 CD O O
- HYPH O O
clear JJ O O
I PRP O O
/ SYM O O
O UH O O
port NN O O
mapping NN O O
( -LRB- O O
broken VBN O O
/ SYM O O
unused JJ O O
part NN O O
) -RRB- O O
80000328 CD O O
- HYPH O O
set NN O O
external JJ O O
PnP NNP O O
Event NNP O O
( -LRB- O O
broken VBN O O
/ SYM O O
unused JJ O O
part NN O O
) -RRB- O O
80000640 CD O O
- HYPH O O
replace NN O O
specified JJ O O
thread NN O O
's POS O O
SDT NNP O O
( -LRB- O O
ETHREAD.ServiceTable JJ O O
field NN O O
) -RRB- O O
to IN O O
a DT O O
given VBN O O
copy NN O O
Backdoor NNP O O
driven VBN O O
by IN O O
network NN O O
sniffer NN O O
- : O O
" `` O O
mstcp32.sys NN O O
" '' O O
, , O O
" `` O O
fat32.sys NN O O
" '' O O
MD5s NNP O O
74DE13B5EA68B3DA24ADDC009F84BAEE CD O O
B2C7339E87C932C491E34CDCD99FEB07 NNP O O
311D4923909E07D5C703235D83BF4479 NNP O O
21C278C88D8F6FAEA64250DF3BFFD7C6 CD O O
Size NNP O O
57 CD O O
328 CD O O
- SYM O O
57 CD O O
760 CD O O
bytes NNS O O
Format NNP O O
PE32 NNP O O
Native NNP O O
Compiled VBN O O
2007.10.02 CD O O
12:42:14 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
2001.08.17 CD O O
20:52:04 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
Version NNP O O
Info NNP O O
FileDescription NNP O O
: : O O
TCP NNP O O
/ , O O
IP NNP O O
driver NN O O
LegalCopyright NNP O O
: : O O
Copyright NN O O
( -LRB- O O
C NNP O O
) -RRB- O O
Microsoft NNP O O
Corp. NNP O O

1981 CD O O
- SYM O O
1999 CD O O
InternalName NNP O O
: : O O
mstcp32.sys NN O O
This DT O O
is VBZ O O
a DT O O
sniffer NN O O
tool NN O O
similar JJ O O
to IN O O
" `` O O
tdip.sys NN O O
" '' O O
and CC O O
it PRP O O
uses VBZ O O
NT4 NNP O O
NDIS-4 NNP O O
, , O O
XP NNP O O
NDIS-5 NNP O O
interfaces NNS O O
. . O O

It PRP O O
targets VBZ O O
incoming VBG O O
traffic NN O O
on IN O O
Ethernet NNP O O
and CC O O
VPN NNP O O
( -LRB- O O
ndiswanip NN O O
) -RRB- O O
interfaces NNS O O
, , O O
but CC O O
instead RB O O
of IN O O
dumb JJ O O
packet NN O O
dumping NN O O
, , O O
it PRP O O
uses VBZ O O
received VBN O O
packets NNS O O
as IN O O
commands NNS O O
for IN O O
the DT O O
" `` O O
process NN O O
injector NN O O
" '' O O
subsystem NN O O
that WDT O O
is VBZ O O
able JJ O O
to TO O O
extract VB O O
and CC O O
execute VB O O
code NN O O
from IN O O
the DT O O
specially RB O O
crafted VBN O O
network NN O O
packets NNS O O
. . O O

Default NN O O
filtering NN O O
rules NNS O O
are VBP O O
stored VBN O O
in IN O O
the DT O O
" `` O O
Options NNPS O O
" '' O O
registry NN O O
value NN O O
of IN O O
the DT O O
driver NN O O
's POS O O
registry NN O O
key NN O O
. . O O

It PRP O O
captures VBZ O O
only RB O O
directed VBN O O
packets NNS O O
( -LRB- O O
containing VBG O O
a DT O O
destination NN O O
address NN O O
equal JJ O O
to IN O O
the DT O O
station NN O O
address NN O O
of IN O O
the DT O O
NIC NNP O O
) -RRB- O O
. . O O

The DT O O
driver NN O O
's POS O O
filename NN O O
and CC O O
device NN O O
name NN O O
differ VBP O O
across IN O O
the DT O O
samples NNS O O
. . O O

They PRP O O
depend VBP O O
on IN O O
the DT O O
name NN O O
of IN O O
the DT O O
registry NN O O
key NN O O
that WDT O O
is VBZ O O
used VBN O O
to TO O O
start VB O O
the DT O O
driver NN O O
. . O O

The DT O O
code NN O O
- HYPH O O
builder NN O O
within IN O O
this DT O O
module NN O O
facilitates VBZ O O
exploitation NN O O
by IN O O
providing VBG O O
up RP O O
to IN O O
four CD O O
predefined JJ O O
execution NN O O
templates NNS O O
, , O O
which WDT O O
seem VBP O O
to TO O O
be VB O O
suitable JJ O O
for IN O O
generating VBG O O
several JJ O O
code NN O O
patterns NNS O O
. . O O

Below RB O O
is VBZ O O
a DT O O
list NN O O
of IN O O
the DT O O
execution NN O O
templates NNS O O
we PRP O O
found VBD O O
: : O O
locate VB O O
a DT O O
DLL NNP O O
via IN O O
PEB NNP O O
structure NN O O
and CC O O
resolve VB O O
exports NNS O O
call VBP O O
single JJ O O
function NN O O
call NN O O
four CD O O
functions NNS O O
call VBP O O
six CD O O
functions NNS O O
Using VBG O O
these DT O O
as IN O O
a DT O O
base NN O O
for IN O O
the DT O O
templates NNS O O
, , O O
the DT O O
code NN O O
- HYPH O O
builder NN O O
inserts NNS O O
parameters NNS O O
and CC O O
proper JJ O O
offsets NNS O O
to TO O O
call VB O O
one CD O O
of IN O O
the DT O O
following VBG O O
code NN O O
patterns NNS O O
. . O O

Locate VB O O
and CC O O
call VB O O
WinExec NNP O O
Locate VB O O
and CC O O
call VB O O
LoadLibraryW NNP O O
, , O O
GetProcAddress NNP O O
, , O O
call NN O O
exported VBN O O
procedure NN O O
, , O O
FreeLibrary NNP O O
Locate NNP O O
and CC O O
call VB O O
LoadLibraryW NNP O O
, , O O
GetProcAddress NNP O O
, , O O
call VB O O
GetModuleHandle NNP O O
, , O O
FreeLibrary NNP O O
Locate NNP O O
and CC O O
call VB O O
OpenProcess NNP O O
, , O O
VirtualAllocEx NNP O O
, , O O
WriteProcessMemory NNP O O
, , O O
CreateRemoteThread NNP O O
, , O O
VirtualFreeEx NNP O O
, , O O
CloseHandle NNP O O
The DT O O
code NN O O
injection NN O O
procedure NN O O
allocates VBZ O O
memory NN O O
via IN O O
ZwAllocateVirtualMemory NN O O
in IN O O
services.exe NN O O
and CC O O
copies NNS O O
implanted VBN O O
code NN O O
. . O O

After IN O O
that DT O O
it PRP O O
uses VBZ O O
KeInsertQueueApc NNP O O
to TO O O
let VB O O
the DT O O
code NN O O
run VB O O
and CC O O
waits VBZ O O
30 CD O O
seconds NNS O O
for IN O O
APC NNP O O
to TO O O
complete VB O O
. . O O

When WRB O O
the DT O O
module NN O O
starts VBZ O O
, , O O
it PRP B-Entity 1
reads VBZ B-Action 2
registry NN O O
value NN B-Entity 3
[ -LRB- O O
HKLM\System\CurrentControlSet\Services\%driver NNP O O
name% NNP O O
] -RRB- O O
Processes NNP O O
. . O O

This DT O O
value NN O O
may MD O O
contain VB O O
a DT O O
list NN O O
of IN O O
process NN O O
names NNS O O
that WDT O O
should MD O O
be VB O O
started VBN O O
by IN O O
injected VBN O O
executable JJ O O
code NN O O
but CC O O
only RB O O
after IN O O
services.exe NN O O
and CC O O
winlogon.exe NN O O
has VBZ O O
been VBN O O
started VBN O O
. . O O

The DT O O
injection NN B-Entity 1
of IN I-Entity O
code NN I-Entity O
into IN I-Entity O
winlogon.exe NNP I-Entity O
and CC I-Entity O
services.exe JJ I-Entity O
ensures VBZ B-Action 2
that IN B-Modifier 3
the DT O O
newly RB B-Entity 4
started VBN I-Entity O
process NN I-Entity O
will MD I-Entity O
have VB I-Entity O
SYSTEM VBN I-Entity O
user NN I-Entity O
privileges NNS I-Entity O
. . O O

During IN O O
the DT O O
injection NN O O
stage NN O O
Windows NNP O O
Audit NNP O O
Logging NNP O O
is VBZ O O
fully RB O O
disabled JJ O O
to TO O O
avoid VB O O
leaving VBG O O
any DT O O
suspicious JJ O O
records NNS O O
in IN O O
Windows NNP O O
Logs NNP O O
. . O O

All DT O O
incoming VBG O O
packets NNS O O
are VBP O O
first RB O O
filtered VBN O O
by IN O O
BPF NNP O O
- HYPH O O
like JJ O O
rules NNS O O
. . O O

The DT O O
filtering NN O O
rules NNS O O
are VBP O O
located VBN O O
in IN O O
[ -LRB- O O
HKLM\System NNP O O
\CurrentControlSet\Services\%driver NNP O O
name% NN O O
] -RRB- O O
Options NNS O O
registry NN O O
value NN O O
or CC O O
passed VBN O O
via IN O O
corresponding VBG O O
IOCTL NNP O O
. . O O

Packets NNS O O
that WDT O O
passed VBD O O
through IN O O
the DT O O
filter NN O O
are VBP O O
added VBN O O
in IN O O
the DT O O
end NN O O
of IN O O
processing NN O O
queue NN O O
. . O O

Packets NNS O O
from IN O O
the DT O O
queue NN O O
must MD O O
have VB O O
valid JJ O O
checksum NN O O
values NNS O O
. . O O

After IN O O
checking VBG O O
that IN O O
, , O O
the DT O O
code NN O O
XOR NNP O O
- HYPH O O
decrypts NNS O O
additional JJ O O
data NNS O O
from IN O O
the DT O O
end NN O O
of IN O O
the DT O O
packet NN O O
. . O O

The DT O O
decrypted JJ O O
end NN O O
of IN O O
the DT O O
packet NN O O
contains VBZ O O
another DT O O
control NN O O
structure NN O O
that WDT O O
defines VBZ O O
which WDT O O
encryption NN O O
algorithm NN O O
is VBZ O O
used VBN O O
to TO O O
decipher VB O O
packet NN O O
body NN O O
. . O O

Supported VBN O O
algorithms NNS O O
include VBP O O
RC5 NNP O O
and CC O O
RSA NNP O O
. . O O

There EX O O
is VBZ O O
a DT O O
1024-bits CD O O
RSA NNP O O
public JJ O O
key NN O O
hardcoded VBN O O
inside IN O O
the DT O O
module NN O O
body NN O O
, , O O
while IN O O
a DT O O
96-bits CD O O
RC5 NNP O O
key NN O O
is VBZ O O
generated VBN O O
dynamically RB O O
. . O O

The DT O O
backdoor JJ O O
command NN O O
may MD O O
arrive VB O O
in IN O O
a DT O O
single JJ O O
packet NN O O
or CC O O
be VB O O
split VBN O O
into IN O O
pieces NNS O O
and CC O O
come VB O O
with IN O O
several JJ O O
packets NNS O O
. . O O

There EX O O
is VBZ O O
a DT O O
procedure NN O O
for IN O O
re IN O O
- HYPH O O
assembling VBG O O
pieces NNS O O
together RB O O
: : O O
a DT O O
multi NN O O
- HYPH O O
packet NN O O
command NN O O
is VBZ O O
added VBN O O
to IN O O
a DT O O
special JJ O O
packet NN O O
collector NN O O
which WDT O O
puts VBZ O O
all PDT O O
the DT O O
pieces NNS O O
together RB O O
before IN O O
passing VBG O O
it PRP O O
further RB O O
. . O O

Backdoor JJ O O
command NN O O
is VBZ O O
stored VBN O O
in IN O O
the DT O O
first JJ O O
byte NN O O
of IN O O
the DT O O
decrypted VBN O O
request NN O O
and CC O O
can MD O O
be VB O O
one CD O O
of IN O O
the DT O O
following VBG O O
values NNS O O
. . O O

Note VB O O
: : O O
" `` O O
mstcp32 NN O O
" '' O O
is VBZ O O
mentioned VBN O O
together RB O O
with IN O O
rootkit NN O O
- HYPH O O
like JJ O O
behavior NN O O
in IN O O
2004 CD O O
here RB O O
: : O O
http://www.pcreview.co.uk ADD O O
/forums . O O
/ SYM O O
mstcp32-t1445152.html[21 NN O O
] -RRB- O O
Network NNP O O
Sniffer NNP O O
- HYPH O O
tdip.sys NNP O O
MD5s NNP O O
20506375665a6a62f7d9dd22d1cc9870 CD O O
60dab5bb319281747c5863b44c5ac60d CD O O
Size NN O O
22448 CD O O
- HYPH O O
28800 CD O O
bytes NNS O O
Format NNP O O
PE32 NNP O O
Native NNP O O
Compiled VBN O O
2006.10.16 CD O O
18:42:40 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
2003.08.17 CD O O
21:47:33 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
Supports VBZ O O
the DT O O
following VBG O O
versions NNS O O
of IN O O
Windows NNP O O
: : O O
NT4 NN O O
using VBG O O
NDIS-4 NNP O O
and CC O O
XP NNP O O
using VBG O O
NDIS-5 NNP O O
. . O O

Does VBZ O O
n't RB O O
use VB O O
Vista NNP O O
and CC O O
later RB O O
NDIS-6 NNP O O
features VBZ O O
. . O O

However RB O O
, , O O
later RB O O
NDIS NNP O O
versions NNS O O
are VBP O O
backward JJ O O
- HYPH O O
compatible JJ O O
, , O O
so RB O O
the DT O O
driver NN O O
is VBZ O O
still RB O O
valid JJ O O
for IN O O
current JJ O O
versions NNS O O
of IN O O
Windows NNP O O
. . O O

Version NNP O O
Info NNP O O
: : O O
FileDescription NNP O O
: : O O
IP NNP O O
Transport NNP O O
Driver NNP O O
LegalCopyright NNP O O
: : O O
Microsoft NNP O O
Corporation NNP O O
. . O O

All DT O O
rights NNS O O
reserved VBN O O
. . O O

FileVersion NN O O
: : O O
5.1.2600.2180 CD O O
InternalName NNP O O
: : O O
tdip.sys ADD O O
This DT B-Entity 1
driver NN I-Entity O
is VBZ B-Action 2
a DT O O
packet NN B-Entity 3
sniffer NN I-Entity O
for IN I-Entity O
incoming VBG I-Entity O
- HYPH I-Entity O
only JJ I-Entity O
traffic NN I-Entity O
on IN I-Entity O
Ethernet NNP I-Entity O
and CC I-Entity O
VPN NNP I-Entity O
( -LRB- I-Entity O
ndiswanip NN I-Entity O
) -RRB- I-Entity O
interfaces NNS I-Entity O
or CC O O
any DT O O
used VBN O O
with IN O O
ms_pschedmp NN O O
as IN O O
an DT O O
alternative JJ O O
connection NN O O
. . O O

It PRP O O
implements VBZ O O
a DT O O
BPF NNP O O
( -LRB- O O
Berkeley NNP O O
packet NN O O
filter NN O O
) -RRB- O O
style NN O O
packet NN O O
- HYPH O O
filtering VBG O O
system NN O O
that WDT O O
is VBZ O O
configured VBN O O
from IN O O
the DT O O
driver NN O O
's POS O O
registry NN O O
configuration NN O O
values NNS O O
or CC O O
from IN O O
DeviceIoControl NNP O O
messages NNS O O
. . O O

The DT O O
captured VBN O O
network NN O O
packets NNS O O
may MD O O
be VB O O
written VBN O O
to IN O O
disk NN O O
in IN O O
libpcap NN O O
format NN O O
( -LRB- O O
magic NN O O
0xA1B2C3D4 CD O O
version NN O O
2.4 CD O O
) -RRB- O O
and CC O O
encrypted VBN O O
with IN O O
one CD O O
- HYPH O O
byte NN O O
XOR NNP O O
, , O O
key JJ O O
0xE3 NN O O
. . O O

The DT O O
driver NN O O
's POS O O
configuration NN O O
is VBZ O O
stored VBN O O
in IN O O
the DT O O
registry NN O O
key NN O O
: : O O
[ -LRB- O O
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\tdip NN O O
] -RRB- O O
Options NNPS O O
- HYPH O O
packet NN O O
filtering NN O O
rules NNS O O
in IN O O
BPF NNP O O
format NN O O
Tag NNP O O
- HYPH O O
selector NN O O
of IN O O
filtered VBN O O
packet NN O O
types NNS O O
/ SYM O O
Defaults NNS O O
in IN O O
case NN O O
of IN O O
MediumWan NNP O O
to IN O O
NDIS_PACKET_TYPE_BROADCAST|NDIS_PACKET_TYPE_MULTICAST|NDIS_PACKET_TYPE_DIRECTED NNP O O
; : O O
( -LRB- O O
or CC O O
NDIS_PACKET_TYPE_BROADCAST|NDIS_PACKET_TYPE_DIRECTED NNP O O
in IN O O
any DT O O
other JJ O O
case NN O O
) -RRB- O O
ImageFile NNP O O
- HYPH O O
full JJ O O
path NN O O
name NN O O
to IN O O
the DT O O
resulting VBG O O
pcap NN O O
file NN O O
Duration NN O O
- HYPH O O
used VBN O O
as IN O O
Length NNP O O
of IN O O
the DT O O
original JJ O O
packet NN O O
in IN O O
dump NN O O
file NN O O
. . O O

( -LRB- O O
default NN O O
0xffff NNP O O
) -RRB- O O
Backup NNP O O
- HYPH O O
max NNP O O
size NN O O
of IN O O
the DT O O
pcap NN O O
file NN O O
IOCTLs NNS O O
: : O O
0x80002004 CD O O
getCurrentState NN O O
0x80002008 CD O O
setFilteringRules NNS O O
0x8000200C NFP O O
getFilteringRules NNS O O
0x80002024 NFP O O
getDumpFileSize NN O O
0x80002010/0x80002014/0x80002018/0x8000201C NFP O O
pause NN O O
/ SYM O O
resume NN O O
0x80002020 CD O O
getVersion NN O O
- HYPH O O
returns NNS O O
2.4.0 CD O O
Driver NNP O O
has VBZ O O
three CD O O
logical JJ O O
parts NNS O O
, , O O
and CC O O
uses VBZ O O
an DT O O
incomplete JJ O O
function NN O O
pointer NN O O
table NN O O
as IN O O
interface NN O O
. . O O

The DT O O
code NN O O
is VBZ O O
of IN O O
very RB O O
good JJ O O
quality NN O O
. . O O

It PRP O O
looks VBZ O O
more RBR O O
complicated JJ O O
than IN O O
Winpcap NNP O O
2.3 CD O O
( -LRB- O O
released VBN O O
28 CD O O
mar VBP O O
2002 CD O O
) -RRB- O O
, , O O
but CC O O
less RBR O O
so RB O O
than IN O O
Winpcap NNP O O
3.0 CD O O
( -LRB- O O
released VBN O O
by IN O O
10 CD O O
apr NN O O
2003 CD O O
) -RRB- O O
. . O O

Interestingly RB O O
, , O O
the DT O O
driver NN O O
identifies VBZ O O
itself PRP O O
as IN O O
" `` O O
version NN O O
2.4 CD O O
" '' O O
in IN O O
the DT O O
pcap NN O O
file NN O O
despite IN O O
there EX O O
being VBG O O
no DT O O
Winpcap NNP O O
version NN O O
2.4 CD O O
. . O O

Key NNP O O
/ SYM O O
clipboard NN O O
logger NN O O
driver NN O O
- HYPH O O
msrtvd.sys NN O O
MD5s NNP O O
98dea1bce37bf7087360e1958400589b CD O O
bb8f56874189d5dfe9294f0553a49b83 NN O O
f6bf3ed3bcd466e5fd1cbaf6ba658716 JJ O O
Size NN O O
31 CD O O
488 CD O O
- SYM O O
36 CD O O
736 CD O O
bytes NNS O O
Format NNP O O
PE32 NNP O O
Native NNP O O
Compiled VBN O O
2010.02.19 CD O O
22:45:18 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
2008.09.17 CD O O
16:23:54 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
Version NNP O O
Info NNP O O
FileDescription NNP O O
: : O O
MSRTvd NNP O O
interface NN O O
driver NN O O
LegalCopyright NNP O O
: : O O
Microsoft NNP O O
Corporation NNP O O
. . O O

All DT O O
rights NNS O O
reserved VBN O O
. . O O

InternalName NNP O O
: : O O
msrtvd.sys ADD O O
This DT B-Entity 1
is VBZ B-Action 2
a DT O O
keylogger NN B-Entity 3
and CC I-Entity O
clipboard NN I-Entity O
monitoring VBG I-Entity O
tool NN I-Entity O
. . O O

On IN O O
startup NN O O
, , O O
the DT O O
driver NN O O
creates VBZ O O
a DT O O
device NN O O
named VBN O O
" `` O O
\Device\Gk0 NN O O
" '' O O
and CC O O
a DT O O
symbolic JJ O O
link NN O O
named VBN O O
" `` O O
\DosDevices\Gk NN O O
" '' O O
. . O O

Then RB O O
it PRP O O
attaches VBZ O O
to IN O O
the DT O O
csrss.exe JJ O O
process NN O O
and CC O O
disassembles NNS O O
user32.dll JJ O O
and CC O O
ntdll.dll JJ O O
routines NNS O O
to TO O O
obtain VB O O
win32k.sys NN O O
and CC O O
ntoskrnl.exe JJ O O
SDT NNP O O
services NNS O O
indexes NNS O O
and CC O O
pointers NNS O O
of IN O O
needed VBN O O
Nt NNP O O
/ SYM O O
Zw NNP O O
APIs NNS O O
. . O O

Then RB O O
, , O O
using VBG O O
a DT O O
built VBN O O
- HYPH O O
in RP O O
disassembler NN O O
, , O O
it PRP O O
obtains VBZ O O
pointers NNS O O
to IN O O
NtUserPeekMessage NNP O O
, , O O
NtUserGetMessage NNP O O
, , O O
NtUserGetClipboardData NNP O O
and CC O O
using VBG O O
the DT O O
disassembler NN O O
again RB O O
selects VBZ O O
the DT O O
parts NNS O O
of IN O O
the DT O O
code NN O O
that WDT O O
will MD O O
be VB O O
then RB O O
hooked VBN O O
by IN O O
splicing NN O O
. . O O

The DT O O
interceptor NN O O
routines NNS O O
are VBP O O
copied VBN O O
from IN O O
a DT O O
special JJ O O
PE NNP O O
section NN O O
named VBN O O
" `` O O
.msda NN O O
" '' O O
. . O O

These DT O O
routines NNS B-Entity 1
are VBP O O
able JJ O O
to TO O O
collect VB B-Action 2
key JJ O O
press NN B-Entity 3
chains NNS I-Entity O
and CC O O
clipboard NN O O
text NN O O
data NNS O O
, , O O
add VB O O
information NN O O
about IN O O
current JJ O O
Time NN O O
, , O O
ProcessName NNP O O
, , O O
ForegroundWindowText NNP O O
, , O O
and CC O O
UserName NNP O O
related JJ O O
to IN O O
this DT O O
event NN O O
. . O O

A DT O O
dedicated JJ B-Entity 1
thread NN I-Entity O
( -LRB- O O
" `` O O
dumper NN O O
" '' O O
) -RRB- O O
gathers VBZ B-Action 2
the DT O O
collected VBN B-Entity 3
data NNS I-Entity O
, , O O
compresses VBZ B-Action 4
the DT O O
results NNS B-Entity 5
with IN B-Modifier 6
LZO NNP B-Entity 7
appends VBZ O O
it PRP O O
every DT O O
30 CD O O
minutes NNS O O
to IN O O
a DT O O
file NN O O
" '' O O
% NN O O
system NN O O
- HYPH O O
wide JJ O O
TEMP%\tm154o.da NN O O
" '' O O
. . O O

Most JJS O O
strings NNS B-Entity 1
inside IN I-Entity O
are VBP O O
encrypted VBN B-Action 2
by IN B-Modifier 3
XOR NNP O O
with IN B-Entity 4
a DT I-Entity O
pre NN I-Entity O
- HYPH I-Entity O
seeded VBN I-Entity O
random JJ I-Entity O
number NN I-Entity O
generator NN I-Entity O
. . O O

IOCTLs NNS O O
: : O O
0x22002C ADD O O
-start DT O O
dumper NN O O
thread NN O O
0x220030 CD O O
- HYPH O O
stop NN O O
dumper NN O O
thread NN O O
0x220034 CD O O
- HYPH O O
check NN O O
if IN O O
the DT O O
driver NN O O
has VBZ O O
new JJ O O
data NNS O O
to TO O O
dump VB O O
0x220038 CD O O
- HYPH O O
set NN O O
two CD O O
external JJ O O
events NNS O O
signaled VBD O O
on IN O O
dump NN O O
data NNS O O
availability NN O O
( -LRB- O O
it PRP O O
references VBZ O O
a DT O O
plugin NN O O
possibility NN O O
) -RRB- O O
0x22003C CD O O
- HYPH O O
restart NN O O
dumper NN O O
thread NN O O
0x220040 CD O O
- HYPH O O
get NN O O
size NN O O
of IN O O
available JJ O O
data NNS O O
Collector NNP O O
plugin NN O O
for IN O O
Volrec NNP O O
- HYPH O O
msrstd.sys NNP O O
MD5s NNP O O
69e7943f3d48233de4a39a924c59ed2c CD O O
15d39578460e878dd89e8911180494ff CD O O
Size NN O O
13 CD O O
696 CD O O
- SYM O O
17 CD O O
408 CD O O
bytes NNS O O
Format NNP O O
PE32 NNP O O
Native NNP O O
Compiled VBN O O
2009.06.05 CD O O
16:21:55 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
2009.12.15 CD O O
16:33:52 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
Version NNP O O
Info NNP O O
FileDescription NNP O O
: : O O
msrstd NN O O
driver NN O O
LegalCopyright NNP O O
: : O O
Microsoft NNP O O
Corporation NNP O O
. . O O

All DT O O
rights NNS O O
reserved VBN O O
. . O O

InternalName NNP O O
: : O O
msrstd.sys NN O O
This DT O O
driver NN O O
is VBZ O O
a DT O O
plugin NN O O
that WDT O O
collects VBZ O O
events NNS O O
from IN O O
the DT O O
" `` O O
volrec.sys NN O O
" '' O O
driver NN O O
, , O O
and CC O O
delivers VBZ O O
them PRP O O
by IN O O
sending VBG O O
DeviceIoControl NNP O O
messages NNS O O
. . O O

It PRP O O
collects VBZ O O
events NNS O O
about IN O O
file NN O O
and CC O O
disk NN O O
volume NN O O
operations NNS O O
. . O O

On IN O O
startup NN O O
the DT O O
driver NN O O
obtains VBZ O O
a DT O O
pointer NN O O
to IN O O
" `` O O
\Device\volrec NNP O O
" '' O O
, , O O
then RB O O
creates VBZ O O
a DT O O
control NN O O
device NN O O
" '' O O
\Device NN O O
\msrstd0 NN O O
" '' O O
and CC O O
a DT O O
symbolic JJ O O
link NN O O
to IN O O
it PRP O O
named VBN O O
" `` O O
\DosDevices\msrstd FW O O
" '' O O
All DT O O
strings NNS O O
inside IN O O
the DT O O
driver NN O O
are VBP O O
encrypted VBN O O
by IN O O
XOR NNP O O
with IN O O
a DT O O
pre NN O O
- HYPH O O
seeded VBN O O
random JJ O O
number NN O O
generator NN O O
. . O O

For IN O O
file NN O O
events NNS O O
the DT O O
driver NN O O
collects VBZ O O
the DT O O
filenames NNS O O
, , O O
and CC O O
caches VBZ O O
data NNS O O
about RB O O
read VBP O O
and CC O O
write VBP O O
operations NNS O O
. . O O

For IN O O
disk NN O O
volume NN O O
events NNS O O
it PRP O O
queries NNS O O
disk NN O O
properties NNS O O
and CC O O
reads VBZ O O
volume NN O O
labels NNS O O
and CC O O
disk NN O O
serial NN O O
numbers NNS O O
of IN O O
removable JJ O O
drives NNS O O
( -LRB- O O
USB NNP O O
, , O O
FireWire NNP O O
drives VBZ O O
) -RRB- O O
. . O O

IOCTLs NNS O O
. . O O

0x220004 CD O O
- HYPH O O
turn NN O O
on IN O O
VolumeEvents NNS O O
collection NN O O
0x220008 CD O O
- HYPH O O
turn NN O O
off RP O O
VolumeEvents NNS O O
collection NN O O
0x22000C CD O O
- HYPH O O
retrieve VB O O
previously RB O O
stored VBN O O
VolumeEvent NNP O O
( -LRB- O O
operationType UH O O
, , O O
deviceTypeFlags NNP O O
, , O O
VolumeLabel NNP O O
, , O O
volumeSerialNumber NNP O O
, , O O
DosDriveLetter NNP O O
) -RRB- O O
0x220010 CD O O
- HYPH O O
turn NN O O
on IN O O
FileEvents NNS O O
collection NN O O
0x220014 CD O O
- HYPH O O
turn NN O O
off RP O O
FileEvents NNS O O
collection NN O O
0x220018 CD O O
- HYPH O O
retrieve VB O O
previously RB O O
stored VBN O O
FileEvent NNP O O
( -LRB- O O
fileName NNP O O
, , O O
deviceTypeFlags NNP O O
, , O O
VolumeLabel NNP O O
, , O O
volumeSerialNumber NNP O O
, , O O
DosDriveLetter NNP O O
) -RRB- O O
0x22001C CD O O
- HYPH O O
connect NN O O
to IN O O
Volrec.sys NNP O O
( -LRB- O O
send VB O O
ioctl RB O O
0x220004 NNP O O
) -RRB- O O
, , O O
enable JJ O O
plugin NN O O
operation NN O O
0x220020 CD O O
- HYPH O O
disconnect NN O O
from IN O O
Volrec.sys NNP O O
( -LRB- O O
send VB O O
ioctl RB O O
0x220008 NNP O O
) -RRB- O O
, , O O
disable JJ O O
plugin NN O O
operation NN O O
Filesystem NNP O O
filter NN O O
driver NN O O
â€“ . O O
volrec.sys NN O O
, , O O
scsi2mgr.sys XX O O
MD5s XX O O
a6662b8ebca61ca09ce89e1e4f43665d XX O O
c17e16a54916d3838f63d208ebab9879 XX O O
Size NNP O O
14 CD O O
464 CD O O
- HYPH O O
14 CD O O
848 CD O O
byres NNS O O
Format NNP O O
PE32 NNP O O
Native NNP O O
Compiled VBN O O
2009.06.05 CD O O
16:21:57 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
2009.12.15 CD O O
16:33:57 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
Version NNP O O
Info NNP O O
FileDescription NNP O O
: : O O
Volume NN O O
recognizer NN O O
driver NN O O
LegalCopyright NNP O O
: : O O
Microsoft NNP O O
Corporation NNP O O
. . O O

All DT O O
rights NNS O O
reserved VBN O O
. . O O

InternalName NNP O O
: : O O
volrec.sys NN O O
This DT O O
driver NN O O
is VBZ O O
a DT O O
generic JJ O O
filesystem NN O O
filter NN O O
which WDT O O
feeds VBZ O O
system NN O O
events NNS O O
to IN O O
user NN O O
- HYPH O O
mode NN O O
plugins NNS O O
. . O O

On IN O O
startup NN O O
the DT O O
driver NN O O
creates VBZ O O
a DT O O
control NN O O
device NN O O
named VBN O O
" `` O O
\Device\volrec NN O O
" '' O O
and CC O O
a DT O O
symbolic JJ O O
link NN O O
to IN O O
it PRP O O
named VBN O O
" `` O O
\DosDevices\volrec0 NN O O
" '' O O
. . O O

It PRP O O
then RB O O
attaches VBZ O O
all DT O O
available JJ O O
filesystem JJ O O
devices NNS O O
. . O O

It PRP O O
is VBZ O O
also RB O O
, , O O
able JJ O O
to TO O O
handle VB O O
removable JJ O O
storage NN O O
devices NNS O O
. . O O

All DT O O
strings NNS O O
inside IN O O
the DT O O
driver NN O O
are VBP O O
encrypted VBN O O
by IN O O
XOR NNP O O
with IN O O
a DT O O
pre NN O O
- HYPH O O
seeded VBN O O
random JJ O O
number NN O O
generator NN O O
. . O O

IOCTLs NNS O O
: : O O
0x220004 CD O O
- HYPH O O
setup NN O O
plugin NN O O
interface NN O O
0x220008 CD O O
- HYPH O O
disable JJ O O
plugin NN O O
calls VBZ O O
The DT O O
driver NN O O
handles VBZ O O
the DT O O
following VBG O O
system NN O O
events NNS O O
: : O O
file NN O O
opened VBD O O
, , O O
created VBN O O
or CC O O
closed VBN O O
data NN O O
is VBZ O O
read VBN O O
or CC O O
written VBN O O
to IN O O
a DT O O
file NN O O
new JJ O O
volume NN O O
is VBZ O O
mounted VBN O O
, , O O
unmounted JJ O O
new JJ O O
USB NN O O
or CC O O
FireWire NNP O O
device NN O O
attached VBN O O
HDD NNP O O
/ SYM O O
SSD NNP O O
operation NN O O
helper NN O O
driver NN O O
- HYPH O O
WIN32M.SYS NNP O O
MD5s NNP O O
2b444ac5209a8b4140dd6b747a996653 CD O O
b3487fdd1efd2d1ea1550fef5b749037 NN O O
Size NNP O O
19 CD O O
456 CD O O
- SYM O O
26 CD O O
631 CD O O
bytes NNS O O
Format NNP O O
PE32 NNP O O
Native NNP O O
, , O O
PE32 NNP O O
+ CC O O
Native NNP O O
Compiled VBD O O
2001.08.23 CD O O
17:03:19 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
2013.05.14 CD O O
15:58:36 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
Description NNP O O
This DT O O
module NN O O
will MD O O
be VB O O
the DT O O
subject NN O O
of IN O O
a DT O O
dedicated JJ O O
blogpost NN O O
. . O O

HDD NNP O O
/ SYM O O
SSD NNP O O
firmware JJ O O
operation NN O O
- HYPH O O
nls_933w.dll NN O O
MD5s NN O O
11fb08b9126cdb4668b3f5135cf7a6c5 CD O O
9f3f6f46c67d3fad2479963361cf118b CD O O
Size NN O O
212 CD O O
480 CD O O
- SYM O O
310 CD O O
272 CD O O
bytes NNS O O
Format NNP O O
PE32 NNP O O
DLL NNP O O
, , O O
PE32 NNP O O
+ CC O O
DLL NNP O O
Compiled VBD O O
2010.06.15 CD O O
16:23:37 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
2013.05.14 CD O O
16:12:35 CD O O
( -LRB- O O
GMT NNP O O
) -RRB- O O
Version NNP O O
Info NNP O O
FileDescription NNP O O
: : O O
Windows NNP O O
Networking NNP O O
Library NNP O O
( -LRB- O O
64bit NNP O O
dll VB O O
only RB O O
) -RRB- O O
LegalCopyright NNP O O
: : O O
Copyright NN O O
( -LRB- O O
C NNP O O
) -RRB- O O
Microsoft NNP O O
Corp. NNP O O

1981 CD O O
- SYM O O
2001 CD O O
FileVersion NN O O
: : O O
80AA CD O O
InternalName NN O O
: : O O
nls_933w.dll ADD O O
OriginalFilename NNP O O
: : O O
nls_933w.dll ADD O O
PrivateBuild NNP O O
: : O O
4.0.1.0 CD O O
ProductName NNP O O
: : O O
Microsoft(R NNP O O
) -RRB- O O
Windows NNP O O
( -LRB- O O
R NN O O
) -RRB- O O
2000 CD O O
Operating VBG O O
System NNP O O
ProductVersion NNP O O
: : O O
5.0.2074.0 CD O O
Full JJ O O
Version NN O O
: : O O
1.0.0.1 CD O O
Description NN O O
This DT O O
( -LRB- O O
80AA CD O O
) -RRB- O O
plugin NN O O
is VBZ O O
a DT O O
HDD NNP O O
firmware NN O O
fiashing VBG O O
tool NN O O
which WDT O O
includes VBZ O O
an DT O O
API NN O O
and CC O O
the DT O O
ability NN O O
to TO O O
read VB O O
/ SYM O O
write VB O O
arbitrary JJ O O
information NN O O
into IN O O
hidden JJ O O
sectors NNS O O
on IN O O
the DT O O
disk NN O O
. . O O

The DT O O
plugin NN O O
will MD O O
be VB O O
the DT O O
subject NN O O
of IN O O
a DT O O
separate JJ O O
blogpost NN O O
. . O O

