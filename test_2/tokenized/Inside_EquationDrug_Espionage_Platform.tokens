EquationDrug O
is O
one B-Entity
of I-Entity
the I-Entity
main I-Entity
espionage I-Entity
platforms I-Entity
used B-Action
by O
the B-Entity
Equation I-Entity
Group I-Entity
] O
, O
a O
highly O
sophisticated O
threat O
actor O
that O
has O
been O
engaged O
in O
multiple O
CNE O
( O
computer O
network O
exploitation O
) O
operations O
dating O
back O
to O
2001 O
, O
and O
perhaps O
as O
early O
as O
1996 O
. O

( O
See O
full O
report O
here O
[ O
PDF][2 O
] O
) O
. O

EquationDrug O
, O
which O
is O
still O
in O
use O
, O
dates O
back O
to O
2003 O
, O
although O
the O
more O
modern O
GrayFish O
platform O
is O
being O
pushed O
to O
new O
victims O
. O

EquationDrug B-Entity
represents B-Action
the O
main B-Entity
espionage I-Entity
platform I-Entity
from I-Entity
the I-Entity
# I-Entity
EquationAPT I-Entity
Group I-Entity
Tweet[3 O
] O
It O
's O
important O
to O
note O
that O
EquationDrug O
is O
not O
just O
a O
Trojan O
, O
but O
a O
full O
espionage O
platform O
, O
which O
includes O
a O
framework O
for O
conducting O
cyberespionage O
activities O
by O
deploying O
specific O
modules O
on O
the O
machines O
of O
selected O
victims O
. O

The O
concept O
of O
a O
cyberespionage O
platform O
is O
neither O
new O
nor O
unique O
. O

Other O
threat O
actors O
known O
to O
use O
such O
sophisticated O
platforms O
include O
Regin[4 O
] O
and O
Epic O
Turla[5 O
] O
. O

The O
EquationDrug B-Entity
platform I-Entity
can O
be O
extended B-Action
through B-Modifier
plugins O
( B-Entity
or I-Entity
modules I-Entity
) I-Entity
. O

It O
is O
pre O
- O
built O
with O
a B-Entity
default I-Entity
set I-Entity
of I-Entity
plugins I-Entity
supporting B-Action
a O
number B-Entity
of I-Entity
basic I-Entity
cyberespionage I-Entity
functions I-Entity
. O

These B-Entity
include B-Action
common O
features O
such O
as O
file B-Entity
collection I-Entity
and O
the B-Entity
making I-Entity
of I-Entity
screenshots I-Entity
. O

Sophistication O
is O
added O
by O
storing B-Action
stolen O
data B-Entity
inside B-Modifier
a O
custom B-Entity
- I-Entity
encrypted I-Entity
virtual I-Entity
file I-Entity
system I-Entity
before O
it B-Entity
is O
sent B-Action
to B-Modifier
the O
command B-Entity
and I-Entity
control I-Entity
servers I-Entity
. O

The O
name O
" O
EquationDrug O
" O
or O
" O
Equestre O
" O
was O
assigned O
to O
this O
framework O
by O
Kaspersky O
Lab O
researchers O
. O

The O
only O
reference O
left O
by O
the O
framework O
developers O
was O
a O
short O
string O
" O
UR O
" O
, O
as O
seen O
in O
several O
string O
artifacts O
left O
in O
the O
binaries O
. O

The O
EquationDrug O
platform O
includes O
dozens O
of O
executables O
, O
configurations O
and O
protected O
storage O
locations O
. O

Putting O
all O
the O
pieces O
of O
this O
puzzle O
together O
in O
the O
right O
order O
may O
take O
time O
for O
those O
who O
are O
not O
familiar O
with O
the O
platform O
. O

The O
platform O
includes O
executables O
, O
configurations O
and O
protected O
storage O
locations O
# O
EquationAPT O
Tweet[6 O
] O
The O
architecture O
of O
the O
whole O
framework O
resembles O
a O
mini O
- O
operating O
system O
with O
kernel O
- O
mode O
and O
user O
- O
mode O
components O
carefully O
interacting O
with O
each O
other O
via O
a O
custom O
message O
- O
passing O
interface O
. O

The O
platform O
includes O
a O
set O
of O
drivers O
, O
a O
platform O
core O
( O
orchestrator O
) O
and O
a O
number O
of O
plugins O
. O

Every O
plugin O
has O
a O
unique O
ID O
and O
version O
number O
that O
defines O
a O
set O
of O
functions O
it O
can O
provide O
. O

Some O
of O
the O
plugins O
depend O
on O
others O
and O
might O
not O
work O
unless O
dependencies O
are O
resolved O
. O

[ O
7 O
] O
Similar O
to O
popular O
OS O
kernel O
designs O
, O
such O
as O
on O
Unix O
- O
based O
systems O
, O
some O
of O
the O
essential O
modules O
are O
statically O
linked O
to O
the O
platform O
core O
, O
while O
others O
are O
loaded O
on O
demand O
. O

The O
hypothesis O
that O
these O
attackers O
have O
been O
active O
since O
the O
90s O
seems O
realistic O
# O
EquationAPT O
Tweet[9 O
] O
The O
platform O
is O
started O
by O
the O
kernel O
mode O
driver O
component O
( O
" O
msndsrv.sys O
" O
on O
Windows O
2000 O
or O
above O
and O
" O
mssvc32.vxd O
" O
on O
Windows O
9x O
) O
. O

The O
driver O
then O
waits O
for O
the O
system O
to O
start O
and O
initiates O
execution O
of O
the O
user O
- O
mode O
loader O
" O
mscfg32.exe O
" O
. O

The O
loader O
then O
starts O
the O
platform O
's O
central O
module O
( O
an O
orchestrator O
) O
from O
the O
" O
mscfg32.dll O
" O
module O
. O

Additional O
drivers O
and O
libraries O
may O
be O
loaded O
by O
different O
components O
of O
the O
platform O
, O
either O
built O
- O
in O
or O
auxiliary O
. O

The O
EquationDrug O
platform O
can O
be O
as O
sophisticated O
as O
a O
space O
station O
, O
but O
it O
appears O
to O
be O
of O
no O
use O
without O
its O
cyberespionage O
features O
. O

This O
function O
is O
provided O
by O
plugin O
modules O
that O
are O
part O
of O
the O
massive O
framework O
described O
above O
. O

We O
discovered O
dozens O
of O
plugins O
and O
each O
is O
a O
sophisticated O
element O
that O
can O
communicate O
with O
the O
core O
and O
become O
aware O
of O
the O
availability O
of O
other O
plugins O
. O

The O
plugins O
we O
discovered O
probably O
represent O
just O
a O
fraction O
of O
the O
attackers O
' O
potential O
. O

Each O
plugin O
is O
assigned O
a O
unique O
plugin O
ID O
number O
( O
WORD O
) O
, O
such O
as O
0x8000 O
, O
0x8002 O
, O
0x8004 O
, O
0x8006 O
, O
etc O
. O

All O
plugin O
IDs O
are O
even O
numbers O
and O
they O
all O
start O
from O
byte O
0x80 O
. O

The O
biggest O
plugin O
ID O
we O
have O
seen O
is O
0x80CA O
. O

To O
date O
, O
we O
have O
found O
30 O
unique O
plugin O
IDs O
in O
total O
. O

Considering O
the O
fact O
that O
the O
developers O
assigned O
plugin O
IDs O
incrementally O
, O
and O
assuming O
that O
other O
plugin O
IDs O
were O
assigned O
to O
modules O
that O
we O
have O
not O
yet O
discovered O
, O
it O
's O
not O
hard O
to O
calculate O
that O
86 O
modules O
have O
yet O
to O
be O
discovered O
. O

86 O
modules O
have O
yet O
to O
be O
discovered O
# O
EquationAPT O
Tweet[10 O
] O
The O
most O
interesting O
modules O
we O
have O
seen O
contain O
the O
following O
functionality O
. O

During O
our O
research O
we O
paid O
attention O
to O
unique O
identifiers O
and O
codenames O
used O
by O
the O
developers O
in O
the O
malware O
. O

Most O
of B-Entity
this I-Entity
information I-Entity
is O
carefully O
protected B-Action
with B-Modifier
obfuscation O
or B-Entity
encryption I-Entity
algorithms I-Entity
to O
prevent O
quick O
recognition O
, O
but O
anyone O
who O
breaks O
through O
this O
layer O
of O
encryption O
may O
discover O
some O
interesting O
internal O
strings O
, O
as O
demonstrated O
below O
. O

[ O
11 O
] O
Some O
other O
interesting O
text O
strings O
include O
. O

SkyhookChow O
Target O
SkyhookChow O
Payload O
Dissecorp O
Manual O
/ O
DRINKPARSLEY/2008 O
- O
09 O
- O
30/10:06:46.468 O
- O
04:00 O
VTT/82053737/STRAITACID/2008 O
- O
09 O
- O
03/10:44:56.361 O
- O
04:00 O
VTT/82051410/LUTEUSOBSTOS/2008 O
- O
07 O
- O
30/17:27:23.715 O
- O
04:00 O
STRAITSHOOTER30.ex O
_ O
BACKSNARF_AB25 O
c:\users\rmgree5\co\standalonegrok_2.1.1.1\gk_driver\gk_sa_driver O
â€¦ O
To O
install O
: O
run O
with O
no O
arguments O
Attempting O
to O
drop O
SFCriteria_Check O
failed O
! O
SFDriver O
Error O
detected O
! O
Uninstalling O
... O

Timeout O
waiting O
for O
the O
" O
canInstallNow O
" O
event O
from O
the O
implant O
- O
specific O
EXE O
! O
Trying O
to O
call O
privilege O
lib O
... O

Hiding O
directory O
Hiding O
plugin O
... O

Merging O
plugin O
... O

Merging O
old O
plugin O
key O
... O

Could O
n't O
reset O
canInstallNowEvent O
! O
Performing O
UR O
- O
specific O
pre O
- O
install O
... O

Work O
complete O
. O

Merged O
transport O
manager O
state O
. O

! O
! O
SFConfig O
! O
! O
Some O
other O
names O
, O
such O
as O
kernel O
object O
and O
file O
names O
, O
abbreviations O
, O
resource O
code O
page O
and O
several O
generic O
messages O
, O
point O
to O
English O
- O
speaking O
developers O
. O

Due O
to O
the O
limited O
number O
of O
such O
text O
strings O
it O
's O
hard O
to O
tell O
reliably O
if O
the O
developers O
were O
native O
English O
speakers O
. O

Link O
Timestamp O
Analysis O
We O
have O
gathered O
a O
reasonably O
large O
number O
of O
executable O
samples O
to O
which O
we O
have O
been O
able O
to O
apply O
link O
timestamp O
analysis O
. O

A O
link O
timestamp O
is O
a O
4-bytes O
value O
stored O
in O
an O
executable O
file O
header O
. O

This O
value O
is O
automatically O
set O
by O
compiler O
software O
when O
a O
developer O
builds O
a O
new O
executable O
. O

The O
value O
contains O
a O
detailed O
timestamp O
including O
minutes O
and O
even O
seconds O
of O
compilation O
time O
( O
think O
of O
it O
as O
the O
file O
's O
moment O
of O
birth O
) O
. O

Link O
timestamp O
analysis O
require O
the O
collection O
of O
the O
timestamps O
of O
all O
available O
executables O
, O
grouping O
them O
according O
to O
certain O
criteria O
, O
such O
as O
the O
hour O
or O
day O
of O
the O
week O
, O
and O
putting O
them O
on O
a O
chart O
. O

Below O
are O
some O
charts O
built O
using O
this O
approach O
. O

[ O
14 O
] O
Can O
we O
trust O
this O
information O
? O
The O
answer O
is O
: O
not O
fully O
, O
because O
the O
link O
timestamp O
can O
be O
altered O
by O
the O
developer O
in O
a O
way O
that O
's O
not O
always O
possible O
to O
spot O
. O

However O
, O
certain O
indicators O
such O
as O
matching O
the O
year O
on O
the O
timestamp O
with O
the O
support O
of O
technology O
popular O
in O
that O
year O
leads O
us O
to O
believe O
that O
the O
timestamps O
were O
, O
at O
the O
very O
least O
, O
not O
wholly O
replaced O
. O

Looking O
at O
this O
from O
the O
other O
side O
, O
the O
easiest O
option O
for O
the O
developer O
is O
to O
wipe O
the O
timestamp O
completely O
, O
replacing O
it O
with O
zeroes O
. O

This O
was O
not O
found O
in O
the O
case O
of O
EquationDrug O
. O

In O
fact O
, O
the O
timestamps O
look O
very O
realistic O
and O
match O
the O
working O
days O
and O
hours O
of O
a O
well O
- O
organized O
software O
developer O
from O
timezone O
UTC-3 O
or O
UTC-4 O
, O
if O
you O
assume O
that O
they O
come O
to O
work O
at O
8 O
or O
9 O
am O
. O

The O
timestamps O
match O
the O
working O
days O
of O
software O
developer O
from O
timezone O
UTC-3 O
or O
UTC-4 O
# O
EquationAPT O
Tweet[17 O
] O
And O
finally O
, O
in O
case O
you O
are O
wondering O
if O
the O
developers O
work O
on O
public O
holidays O
, O
you O
can O
check O
this O
for O
yourself O
against O
the O
full O
list O
of O
their O
working O
dates O
. O

EquationDrug O
represents O
the O
main O
espionage O
platform O
from O
the O
Equation O
Group O
. O

It O
's O
been O
in O
use O
for O
over O
10 O
years O
, O
replacing O
EquationLaser O
until O
it O
was O
replaced O
itself O
by O
the O
even O
more O
sophisticated O
GrayFish O
platform O
. O

The O
EquationDrug O
case O
demonstrates O
an O
interesting O
trend O
: O
a O
growth O
in O
code O
sophistication O
# O
EquationAPT O
Tweet[18 O
] O
The O
EquationDrug O
case O
demonstrates O
an O
interesting O
trend O
that O
we O
have O
been O
seeing O
while O
analyzing O
supposedly O
nation O
- O
state O
cyberattack O
tools O
: O
a O
growth O
in O
code O
sophistication O
. O

It O
is O
clear O
that O
nation O
- O
state O
attackers O
are O
looking O
for O
better O
stability O
, O
invisibility O
, O
reliability O
and O
universality O
in O
their O
cyberespionage O
tools O
. O

You O
can O
make O
a O
basic O
browser O
password O
- O
stealer O
or O
a O
sniffer O
within O
days O
. O

However O
, O
nation O
- O
states O
are O
focused O
on O
creating O
frameworks O
for O
wrapping O
such O
code O
into O
something O
that O
can O
be O
customized O
on O
live O
systems O
and O
provide O
a O
reliable O
way O
to O
store O
all O
components O
and O
data O
in O
encrypted O
form O
, O
inaccessible O
to O
normal O
users O
. O

While O
traditional O
cybercriminals O
mass O
- O
distribute O
emails O
with O
malicious O
attachments O
or O
infect O
websites O
on O
a O
large O
scale O
, O
nation O
- O
states O
create O
automatic O
systems O
infecting O
only O
selected O
users O
. O

While O
traditional O
cybercriminals O
typically O
reuse O
one O
malicious O
file O
for O
all O
victims O
, O
nation O
- O
states O
prepare O
malware O
unique O
to O
each O
victim O
and O
even O
implement O
restrictions O
preventing O
decryption O
and O
execution O
outside O
of O
the O
target O
computer O
. O

Nation O
- O
state O
attackers O
create O
automatic O
systems O
infecting O
only O
selected O
users O
# O
EquationAPT O
Tweet[19 O
] O
Sophistication O
of O
the O
framework O
is O
what O
makes O
this O
type O
of O
actor O
different O
from O
traditional O
cybercriminals O
, O
who O
prefer O
to O
focus O
on O
payload O
and O
malware O
capabilities O
such O
as O
implementing O
a O
long O
list O
of O
custom O
third O
- O
party O
software O
credential O
database O
parsers O
. O

The O
difference O
in O
tactics O
between O
cybercriminals O
and O
nation O
- O
state O
attackers O
appears O
to O
be O
due O
to O
relative O
resource O
availability O
. O

It O
's O
known O
that O
cybercriminals O
attempt O
to O
infect O
as O
many O
users O
as O
possible O
and O
that O
they O
can O
sometimes O
compromise O
hundreds O
of O
thousands O
of O
systems O
. O

It O
would O
will O
take O
many O
years O
to O
check O
all O
those O
machines O
manually O
, O
analyzing O
who O
owns O
them O
, O
what O
data O
is O
stored O
on O
them O
, O
and O
what O
custom O
software O
they O
run O
. O

Cybercriminals O
probably O
do O
n't O
even O
have O
enough O
disk O
space O
to O
collect O
all O
the O
potentially O
interesting O
data O
from O
the O
victims O
hit O
by O
their O
large O
scale O
infections O
. O

That O
is O
why O
cybercriminals O
prefer O
to O
extract O
tiny O
chunks O
of O
the O
most O
important O
data O
( O
credentials O
, O
credit O
card O
numbers O
, O
etc O
) O
on O
the O
machine O
of O
the O
victim O
and O
transfer O
only O
few O
kilobytes O
from O
each O
compromised O
host O
. O

Such O
data O
, O
when O
combined O
from O
all O
users O
, O
normally O
takes O
up O
gigabytes O
of O
disk O
space O
. O

Nation O
- O
state O
attackers O
have O
sufficient O
resources O
to O
store O
as O
much O
data O
as O
they O
want O
. O

They O
have O
access O
to O
virtually O
unlimited O
data O
storage O
. O

However O
, O
they O
do O
n't O
need O
, O
and O
often O
try O
to O
avoid O
, O
infecting O
random O
users O
, O
for O
the O
obvious O
reason O
of O
avoiding O
attention O
and O
remaining O
invisible O
. O

Implementing O
custom O
data O
format O
parsers O
in O
the O
malware O
not O
only O
does O
n't O
help O
them O
find O
all O
the O
valuable O
data O
on O
the O
victim O
's O
machine O
, O
but O
may O
also O
attract O
extra O
attention O
from O
security O
software O
running O
on O
the O
system O
. O

They O
mostly O
prefer O
to O
have O
a O
generic O
remote O
system O
management O
tool O
that O
can O
copy O
any O
information O
they O
might O
need O
even O
if O
it O
causes O
some O
redundancy O
. O

However O
, O
copying O
large O
volumes O
of O
information O
might O
slow O
down O
network O
connection O
and O
attract O
attention O
, O
especially O
in O
some O
countries O
with O
poorly O
developed O
internet O
infrastructure O
. O

To O
date O
, O
nation O
- O
state O
attackers O
have O
had O
to O
balance O
between O
these O
two O
poles O
: O
copying O
victims O
' O
entire O
hard O
drives O
while O
stealing O
only O
tiny O
bits O
of O
passwords O
and O
keys O
. O

Nation O
- O
state O
attackers O
use O
a O
remote O
system O
management O
tool O
that O
can O
copy O
any O
information O
they O
need O
# O
EquationAPT O
Tweet[20 O
] O
Now O
, O
if O
you O
wonder O
why O
EquationDrug O
, O
a O
powerful O
cyberespionage O
platform O
, O
does O
n't O
provide O
all O
stealing O
capability O
as O
standard O
in O
its O
malware O
core O
, O
the O
answer O
is O
that O
they O
prefer O
to O
customize O
the O
attack O
for O
each O
one O
of O
their O
victims O
. O

Only O
if O
they O
have O
chosen O
to O
actively O
monitor O
you O
and O
the O
security O
products O
on O
your O
machines O
have O
been O
disarmed O
, O
will O
you O
receive O
a O
plugin O
for O
the O
live O
tracking O
of O
your O
conversations O
or O
other O
specific O
functions O
related O
to O
your O
activities O
. O

We O
believe O
modularity O
and O
customization O
will O
become O
a O
unique O
trademark O
of O
nation O
- O
state O
attackers O
in O
the O
future O
. O

Some O
code B-Entity
paths I-Entity
in I-Entity
EquationDrug I-Entity
modules I-Entity
lead O
to B-Action
OS O
version B-Entity
checks I-Entity
including O
a O
test O
for O
Windows O
95 O
, O
which O
is O
accepted O
as O
one O
of O
supported O
platforms O
. O

While O
some O
other O
checks O
will O
not O
pass O
on O
Windows O
95 O
, O
the O
presence O
of O
this O
code O
means O
that O
this O
OS O
was O
supported O
in O
some O
earlier O
variants O
of O
the O
malware O
. O

Considering O
this O
and O
the O
existence O
of O
components O
designed O
to O
run O
on O
Windows O
9x O
( O
such O
as O
VXD O
- O
files O
) O
, O
as O
well O
as O
compilation O
timestamps O
dating O
back O
to O
early O
2000s O
, O
the O
hypothesis O
that O
these O
attackers O
have O
been O
active O
since O
the O
90s O
seems O
realistic O
. O

This O
makes O
the O
current O
attacker O
an O
outstanding O
actor O
operating O
longer O
than O
any O
other O
in O
the O
field O
. O

Kernel O
mode O
stage O
0 O
( O
Windows O
9x O
) O
- O
mssvc32.vxd O
MD5 O
0a5e9b15014733ee7685d8c8be81fb0d O
Size O
6 O
710 O
bytes O
Format O
Linear O
Executable O
( O
LE O
) O
This O
VXD O
driver O
handles O
only O
two O
control O
messages O
: O
W32_DeviceIoControl O
and O
Dynamic_Init O
. O

The O
DeviceIoControl O
part O
is O
not O
completely O
implemented O
and O
the O
driver O
is O
only O
able O
to O
check O
for O
some O
known O
control O
codes O
. O

However O
it O
does O
nothing O
. O

This O
handler O
looks O
more O
like O
a O
code O
stub O
rather O
than O
actual O
payload O
. O

On O
the O
Dynamic_Init O
event O
, O
the O
driver O
retrieves O
the O
location O
of O
the O
user O
- O
mode O
loader O
executable O
from O
the O
following O
registry O
value O
. O

[ O
HKLM\SYSTEM\CurrentControlSet\Control\Session O
Manager\MemSubSys O
] O
Config O
If O
the O
value O
is O
not O
present O
in O
the O
registry O
, O
it O
uses O
the O
following O
fallback O
string O
hardcoded O
in O
the O
binary O
. O

C:\WINDOWS\SYSTEM\SVCHOST32.EXE O
Next O
, O
it O
installs O
a O
callback O
procedure O
using O
Windows O
function O
_ O
SHELL_CallAtAppyTime O
. O

This O
procedure O
will O
be O
called O
when O
CPU O
is O
running O
in O
ring-3 O
mode O
, O
so O
that O
a B-Entity
new I-Entity
executable I-Entity
( O
loader O
process O
) O
can O
be O
started B-Action
via B-Modifier
the O
traditional B-Entity
way I-Entity
. O

This O
is O
a O
standard O
trick O
that O
was O
used O
by O
developers O
in O
the O
90s O
to O
initiate O
a O
call O
to O
DLL O
export O
in O
ring-3 O
from O
ring-0 O
in O
Windows O
9x O
OS O
family O
. O

Kernel O
mode O
stage O
0 O
and O
rootkit O
( O
Windows O
2000 O
and O
above O
) O
- O
msndsrv.sys O
MD5 O
c4f8671c1f00dab30f5f88d684af1927 O
Size O
105 O
392 O
bytes O
Format O
PE32 O
Native O
Compiled O
2008.01.23 O
14:12:33 O
( O
GMT O
) O
Location O
% O
System32%\drivers\msndsrv.sys O
This B-Entity
module I-Entity
can O
create B-Action
log O
files B-Entity
in B-Modifier
the O
following B-Entity
known I-Entity
locations I-Entity
. O

% O
systemroot%\system32\mslog32.dat O
% O
systemroot%\system32\msperf32.dat O
( O
default O
location O
) O
The O
driver O
acts O
as O
the O
first O
stage O
of O
the O
EquationDrug O
platform O
on O
Windows O
2000 O
+ O
and O
implements O
rootkit O
functions O
for O
hiding O
the O
components O
of O
the O
platform O
. O

Additionally O
, O
it O
implements O
a O
NDIS O
driver O
for O
filtering O
network O
traffic O
. O

When O
started O
and O
initialized O
, O
the O
driver O
retrieves O
the O
location O
of O
the O
user O
- O
mode O
loader O
executable O
from O
the O
registry O
value O
. O

[ O
HKLM\System\CurrentControlSet\Services\%driver O
name% O
] O
Config O
The O
% O
driver O
name% O
is O
not O
hardcoded O
and O
is O
obtained O
dynamically O
from O
the O
current O
module O
name O
, O
which O
means O
that O
different O
instances O
may O
check O
different O
registry O
keys O
and O
this O
may O
not O
be O
a O
reliable O
way O
to O
check O
for O
infection O
. O

The O
sample O
we O
analyzed O
used O
" O
msndsrv O
" O
as O
the O
% O
driver O
name% O
. O

Next O
, O
it O
crafts O
and O
injects O
a O
shellcode O
in O
" O
services.exe O
" O
or O
" O
winlogon.exe O
" O
. O

The O
shellcode O
is O
designed O
to O
spawn O
the O
loader O
process O
from O
the O
executable O
called O
" O
mscfg32.exe O
" O
. O

The O
rootkit O
code O
in O
the O
driver O
hooks O
several O
Native O
API O
functions O
that O
lets O
it O
hide B-Action
or O
protect B-Action
registry O
keys B-Entity
, O
files B-Entity
and O
running B-Entity
processes I-Entity
. O

The O
components O
of O
EquationDrug O
can O
modify O
the O
list O
of O
protected O
objects O
by O
sending O
DeviceIoControl O
messages O
to O
the O
driver O
. O

The O
driver B-Entity
also O
maintains B-Action
a O
persistent B-Entity
list I-Entity
of I-Entity
protected I-Entity
objects I-Entity
that I-Entity
is I-Entity
stored I-Entity
in I-Entity
the I-Entity
following I-Entity
registry I-Entity
values I-Entity
. O

[ O
HKLM\System\CurrentControlSet\Services\%driver O
name% O
] O
1 O
[ O
HKLM\System\CurrentControlSet\Services\%driver O
name% O
] O
2 O
These O
values O
are O
also O
protected O
by O
the O
rootkit O
. O

They O
can O
be O
revealed O
by O
booting O
Windows O
in O
Safe O
Mode O
. O

The O
driver O
contains O
the O
following O
unused O
strings O
. O

\\.\mailslot\dskInfo O
Dissecorp O
User O
- O
mode O
loader O
- O
mscfg32.exe O
, O
svchost32.exe O
MD5 O
c3af66b9ce29efe5ee34e87b6e136e3a O
Size O
22 O
016 O
bytes O
Format O
PE32 O
EXE O
Compiled O
2008.01.23 O
14:26:05 O
( O
GMT O
) O
Location O
% O
System32%\mscfg32.exe O
This O
module O
opens O
a O
unique O
event O
named O
" O
D0385CB7-B834 O
- O
45d1-A501 O
- O
1A1700E6C34E O
" O
. O

If O
the O
event O
exists O
, O
it O
waits O
for O
10 O
seconds O
and O
attempts O
to O
open O
a O
file O
whose O
name O
can O
be O
decrypted O
as O
" O
\\.\MSNDSRV O
" O
. O

If O
the O
device O
file O
is O
successfully O
opened O
, O
the O
code O
issues O
a O
device O
request O
with O
IOCTL O
code O
0x80000194 O
and O
no O
parameters O
. O

This O
module O
uses O
RC5 O
in O
CBC O
- O
like O
mode O
with O
a O
key O
length O
of O
96-bit O
for O
string O
encryption O
. O

Careful O
analysis O
reveals O
some O
bits O
of O
uninitialized O
memory O
found O
next O
to O
encryption O
key O
locations O
. O

This O
is O
unused O
but O
partly O
meaningful O
memory O
, O
because O
it O
seems O
to O
contain O
short O
chunks O
of O
strings O
resembling O
some O
local O
filepaths O
: O
" O
rver\8 O
" O
( O
probably O
part O
of O
" O
Server\8 O
... O
" O
string O
) O
" O
LInj O
" O
( O
could O
be O
a O
part O
of O
" O
DLLInjector O
" O
or O
similar O
) O
It O
's O
apparent O
that O
some O
parts O
of O
the O
code O
were O
designed O
to O
run O
on O
Windows O
9x O
, O
for O
example O
a O
call O
to O
RegisterServiceProcess O
Windows O
API O
function O
makes O
sense O
only O
on O
Windows O
9x O
OS O
family O
, O
because O
this O
API O
function O
does O
n't O
exist O
on O
Windows O
NT O
platform O
. O

The O
module B-Entity
uses O
a O
unique O
algorithm O
for O
generating B-Action
registry O
value B-Entity
names I-Entity
. O

The O
code O
contains O
strings O
, O
such O
as O
" O
SkyhookChow O
Target O
" O
, O
that O
are O
converted O
to O
GUID O
- O
like O
strings O
by O
calculating O
SHA1 O
hash O
and O
using O
its O
hexadecimal O
representation O
as O
a O
string O
. O

The O
resulting O
strings O
are O
used O
as O
actual O
registry O
value O
names O
in O
[ O
HKLM\SYSTEM\CurrentControlSet\Control\Session O
Manager\MemSubSys O
] O
registry O
key O
. O

Sample O
registry O
value O
names O
. O

Original O
String O
GUID O
- O
like O
registry O
value O
name O
SkyhookChow O
Target O
{ O
B6F5CD13-A74D-8B82-A6AA-6FA1BE2484C1 O
- O
6832DF06 O
} O
SkyhookChow O
Payload O
{ O
F4CF0326 O
- O
6DCD O
- O
EEC8 O
- O
5323 O
- O
01CEDB66741A O
- O
B55F6F12 O
} O
These O
registry O
values O
are O
encrypted O
using O
an O
RC5 O
algorithm O
using O
a O
hardcoded O
1024-bit O
key O
with O
24 O
rounds O
. O

The O
registry O
value O
. O

[ O
HKLM\SYSTEM\CurrentControlSet\Control\Session O
Manager\MemSubSys O
] O
{ O
F4CF0326 O
- O
6DCD- O
EEC8 O
- O
5323 O
- O
01CEDB66741A O
- O
B55F6F12 O
} O
( O
" O
SkyhookChow O
Payload O
" O
) O
should O
contain O
the O
location O
of O
the O
orchestrator O
DLL O
file O
( O
" O
mscfg32.dll O
" O
) O
. O

If O
the O
value O
is O
not O
present O
a O
default O
value O
" O
% O
SYSTEM%\mscfg32.dll O
" O
is O
used O
. O

The O
registry O
value O
. O

[ O
HKLM\SYSTEM\CurrentControlSet\Control\Session O
Manager\MemSubSys O
] O
{ O
B6F5CD13-A74D-8B82- O
A6AA-6FA1BE2484C1 O
- O
6832DF06 O
} O
( O
" O
SkyhookChow O
Target O
" O
) O
may O
contain O
the O
location O
of O
the O
executable O
file O
that O
will O
be O
used O
as O
a O
" O
shell O
" O
process O
for O
the O
orchestrator O
library O
. O

The O
module B-Entity
attempts O
to O
start B-Action
the O
" B-Entity
shell I-Entity
" I-Entity
process I-Entity
in B-Modifier
suspended O
mode B-Entity
. O

If O
there O
is O
no O
" O
SkyhookChow O
Target O
" O
value O
or O
the O
specified O
executable O
fails O
to O
start O
, O
the O
module O
tries O
different O
failsafe O
locations O
of O
the O
programs O
that O
can O
be O
used O
instead O
. O

Next O
, O
the B-Entity
module I-Entity
injects B-Action
extra O
code B-Entity
into B-Modifier
a O
newly B-Entity
started I-Entity
target I-Entity
process I-Entity
. O

The O
injected B-Entity
code I-Entity
loads B-Action
the O
payload B-Entity
DLL I-Entity
( I-Entity
" I-Entity
mscfg32.dll I-Entity
" I-Entity
) I-Entity
into B-Modifier
the O
target B-Entity
process I-Entity
and O
waits O
for O
the O
parent O
process O
to O
exit O
. O

When O
the O
parent O
process O
quits O
, O
it O
unloads O
the O
payload O
DLL O
and O
exits O
as O
well O
. O

The O
rest O
of O
the O
logic O
relies O
on O
the O
loaded O
DLL O
in O
that O
new O
process O
. O

See O
the O
description O
of O
the O
" O
mscfg32.dll O
" O
module O
below O
. O

The O
module O
communicates O
with O
the O
Stage0/Rootkit O
driver O
" O
msndsrv.sys O
" O
by O
sending O
DeviceIoControl O
messages O
to O
the O
device O
" O
\\.\MSNDSRV O
" O
. O

It O
activates O
the O
rootkit O
for O
its O
own O
process O
, O
for O
the O
target O
process O
holding O
the O
orchestrator O
and O
for O
all O
the O
files O
involved O
. O

Platform O
orchestrator O
- O
mscfg32.dll O
, O
svchost32.dll O
MD5 O
5767b9d851d0c24e13eca1bfd16ea424 O
Size O
249 O
856 O
bytes O
Format O
PE32 O
DLL O
Compiled O
2008.01.24 O
22:11:34 O
( O
GMT O
) O
Location O
% O
System%\mscfg32.dll O
Creates O
mutex O
: O
" O
01C482BA O
- O
BD31 O
- O
4874-A08B O
- O
A93EA5BCE511 O
" O
, O
or O
terminates O
if O
one O
already O
exists O
. O

Writes O
a O
timestamped O
log O
file O
to O
one O
of O
the O
following O
locations O
. O

% O
SystemRoot%\temp\~yh56816.tmp O
C:\Windows\Temp\~yh56816.tmp O
% O
Registry_SystemRoot_Value%\temp\~yh56816.tmp O
Value O
of O
[ O
HKLM\SYSTEM\CurrentControlSet\Control\Session O
Manager\MemSubSys O
] O
D O
The O
file O
" O
~yh56816.tmp O
" O
retains O
the O
history O
of O
execution O
. O

It O
comprises O
debug O
records O
of O
simple O
structure O
. O

Stage O
: O
DWORD O
| O
DateTimeLow O
: O
DWORD O
| O
DateTimeHigh O
: O
DWORD O
Basically O
, O
it B-Entity
logs B-Action
the O
execution B-Entity
of I-Entity
every I-Entity
stage I-Entity
of I-Entity
the I-Entity
orchestrator I-Entity
and I-Entity
the I-Entity
time I-Entity
of I-Entity
execution I-Entity
. O

The O
Stage O
is O
an O
integer O
number O
starting O
from O
1 O
. O

This O
module O
spawns O
a O
new O
thread O
in O
the O
DllMain O
function O
which O
contains O
the O
main O
function O
body O
. O

The O
procedure O
disables O
application O
error O
popups O
shown O
by O
the O
default O
exception O
handler O
. O

This O
is O
probably O
done O
only O
in O
the O
" O
Release O
" O
version O
of O
the O
malware O
, O
because O
the O
following O
code O
generates O
exceptions O
that O
are O
reported O
to O
the O
user O
if O
application O
error O
popups O
are O
not O
disabled O
. O

We O
assume O
that O
the O
" O
Debug O
" O
version O
of O
the O
code O
does O
n't O
suppress O
error O
popups O
when O
exception O
occurs O
as O
this O
helps O
with O
the O
debugging O
of O
the O
code O
. O

The O
module B-Entity
checks B-Action
the O
OS B-Entity
version I-Entity
and O
if O
it O
encounters O
an O
unsupported O
operating O
system O
the O
code O
generates O
an O
exception O
which O
terminates O
the O
application O
. O

The O
list O
of O
OS O
versions O
that O
pass O
this O
test O
. O

If O
the O
module O
runs O
on O
Win9x O
, O
it B-Entity
executes B-Action
Win9x O
- B-Entity
specific I-Entity
function I-Entity
RegisterServiceProcess I-Entity
to B-Modifier
hide O
from B-Entity
the I-Entity
Windows I-Entity
Task I-Entity
Manager I-Entity
application I-Entity
. O

If O
the O
module O
is O
NOT O
running O
on O
WinNT6.0 O
+ O
, O
it O
then O
attempts O
to O
open O
a O
virtual O
device O
file O
with O
one O
of O
the O
following O
names O
. O

If O
the O
device O
file O
is O
successfully O
opened O
, O
the O
module O
activates O
a O
rootkit O
for O
its O
process O
and O
for O
the O
file O
location O
" O
% O
SYSTEM%\unilay.dll O
" O
local O
path O
. O

This O
is O
followed O
by O
finding O
and O
terminating O
a O
process O
named O
" O
winproc.exe O
" O
which O
is O
the O
name O
of O
another O
component O
of O
the O
platform O
. O

Note O
that O
this O
part O
of O
the O
code O
is O
executed O
only O
on O
platforms O
different O
from O
WinNT O
6.x O
( O
Windows O
Vista O
and O
later O
) O
. O

The O
module O
was O
designed O
to O
fetch O
or O
update O
its O
main O
configuration O
data O
from O
different O
places O
. O

There O
are O
some O
default O
values O
set O
inside O
the O
code O
, O
such O
as O
some O
timeout O
values O
and O
the O
following O
C&Cs O
. O

These O
default O
values O
can O
be O
overwritten O
later O
. O

Next O
, O
it O
locates O
a O
data O
section O
called O
" O
Share2 O
" O
in O
the O
current O
module O
and O
verifies O
the O
starting O
magic O
number O
. O

If O
it O
is O
0x63959700 O
, O
it O
then O
decrypts O
the O
rest O
of O
the O
data O
in O
the O
section O
and O
interprets O
it O
as O
a O
configuration O
block O
. O

However O
, O
data O
from O
the O
next O
location O
can O
override O
all O
previous O
settings O
. O

This O
is O
a O
registry O
value O
with O
special O
name O
. O

The O
naming O
of O
the O
registry O
location O
is O
the O
same O
GUID O
- O
like O
SHA1 O
value O
as O
the O
one O
used O
in O
the O
loader O
( O
" O
mscfg32.exe O
" O
) O
, O
and O
is O
produced O
from O
the O
source O
string O
" O
Configuration O
" O
. O

[ O
HKLM\SYSTEM\CurrentControlSet\Control\Session O
Manager\MemSubSys O
] O
{ O
42E14DD3- O
F07A-78F1 O
- O
7659 O
- O
26AE141569AC O
- O
E0B3EE89 O
} O
The O
configuration O
block O
stored O
in O
the O
registry O
value O
is O
encrypted O
using O
RC5 O
with O
the O
1024-bit O
key O
. O

Both O
the O
loader O
and O
the O
orchestrator O
share O
the O
same O
key O
for O
encrypting O
and O
decrypting O
the O
registry O
values O
in O
the O
" O
MemSubSys O
" O
key O
. O

The O
decrypted O
configuration O
block O
consists O
of O
a O
series O
of O
tagged O
configuration O
records O
in O
the O
following O
format O
. O

[ O
RecordType O
: O
DWORD][RecordSize O
: O
DWORD][RecordValue O
: O
% O
RecordSize% O
] O
We O
retrieved O
a O
copy O
of O
a O
configuration O
block O
and O
decrypted O
and O
partly O
interpreted O
it O
. O

We O
are O
including O
the O
results O
for O
one O
of O
the O
configuration O
blocks O
. O

Time O
value O
: O
1 O
year O
0 O
months O
1 O
days O
22 O
hours O
6 O
mins O
52 O
secs O
. O

The O
orchestrator O
is O
expected O
to O
set O
this O
field O
to O
the O
time O
of O
initial O
configuration O
. O

Binaries O
: O
3x1024-bit O
encryption O
keys O
1b8e7818dad6345c53c2707a2c44648eee700d5cf34fea6a19a3fa0a6a871c72963fdded O
91e2703c82b7747b8793e3063700da32cfb8d907dcce1beb36edd575418d1134ef188b O
27ec3ce23711a656b0a8bf28921fbf1c39b4c90ad561e4174ed90f26ce11245bb9deb4b O
4720403f47ca865ec8bbd3c1df9d93d042ff5b52ec6 O
05000000000000000000000000000000000000000000000000000000000000000000 O
00000000000000000000000000000000000000000000000000000000000000000000 O
00000000000000000000000000000000000000000000000000000000000000000000 O
0000000000000000000000000000000000000000000000000000 O
ed04953f3452068ae6439f04c7904c8be5e98e66e2cd0f267d65240aeed88bd4d3c6105 O
c99950dd42ccde4bc6bbaf9f6cb1b4e628d943e91f8f97f2aff705fdd25e3af6ba0bc4fd13 O
d67a2bcb751bb8f21f3d4b66c599f3e572802911394d142f8cf3a299d6d4558f9f0f01634 O
9afd1888472f4f8c729ffe913f670931f1a227 O
C&C O
domain O
: O
www[dot]waeservices[dot]com O
C&C O
IP O
address O
: O
213.198.79.49 O
C&C O
port O
: O
443 O
Timestamp O
: O
2010 O
- O
12 O
- O
08 O
11:35:57 O
Tool O
Reference O
: O
VTT/82055898/STEALTHFIGHTER/ O
2008 O
- O
10 O
- O
16/14:59:06.229 O
- O
04:00 O
TimeoutA O
: O
25200 O
sec O
( O
7 O
hours O
) O
TimeoutB O
: O
32400 O
sec O
( O
9 O
hours O
) O
TimeoutC O
: O
3600 O
sec O
( O
1 O
hour O
) O
TimeoutD O
: O
172800 O
sec O
( O
48 O
hours O
) O
+ O
Several O
Unknown O
Values O
Other O
configuration O
blocks O
we O
discovered O
contained O
similar O
information O
, O
with O
only O
some O
unique O
values O
. O

Timestamp O
: O
2009 O
- O
11 O
- O
23 O
14:10:15 O
Tool O
Reference O
: O
Manual O
/ O
DRINKPARSLEY/2008 O
- O
09 O
- O
30/10:06:46.468 O
- O
04:00 O
Tool O
Reference O
: O
VTT/82053737/STRAITACID/2008 O
- O
09 O
- O
03/10:44:56.361 O
- O
04:00 O
Tool O
Reference O
: O
STRAITSHOOTER30.ex O
_ O
Tool O
Reference O
: O
VTT/82051410/LUTEUSOBSTOS/2008 O
- O
07 O
- O
30/17:27:23.715 O
- O
04:00 O
Tool O
Reference O
: O
BACKSNARF_AB25 O
During O
the O
next O
step O
, O
the O
module O
obtains O
PE O
file O
version O
information O
from O
the O
resource O
section O
. O

It O
loads O
the O
version O
info O
using O
hard O
- O
coded O
module O
names O
, O
which O
are O
supposed O
to O
match O
the O
current O
module O
name O
. O

SVCHOST32.DLL O
for O
Windows O
9x O
MSCFG32.DLL O
for O
Windows O
NT O
If O
file O
version O
information O
is O
available O
, O
it O
gets O
language O
- O
specific O
values O
of O
the O
PrivateBuild O
block O
. O

The O
codepage O
and O
languages O
that O
are O
verified O
: O
Unicode O
, O
LANG_NEUTRAL O
and O
LANG_ENGLISH_US O
. O

When O
this O
check O
passes O
, O
the O
module O
gets O
@default O
registry O
value O
from O
the O
following O
location O
. O

[ O
HKLM\SOFTWARE\Classes\CLSID\{091FD378 O
- O
422D O
- O
A36E-8487 O
- O
83B57ADD2109 O
} O
] O
TypeLib O
If O
the O
key O
is O
not O
found O
, O
the O
code O
checks O
for O
registry O
value O
TypeLib O
in O
the O
following O
key O
: O
[ O
HKLM\SOFTWARE\Classes\CLSID\{091FD378 O
- O
422D O
- O
A36E-8487 O
- O
83B57ADD2109 O
} O
] O
If O
such O
a O
value O
is O
found O
, O
it O
is O
then O
deleted O
along O
with O
the O
Version O
value O
if O
it O
exists O
in O
the O
same O
key O
. O

The O
string O
obtained O
from O
one O
of O
two O
possible O
registry O
values O
is O
processed O
as O
if O
this O
value O
is O
a O
CLSID O
- O
like O
string O
: O
the O
code O
takes O
the O
last O
16 O
hexadecimal O
digits O
, O
splits O
them O
in O
two O
8-chars O
values O
, O
converts O
them O
to O
binary O
form O
( O
two O
DWORDs O
) O
and O
reverses O
the O
order O
of O
bytes O
in O
each O
DWORD O
and O
XORs O
, O
the O
first O
value O
with O
0x8ED400C0 O
, O
and O
the O
second O
with O
0x4FC2C17B. O

Next O
, O
the O
first O
DWORD O
value O
becomes O
second O
and O
the O
second O
becomes O
first O
. O

In O
this O
order O
, O
they O
are O
stored O
in O
a O
structure O
in O
memory O
. O

These O
two O
values O
seem O
to O
be O
very O
important O
as O
they O
override O
a O
few O
values O
in O
the O
previously O
known O
configuration O
. O

If O
they O
do O
n't O
exist O
, O
values O
from O
the O
current O
configuration O
replace O
them O
and O
are O
stored O
back O
in O
the O
registry O
following O
the O
reverse O
procedure O
. O

We O
collected O
and O
decrypted O
several O
samples O
of O
such O
values O
. O

According O
to O
the O
code O
, O
they O
are O
initialized O
with O
values O
of O
the O
Microsoft O
filetime O
format O
. O

So O
, O
we O
decided O
to O
interpret O
them O
as O
filetime O
values O
. O

20101C04EC2C17B O
: O
1 O
year(s O
) O
7 O
month(s O
) O
21 O
day(s O
) O
23 O
hour(s O
) O
32 O
min(s O
) O
1 O
sec(s O
) O
81E01C04EC2C17B O
: O
1 O
year(s O
) O
7 O
month(s O
) O
8 O
day(s O
) O
12 O
hour(s O
) O
13 O
min(s O
) O
5 O
sec(s O
) O
E0001C04EC2C17B O
: O
1 O
year(s O
) O
7 O
month(s O
) O
21 O
day(s O
) O
1 O
hour(s O
) O
6 O
min(s O
) O
15 O
sec(s O
) O
77101C04EC2C17B O
: O
1 O
year(s O
) O
5 O
month(s O
) O
20 O
day(s O
) O
19 O
hour(s O
) O
15 O
min(s O
) O
4 O
sec(s O
) O
30F01C04EC2C17B O
: O
1 O
year(s O
) O
8 O
month(s O
) O
0 O
day(s O
) O
6 O
hour(s O
) O
10 O
min(s O
) O
33 O
sec(s O
) O
C0901C04EC2C17B O
: O
1 O
year(s O
) O
8 O
month(s O
) O
2 O
day(s O
) O
6 O
hour(s O
) O
29 O
min(s O
) O
39 O
sec(s O
) O
66701C04EC2C17B O
: O
1 O
year(s O
) O
6 O
month(s O
) O
9 O
day(s O
) O
2 O
hour(s O
) O
10 O
min(s O
) O
23 O
sec(s O
) O
F6501C04EC2C17B O
: O
1 O
year(s O
) O
6 O
month(s O
) O
6 O
day(s O
) O
19 O
hour(s O
) O
53 O
min(s O
) O
22 O
sec(s O
) O
01401C04EC2C17B O
: O
1 O
year(s O
) O
6 O
month(s O
) O
25 O
day(s O
) O
23 O
hour(s O
) O
34 O
min(s O
) O
13 O
sec(s O
) O
After O
that O
, O
the O
module O
stores O
current O
time O
values O
in O
encrypted O
form O
in O
the O
registry O
value O
. O

[ O
HKLM\SYSTEM\CurrentControlSet\Control\Session O
Manager\MemSubSys O
] O
{ O
08DAB849 O
- O
0E1E- O
A1F0-DCF1 O
- O
457081E091DB-117DB663 O
} O
( O
encoded O
SHA1 O
of O
" O
StartTime O
" O
) O
The O
module O
contains O
an O
additional O
compressed O
Windows O
DLL O
file O
in O
the O
resource O
section O
, O
which O
is O
extracted O
as O
" O
unilay.dll O
" O
( O
see O
below O
) O
. O

This O
DLL O
exports O
a O
number O
of O
functions O
that O
are O
just O
wrappers O
of O
the O
system O
API O
used O
to O
work O
with O
files O
and O
the O
registry O
, O
and O
also O
start O
processes O
and O
load O
additional O
DLL O
files O
. O

The O
orchestrator O
contains O
several O
built O
- O
in O
plugins O
that O
form O
the O
core O
of O
the O
platform O
. O

These O
are O
initialized O
in O
the O
first O
place O
, O
and O
then O
additional O
plugins O
are O
loaded O
. O

All O
the O
plugins O
are O
indexed O
in O
a O
single O
encrypted O
registry O
value O
. O

[ O
HKLM\SYSTEM\CurrentControlSet\Control\Session O
Manager\MemSubSys O
] O
1 O
This O
value O
has O
information O
about O
all O
the O
components O
of O
the O
current O
kit O
. O

It O
may O
include O
Unicode O
strings O
with O
paths O
to O
extra O
DLLs O
which O
serve O
as O
plugins O
. O

Each O
DLL O
exports O
at O
least O
four O
functions O
which O
are O
imported O
by O
ordinal O
numbers O
from O
1 O
to O
4 O
. O

The O
structure O
of O
the O
registry O
value O
" O
1 O
" O
. O

[ O
Count O
: O
DWORD O
] O
{ O
[ O
Plugin O
Id O
: O
WORD][Plugin O
Path O
Length O
: O
DWORD][Plugin O
Path O
String O
: O
VARIABLE O
] O
} O
Plugins O
interact O
with O
each O
other O
and O
with O
the O
orchestrator O
by O
exchanging O
messages O
of O
pre O
- O
defined O
format O
. O

The O
message O
transport O
is O
implemented O
as O
a O
global O
object O
that O
contains O
four O
communication O
streams O
. O

Every O
stream O
contains O
a O
pair O
of O
kernel O
synchronization O
object O
handles O
( O
a O
semaphore O
with O
fixed O
maximum O
value O
defaulted O
to O
1000 O
and O
a O
mutex O
) O
and O
a O
message O
queue O
as O
an O
array O
. O

A O
dedicated O
thread O
processes O
messages O
that O
appear O
in O
the O
message O
queues O
. O

A O
message O
arrives O
in O
a O
parcel O
, O
represented O
as O
two O
DWORD O
values O
that O
contain O
the O
size O
of O
the O
message O
and O
a O
pointer O
to O
the O
message O
data O
. O

The O
message O
data O
starts O
with O
a O
DWORD O
identifying O
a O
class O
of O
message O
( O
a O
request O
, O
reply O
, O
etc O
) O
. O

The O
orchestrator O
contains O
the O
following O
built O
- O
in O
plugins O
( O
listed O
by O
internal O
ID O
) O
: O
8000 O
, O
8022 O
, O
8024 O
, O
803C O
, O
8046 O
, O
800A O
, O
8042 O
, O
8002 O
, O
8004 O
, O
8006 O
, O
8008 O
, O
8070 O
, O
808E. O

Several O
additional O
built O
- O
in O
modules O
have O
been O
discovered O
in O
newer O
versions O
of O
the O
orchestrator O
that O
was O
shipped O
with O
the O
GrayFish O
platform O
. O

EquationDrug O
Plugins O
: O
Additional O
components O
Unilay O
. O
DLL O
This B-Entity
module I-Entity
provides B-Action
a O
compatibility B-Entity
layer I-Entity
for B-Modifier
accessing O
system B-Entity
API I-Entity
functions I-Entity
for I-Entity
Windows I-Entity
9x I-Entity
. O

It O
redirects O
Unicode O
( O
" O
W O
" O
) O
variants O
of O
Windows O
API O
functions O
to O
corresponding O
ANSI O
variants O
by O
converting O
Unicode O
string O
parameters O
to O
multi O
- O
byte O
strings O
and O
calling O
the O
respective O
ANSI O
API O
. O

MD5 O
EF4405930E6071AE1F7F6FA7D4F3397D O
Size O
9 O
728 O
bytes O
Compiled O
2008.01.23 O
14:23:10 O
( O
GMT O
) O
Format O
PE32 O
DLL O
, O
linker O
version O
6.0 O
( O
Microsoft O
Visual O
C++ O
6.0 O
) O
Exported O
functions O
( O
redirected O
to O
ANSI O
variants O
) O
. O

100017EF O
: O
CopyFileW O
10001039 O
: O
CreateDirectoryW O
10001111 O
: O
CreateFileW O
100011B3 O
: O
CreateProcessW O
10001177 O
: O
DeleteFileW O
10001516 O
: O
FindFirstChangeNotificationW O
10001466 O
: O
FindFirstFileExW O
10001300 O
: O
FindFirstFileW O
100014C6 O
: O
FindNextFileW O
10001564 O
: O
GetCurrentDirectoryW O
1000188F O
: O
GetFileAttributesW O
100016C6 O
: O
GetStartupInfoW O
10001602 O
: O
GetSystemDirectoryW O
10001664 O
: O
GetWindowsDirectoryW O
10001853 O
: O
LoadLibraryW O
1000178B O
: O
MoveFileExW O
1000172D O
: O
MoveFileW O
10001913 O
: O
RegCreateKeyExW O
100019F5 O
: O
RegDeleteKeyW O
10001DDF O
: O
RegDeleteValueW O
10001A39 O
: O
RegEnumKeyExW O
10001BE2 O
: O
RegEnumValueW O
1000199B O
: O
RegOpenKeyExW O
10001B23 O
: O
RegQueryInfoKeyW O
10001D57 O
: O
RegSetValueExW O
100010D5 O
: O
RemoveDirectoryW O
10001E81 O
: O
SHGetFileInfoW O
100015C6 O
: O
SetCurrentDirectoryW O
100018CB O
: O
SetFileAttributesW O
10001E23 O
: O
lstrcmpW O
Network O
- O
sniffer O
/ O
patcher O
- O
atmdkdrv.sys O
MD5s O
8d87a1845122bf090b3d8656dc9d60a8 O
214f7a2c95bdc265888fbcd24e3587da O
Size O
41 O
440 O
, O
43 O
840 O
bytes O
Format O
PE32 O
Native O
Compiled O
2009.04.16 O
17:19:30 O
( O
GMT O
) O
2008.05.07 O
19:55:14 O
( O
GMT O
) O
Version O
Info O
FileDescription O
: O
Network O
Services O
LegalCopyright O
: O
Copyright O
( O
C O
) O
Microsoft O
Corp. O

1981 O
- O
2000 O
InternalName O
: O
atmdkdrv.sys O
FileDescription O
: O
CineMaster O
C O
1.1 O
WDM O
Main O
Driver O
LegalCopyright O
: O
Copyright O
1999 O
RAVISENT O
Technologies O
Inc. O

InternalName O
: O
ATMDKDRV.SYS O
Creates B-Action
a O
file B-Entity
storage I-Entity
" O
\SystemRoot\fonts\vgafixa1.fon O
" O
. O

Its O
first O
word O
is O
set O
to O
0x21 O
at O
the O
beginning O
of O
the O
DriverEntry O
function O
, O
and O
is O
replaced O
with O
0x20 O
at O
the O
end O
of O
DriverEntry O
. O

This O
driver O
appears O
to O
have O
been O
put O
together O
in O
" O
quick O
- O
and O
- O
dirty O
hack O
" O
style O
, O
using O
parts O
of O
the O
" O
mstcp32.sys O
" O
sniffer O
and O
other O
unknown O
drivers O
. O

It O
contains O
a O
lot O
of O
unused O
code O
which O
is O
partially O
broken O
or O
disabled O
. O

These O
include O
a O
broken O
" O
Dynamically O
disable O
/ O
enable O
windows O
audit O
logging O
" O
subsystem O
and O
an O
incomplete O
" O
Patcher O
mode O
" O
. O

There O
are O
three O
algorithms O
used O
for O
strings O
encryption O
- O
RC5 O
; O
alphabet O
encryption O
like O
the O
one O
used O
in O
" O
mstcp32.sys O
" O
; O
and O
XOR O
with O
a O
pre O
- O
seeded O
random O
number O
generator O
. O

Decrypted O
strings O
are O
immediately O
encrypted O
back O
until O
the O
next O
usage O
to O
avoid O
in O
- O
memory O
detection O
. O

The O
driver O
's O
filename O
and O
device O
name O
differ O
across O
the O
samples O
. O

They O
depend O
on O
the O
name O
of O
the O
registry O
key O
that O
is O
used O
to O
start O
the O
driver O
. O

The O
driver O
may O
operate O
in O
one O
of O
two O
independent O
modes O
- O
as O
a O
network O
sniffer O
or O
as O
a O
memory O
patcher O
. O

The O
mode O
of O
operation O
is O
selected O
on O
startup O
, O
based O
on O
the O
" O
Config2 O
" O
value O
of O
the O
driver O
's O
registry O
key O
. O

By O
default O
the O
driver O
starts O
in O
" O
sniffer O
mode O
" O
. O

The O
sniffer O
code O
is O
similar O
to O
the O
one O
used O
in O
the O
driver O
's O
" O
tdip.sys O
" O
and O
" O
mstcp32.sys O
" O
and O
uses O
NT4 O
NDIS-4 O
, O
XP O
NDIS-5 O
interfaces O
, O
targeting B-Action
incoming O
traffic B-Entity
on B-Modifier
Ethernet O
and B-Entity
VPN I-Entity
( I-Entity
ndiswanip I-Entity
) I-Entity
interfaces I-Entity
. O

It O
captures O
only O
directed O
packets O
( O
containing O
a O
destination O
address O
equal O
to O
the O
station O
address O
of O
the O
NIC O
) O
. O

Packers O
- O
filtering O
engine O
rules O
may O
be O
set O
via O
DeviceIoControl O
messages O
. O

Filtered O
packets O
are O
stored O
in O
- O
memory O
until O
requested O
. O

Maximum O
packets O
storage O
list O
length O
is O
128 O
items O
per O
filtering O
rule O
. O

Almost O
broken O
, O
it O
does O
nothing O
interesting O
except O
, O
possibly O
, O
replace O
the O
thread O
's O
ServiceTable O
to O
an O
unchanged O
, O
clear O
copy O
taken O
from O
the O
on O
- O
disk O
image O
of O
" O
ntoskrnl.exe O
" O
. O

Sniffer O
only O
IOCTLs O
: O
44038004 O
- O
add O
filtering O
rule O
44038008 O
- O
clear O
stored O
packet O
in O
specified O
filtering O
rules O
list O
4403800C O
- O
enable O
specified O
filtering O
rule O
44038010 O
- O
disable O
specified O
filtering O
rule O
44038014 O
- O
get O
stored O
packet O
from O
specified O
filtering O
rules O
list O
44038018 O
- O
process O
packet O
like O
the O
one O
received O
from O
the O
wire O
( O
filter O
and O
store O
) O
4403801C O
- O
set O
maximum O
rules O
list O
length O
44038020 O
- O
get O
maximum O
rules O
list O
length O
80000004 O
- O
enablePacketsFiltering O
80000008 O
- O
disablePacketsFiltering O
( O
PauseSniffer O
) O
800024B4 O
- O
send O
packet O
to O
the O
specified O
network O
interface O
Common O
IOCTLs O
: O
80000028 O
- O
do O
nothing O
( O
broken O
/ O
unused O
part O
) O
80000038 O
- O
set O
external O
object O
( O
broken O
/ O
unused O
part O
) O
8000003C O
- O
get O
4 O
dwords O
struct O
( O
broken O
/ O
unused O
part O
) O
80000040 O
- O
copy O
260 O
bytes O
from O
the O
request O
( O
broken O
/ O
unused O
part O
) O
80000320 O
- O
set O
I O
/ O
O O
port O
mapping O
( O
broken O
/ O
unused O
part O
) O
80000324 O
- O
clear O
I O
/ O
O O
port O
mapping O
( O
broken O
/ O
unused O
part O
) O
80000328 O
- O
set O
external O
PnP O
Event O
( O
broken O
/ O
unused O
part O
) O
80000640 O
- O
replace O
specified O
thread O
's O
SDT O
( O
ETHREAD.ServiceTable O
field O
) O
to O
a O
given O
copy O
Backdoor O
driven O
by O
network O
sniffer O
- O
" O
mstcp32.sys O
" O
, O
" O
fat32.sys O
" O
MD5s O
74DE13B5EA68B3DA24ADDC009F84BAEE O
B2C7339E87C932C491E34CDCD99FEB07 O
311D4923909E07D5C703235D83BF4479 O
21C278C88D8F6FAEA64250DF3BFFD7C6 O
Size O
57 O
328 O
- O
57 O
760 O
bytes O
Format O
PE32 O
Native O
Compiled O
2007.10.02 O
12:42:14 O
( O
GMT O
) O
2001.08.17 O
20:52:04 O
( O
GMT O
) O
Version O
Info O
FileDescription O
: O
TCP O
/ O
IP O
driver O
LegalCopyright O
: O
Copyright O
( O
C O
) O
Microsoft O
Corp. O

1981 O
- O
1999 O
InternalName O
: O
mstcp32.sys O
This O
is O
a O
sniffer O
tool O
similar O
to O
" O
tdip.sys O
" O
and O
it O
uses O
NT4 O
NDIS-4 O
, O
XP O
NDIS-5 O
interfaces O
. O

It O
targets O
incoming O
traffic O
on O
Ethernet O
and O
VPN O
( O
ndiswanip O
) O
interfaces O
, O
but O
instead O
of O
dumb O
packet O
dumping O
, O
it O
uses O
received O
packets O
as O
commands O
for O
the O
" O
process O
injector O
" O
subsystem O
that O
is O
able O
to O
extract O
and O
execute O
code O
from O
the O
specially O
crafted O
network O
packets O
. O

Default O
filtering O
rules O
are O
stored O
in O
the O
" O
Options O
" O
registry O
value O
of O
the O
driver O
's O
registry O
key O
. O

It O
captures O
only O
directed O
packets O
( O
containing O
a O
destination O
address O
equal O
to O
the O
station O
address O
of O
the O
NIC O
) O
. O

The O
driver O
's O
filename O
and O
device O
name O
differ O
across O
the O
samples O
. O

They O
depend O
on O
the O
name O
of O
the O
registry O
key O
that O
is O
used O
to O
start O
the O
driver O
. O

The O
code O
- O
builder O
within O
this O
module O
facilitates O
exploitation O
by O
providing O
up O
to O
four O
predefined O
execution O
templates O
, O
which O
seem O
to O
be O
suitable O
for O
generating O
several O
code O
patterns O
. O

Below O
is O
a O
list O
of O
the O
execution O
templates O
we O
found O
: O
locate O
a O
DLL O
via O
PEB O
structure O
and O
resolve O
exports O
call O
single O
function O
call O
four O
functions O
call O
six O
functions O
Using O
these O
as O
a O
base O
for O
the O
templates O
, O
the O
code O
- O
builder O
inserts O
parameters O
and O
proper O
offsets O
to O
call O
one O
of O
the O
following O
code O
patterns O
. O

Locate O
and O
call O
WinExec O
Locate O
and O
call O
LoadLibraryW O
, O
GetProcAddress O
, O
call O
exported O
procedure O
, O
FreeLibrary O
Locate O
and O
call O
LoadLibraryW O
, O
GetProcAddress O
, O
call O
GetModuleHandle O
, O
FreeLibrary O
Locate O
and O
call O
OpenProcess O
, O
VirtualAllocEx O
, O
WriteProcessMemory O
, O
CreateRemoteThread O
, O
VirtualFreeEx O
, O
CloseHandle O
The O
code O
injection O
procedure O
allocates O
memory O
via O
ZwAllocateVirtualMemory O
in O
services.exe O
and O
copies O
implanted O
code O
. O

After O
that O
it O
uses O
KeInsertQueueApc O
to O
let O
the O
code O
run O
and O
waits O
30 O
seconds O
for O
APC O
to O
complete O
. O

When O
the O
module O
starts O
, O
it B-Entity
reads B-Action
registry O
value B-Entity
[ O
HKLM\System\CurrentControlSet\Services\%driver O
name% O
] O
Processes O
. O

This O
value O
may O
contain O
a O
list O
of O
process O
names O
that O
should O
be O
started O
by O
injected O
executable O
code O
but O
only O
after O
services.exe O
and O
winlogon.exe O
has O
been O
started O
. O

The O
injection B-Entity
of I-Entity
code I-Entity
into I-Entity
winlogon.exe I-Entity
and I-Entity
services.exe I-Entity
ensures B-Action
that B-Modifier
the O
newly B-Entity
started I-Entity
process I-Entity
will I-Entity
have I-Entity
SYSTEM I-Entity
user I-Entity
privileges I-Entity
. O

During O
the O
injection O
stage O
Windows O
Audit O
Logging O
is O
fully O
disabled O
to O
avoid O
leaving O
any O
suspicious O
records O
in O
Windows O
Logs O
. O

All O
incoming O
packets O
are O
first O
filtered O
by O
BPF O
- O
like O
rules O
. O

The O
filtering O
rules O
are O
located O
in O
[ O
HKLM\System O
\CurrentControlSet\Services\%driver O
name% O
] O
Options O
registry O
value O
or O
passed O
via O
corresponding O
IOCTL O
. O

Packets O
that O
passed O
through O
the O
filter O
are O
added O
in O
the O
end O
of O
processing O
queue O
. O

Packets O
from O
the O
queue O
must O
have O
valid O
checksum O
values O
. O

After O
checking O
that O
, O
the O
code O
XOR O
- O
decrypts O
additional O
data O
from O
the O
end O
of O
the O
packet O
. O

The O
decrypted O
end O
of O
the O
packet O
contains O
another O
control O
structure O
that O
defines O
which O
encryption O
algorithm O
is O
used O
to O
decipher O
packet O
body O
. O

Supported O
algorithms O
include O
RC5 O
and O
RSA O
. O

There O
is O
a O
1024-bits O
RSA O
public O
key O
hardcoded O
inside O
the O
module O
body O
, O
while O
a O
96-bits O
RC5 O
key O
is O
generated O
dynamically O
. O

The O
backdoor O
command O
may O
arrive O
in O
a O
single O
packet O
or O
be O
split O
into O
pieces O
and O
come O
with O
several O
packets O
. O

There O
is O
a O
procedure O
for O
re O
- O
assembling O
pieces O
together O
: O
a O
multi O
- O
packet O
command O
is O
added O
to O
a O
special O
packet O
collector O
which O
puts O
all O
the O
pieces O
together O
before O
passing O
it O
further O
. O

Backdoor O
command O
is O
stored O
in O
the O
first O
byte O
of O
the O
decrypted O
request O
and O
can O
be O
one O
of O
the O
following O
values O
. O

Note O
: O
" O
mstcp32 O
" O
is O
mentioned O
together O
with O
rootkit O
- O
like O
behavior O
in O
2004 O
here O
: O
http://www.pcreview.co.uk O
/forums O
/ O
mstcp32-t1445152.html[21 O
] O
Network O
Sniffer O
- O
tdip.sys O
MD5s O
20506375665a6a62f7d9dd22d1cc9870 O
60dab5bb319281747c5863b44c5ac60d O
Size O
22448 O
- O
28800 O
bytes O
Format O
PE32 O
Native O
Compiled O
2006.10.16 O
18:42:40 O
( O
GMT O
) O
2003.08.17 O
21:47:33 O
( O
GMT O
) O
Supports O
the O
following O
versions O
of O
Windows O
: O
NT4 O
using O
NDIS-4 O
and O
XP O
using O
NDIS-5 O
. O

Does O
n't O
use O
Vista O
and O
later O
NDIS-6 O
features O
. O

However O
, O
later O
NDIS O
versions O
are O
backward O
- O
compatible O
, O
so O
the O
driver O
is O
still O
valid O
for O
current O
versions O
of O
Windows O
. O

Version O
Info O
: O
FileDescription O
: O
IP O
Transport O
Driver O
LegalCopyright O
: O
Microsoft O
Corporation O
. O

All O
rights O
reserved O
. O

FileVersion O
: O
5.1.2600.2180 O
InternalName O
: O
tdip.sys O
This B-Entity
driver I-Entity
is B-Action
a O
packet B-Entity
sniffer I-Entity
for I-Entity
incoming I-Entity
- I-Entity
only I-Entity
traffic I-Entity
on I-Entity
Ethernet I-Entity
and I-Entity
VPN I-Entity
( I-Entity
ndiswanip I-Entity
) I-Entity
interfaces I-Entity
or O
any O
used O
with O
ms_pschedmp O
as O
an O
alternative O
connection O
. O

It O
implements O
a O
BPF O
( O
Berkeley O
packet O
filter O
) O
style O
packet O
- O
filtering O
system O
that O
is O
configured O
from O
the O
driver O
's O
registry O
configuration O
values O
or O
from O
DeviceIoControl O
messages O
. O

The O
captured O
network O
packets O
may O
be O
written O
to O
disk O
in O
libpcap O
format O
( O
magic O
0xA1B2C3D4 O
version O
2.4 O
) O
and O
encrypted O
with O
one O
- O
byte O
XOR O
, O
key O
0xE3 O
. O

The O
driver O
's O
configuration O
is O
stored O
in O
the O
registry O
key O
: O
[ O
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\tdip O
] O
Options O
- O
packet O
filtering O
rules O
in O
BPF O
format O
Tag O
- O
selector O
of O
filtered O
packet O
types O
/ O
Defaults O
in O
case O
of O
MediumWan O
to O
NDIS_PACKET_TYPE_BROADCAST|NDIS_PACKET_TYPE_MULTICAST|NDIS_PACKET_TYPE_DIRECTED O
; O
( O
or O
NDIS_PACKET_TYPE_BROADCAST|NDIS_PACKET_TYPE_DIRECTED O
in O
any O
other O
case O
) O
ImageFile O
- O
full O
path O
name O
to O
the O
resulting O
pcap O
file O
Duration O
- O
used O
as O
Length O
of O
the O
original O
packet O
in O
dump O
file O
. O

( O
default O
0xffff O
) O
Backup O
- O
max O
size O
of O
the O
pcap O
file O
IOCTLs O
: O
0x80002004 O
getCurrentState O
0x80002008 O
setFilteringRules O
0x8000200C O
getFilteringRules O
0x80002024 O
getDumpFileSize O
0x80002010/0x80002014/0x80002018/0x8000201C O
pause O
/ O
resume O
0x80002020 O
getVersion O
- O
returns O
2.4.0 O
Driver O
has O
three O
logical O
parts O
, O
and O
uses O
an O
incomplete O
function O
pointer O
table O
as O
interface O
. O

The O
code O
is O
of O
very O
good O
quality O
. O

It O
looks O
more O
complicated O
than O
Winpcap O
2.3 O
( O
released O
28 O
mar O
2002 O
) O
, O
but O
less O
so O
than O
Winpcap O
3.0 O
( O
released O
by O
10 O
apr O
2003 O
) O
. O

Interestingly O
, O
the O
driver O
identifies O
itself O
as O
" O
version O
2.4 O
" O
in O
the O
pcap O
file O
despite O
there O
being O
no O
Winpcap O
version O
2.4 O
. O

Key O
/ O
clipboard O
logger O
driver O
- O
msrtvd.sys O
MD5s O
98dea1bce37bf7087360e1958400589b O
bb8f56874189d5dfe9294f0553a49b83 O
f6bf3ed3bcd466e5fd1cbaf6ba658716 O
Size O
31 O
488 O
- O
36 O
736 O
bytes O
Format O
PE32 O
Native O
Compiled O
2010.02.19 O
22:45:18 O
( O
GMT O
) O
2008.09.17 O
16:23:54 O
( O
GMT O
) O
Version O
Info O
FileDescription O
: O
MSRTvd O
interface O
driver O
LegalCopyright O
: O
Microsoft O
Corporation O
. O

All O
rights O
reserved O
. O

InternalName O
: O
msrtvd.sys O
This B-Entity
is B-Action
a O
keylogger B-Entity
and I-Entity
clipboard I-Entity
monitoring I-Entity
tool I-Entity
. O

On O
startup O
, O
the O
driver O
creates O
a O
device O
named O
" O
\Device\Gk0 O
" O
and O
a O
symbolic O
link O
named O
" O
\DosDevices\Gk O
" O
. O

Then O
it O
attaches O
to O
the O
csrss.exe O
process O
and O
disassembles O
user32.dll O
and O
ntdll.dll O
routines O
to O
obtain O
win32k.sys O
and O
ntoskrnl.exe O
SDT O
services O
indexes O
and O
pointers O
of O
needed O
Nt O
/ O
Zw O
APIs O
. O

Then O
, O
using O
a O
built O
- O
in O
disassembler O
, O
it O
obtains O
pointers O
to O
NtUserPeekMessage O
, O
NtUserGetMessage O
, O
NtUserGetClipboardData O
and O
using O
the O
disassembler O
again O
selects O
the O
parts O
of O
the O
code O
that O
will O
be O
then O
hooked O
by O
splicing O
. O

The O
interceptor O
routines O
are O
copied O
from O
a O
special O
PE O
section O
named O
" O
.msda O
" O
. O

These O
routines B-Entity
are O
able O
to O
collect B-Action
key O
press B-Entity
chains I-Entity
and O
clipboard O
text O
data O
, O
add O
information O
about O
current O
Time O
, O
ProcessName O
, O
ForegroundWindowText O
, O
and O
UserName O
related O
to O
this O
event O
. O

A O
dedicated B-Entity
thread I-Entity
( O
" O
dumper O
" O
) O
gathers B-Action
the O
collected B-Entity
data I-Entity
, O
compresses B-Action
the O
results B-Entity
with B-Modifier
LZO B-Entity
appends O
it O
every O
30 O
minutes O
to O
a O
file O
" O
% O
system O
- O
wide O
TEMP%\tm154o.da O
" O
. O

Most O
strings B-Entity
inside I-Entity
are O
encrypted B-Action
by B-Modifier
XOR O
with B-Entity
a I-Entity
pre I-Entity
- I-Entity
seeded I-Entity
random I-Entity
number I-Entity
generator I-Entity
. O

IOCTLs O
: O
0x22002C O
-start O
dumper O
thread O
0x220030 O
- O
stop O
dumper O
thread O
0x220034 O
- O
check O
if O
the O
driver O
has O
new O
data O
to O
dump O
0x220038 O
- O
set O
two O
external O
events O
signaled O
on O
dump O
data O
availability O
( O
it O
references O
a O
plugin O
possibility O
) O
0x22003C O
- O
restart O
dumper O
thread O
0x220040 O
- O
get O
size O
of O
available O
data O
Collector O
plugin O
for O
Volrec O
- O
msrstd.sys O
MD5s O
69e7943f3d48233de4a39a924c59ed2c O
15d39578460e878dd89e8911180494ff O
Size O
13 O
696 O
- O
17 O
408 O
bytes O
Format O
PE32 O
Native O
Compiled O
2009.06.05 O
16:21:55 O
( O
GMT O
) O
2009.12.15 O
16:33:52 O
( O
GMT O
) O
Version O
Info O
FileDescription O
: O
msrstd O
driver O
LegalCopyright O
: O
Microsoft O
Corporation O
. O

All O
rights O
reserved O
. O

InternalName O
: O
msrstd.sys O
This O
driver O
is O
a O
plugin O
that O
collects O
events O
from O
the O
" O
volrec.sys O
" O
driver O
, O
and O
delivers O
them O
by O
sending O
DeviceIoControl O
messages O
. O

It O
collects O
events O
about O
file O
and O
disk O
volume O
operations O
. O

On O
startup O
the O
driver O
obtains O
a O
pointer O
to O
" O
\Device\volrec O
" O
, O
then O
creates O
a O
control O
device O
" O
\Device O
\msrstd0 O
" O
and O
a O
symbolic O
link O
to O
it O
named O
" O
\DosDevices\msrstd O
" O
All O
strings O
inside O
the O
driver O
are O
encrypted O
by O
XOR O
with O
a O
pre O
- O
seeded O
random O
number O
generator O
. O

For O
file O
events O
the O
driver O
collects O
the O
filenames O
, O
and O
caches O
data O
about O
read O
and O
write O
operations O
. O

For O
disk O
volume O
events O
it O
queries O
disk O
properties O
and O
reads O
volume O
labels O
and O
disk O
serial O
numbers O
of O
removable O
drives O
( O
USB O
, O
FireWire O
drives O
) O
. O

IOCTLs O
. O

0x220004 O
- O
turn O
on O
VolumeEvents O
collection O
0x220008 O
- O
turn O
off O
VolumeEvents O
collection O
0x22000C O
- O
retrieve O
previously O
stored O
VolumeEvent O
( O
operationType O
, O
deviceTypeFlags O
, O
VolumeLabel O
, O
volumeSerialNumber O
, O
DosDriveLetter O
) O
0x220010 O
- O
turn O
on O
FileEvents O
collection O
0x220014 O
- O
turn O
off O
FileEvents O
collection O
0x220018 O
- O
retrieve O
previously O
stored O
FileEvent O
( O
fileName O
, O
deviceTypeFlags O
, O
VolumeLabel O
, O
volumeSerialNumber O
, O
DosDriveLetter O
) O
0x22001C O
- O
connect O
to O
Volrec.sys O
( O
send O
ioctl O
0x220004 O
) O
, O
enable O
plugin O
operation O
0x220020 O
- O
disconnect O
from O
Volrec.sys O
( O
send O
ioctl O
0x220008 O
) O
, O
disable O
plugin O
operation O
Filesystem O
filter O
driver O
â€“ O
volrec.sys O
, O
scsi2mgr.sys O
MD5s O
a6662b8ebca61ca09ce89e1e4f43665d O
c17e16a54916d3838f63d208ebab9879 O
Size O
14 O
464 O
- O
14 O
848 O
byres O
Format O
PE32 O
Native O
Compiled O
2009.06.05 O
16:21:57 O
( O
GMT O
) O
2009.12.15 O
16:33:57 O
( O
GMT O
) O
Version O
Info O
FileDescription O
: O
Volume O
recognizer O
driver O
LegalCopyright O
: O
Microsoft O
Corporation O
. O

All O
rights O
reserved O
. O

InternalName O
: O
volrec.sys O
This O
driver O
is O
a O
generic O
filesystem O
filter O
which O
feeds O
system O
events O
to O
user O
- O
mode O
plugins O
. O

On O
startup O
the O
driver O
creates O
a O
control O
device O
named O
" O
\Device\volrec O
" O
and O
a O
symbolic O
link O
to O
it O
named O
" O
\DosDevices\volrec0 O
" O
. O

It O
then O
attaches O
all O
available O
filesystem O
devices O
. O

It O
is O
also O
, O
able O
to O
handle O
removable O
storage O
devices O
. O

All O
strings O
inside O
the O
driver O
are O
encrypted O
by O
XOR O
with O
a O
pre O
- O
seeded O
random O
number O
generator O
. O

IOCTLs O
: O
0x220004 O
- O
setup O
plugin O
interface O
0x220008 O
- O
disable O
plugin O
calls O
The O
driver O
handles O
the O
following O
system O
events O
: O
file O
opened O
, O
created O
or O
closed O
data O
is O
read O
or O
written O
to O
a O
file O
new O
volume O
is O
mounted O
, O
unmounted O
new O
USB O
or O
FireWire O
device O
attached O
HDD O
/ O
SSD O
operation O
helper O
driver O
- O
WIN32M.SYS O
MD5s O
2b444ac5209a8b4140dd6b747a996653 O
b3487fdd1efd2d1ea1550fef5b749037 O
Size O
19 O
456 O
- O
26 O
631 O
bytes O
Format O
PE32 O
Native O
, O
PE32 O
+ O
Native O
Compiled O
2001.08.23 O
17:03:19 O
( O
GMT O
) O
2013.05.14 O
15:58:36 O
( O
GMT O
) O
Description O
This O
module O
will O
be O
the O
subject O
of O
a O
dedicated O
blogpost O
. O

HDD O
/ O
SSD O
firmware O
operation O
- O
nls_933w.dll O
MD5s O
11fb08b9126cdb4668b3f5135cf7a6c5 O
9f3f6f46c67d3fad2479963361cf118b O
Size O
212 O
480 O
- O
310 O
272 O
bytes O
Format O
PE32 O
DLL O
, O
PE32 O
+ O
DLL O
Compiled O
2010.06.15 O
16:23:37 O
( O
GMT O
) O
2013.05.14 O
16:12:35 O
( O
GMT O
) O
Version O
Info O
FileDescription O
: O
Windows O
Networking O
Library O
( O
64bit O
dll O
only O
) O
LegalCopyright O
: O
Copyright O
( O
C O
) O
Microsoft O
Corp. O

1981 O
- O
2001 O
FileVersion O
: O
80AA O
InternalName O
: O
nls_933w.dll O
OriginalFilename O
: O
nls_933w.dll O
PrivateBuild O
: O
4.0.1.0 O
ProductName O
: O
Microsoft(R O
) O
Windows O
( O
R O
) O
2000 O
Operating O
System O
ProductVersion O
: O
5.0.2074.0 O
Full O
Version O
: O
1.0.0.1 O
Description O
This O
( O
80AA O
) O
plugin O
is O
a O
HDD O
firmware O
fiashing O
tool O
which O
includes O
an O
API O
and O
the O
ability O
to O
read O
/ O
write O
arbitrary O
information O
into O
hidden O
sectors O
on O
the O
disk O
. O

The O
plugin O
will O
be O
the O
subject O
of O
a O
separate O
blogpost O
. O

